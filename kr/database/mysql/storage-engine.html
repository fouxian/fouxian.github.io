<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>架构、存储引擎、事务、索引 | Keep Running</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/favicon.png">
    <script charset="utf-8" async="async" src="/js/jquery.min.js"></script>
    <script charset="utf-8" async="async" src="/js/global.js"></script>
    <script charset="utf-8" async="async" src="/js/fingerprint2.min.js"></script>
    <meta name="description" content="">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <link rel="preload" href="/assets/css/0.styles.42b858ce.css" as="style"><link rel="preload" href="/assets/js/app.cfd60917.js" as="script"><link rel="preload" href="/assets/js/4.8234885e.js" as="script"><link rel="preload" href="/assets/js/3.1429892b.js" as="script"><link rel="preload" href="/assets/js/40.1689d33f.js" as="script"><link rel="prefetch" href="/assets/js/10.0f0de338.js"><link rel="prefetch" href="/assets/js/11.0c47d372.js"><link rel="prefetch" href="/assets/js/12.b45ce082.js"><link rel="prefetch" href="/assets/js/13.f2032214.js"><link rel="prefetch" href="/assets/js/14.0a8927b2.js"><link rel="prefetch" href="/assets/js/15.9ab1d206.js"><link rel="prefetch" href="/assets/js/16.f03f2e40.js"><link rel="prefetch" href="/assets/js/17.c6bbe2be.js"><link rel="prefetch" href="/assets/js/18.e08bb862.js"><link rel="prefetch" href="/assets/js/19.c00af7cb.js"><link rel="prefetch" href="/assets/js/20.35396483.js"><link rel="prefetch" href="/assets/js/21.fe05d239.js"><link rel="prefetch" href="/assets/js/22.80eaa289.js"><link rel="prefetch" href="/assets/js/23.bce5e854.js"><link rel="prefetch" href="/assets/js/24.fa104861.js"><link rel="prefetch" href="/assets/js/25.2c725be9.js"><link rel="prefetch" href="/assets/js/26.fc7addb7.js"><link rel="prefetch" href="/assets/js/27.fc831a66.js"><link rel="prefetch" href="/assets/js/28.3784f580.js"><link rel="prefetch" href="/assets/js/29.7e78aa5c.js"><link rel="prefetch" href="/assets/js/30.b074fddd.js"><link rel="prefetch" href="/assets/js/31.059ebf27.js"><link rel="prefetch" href="/assets/js/32.12570018.js"><link rel="prefetch" href="/assets/js/33.d0dc971f.js"><link rel="prefetch" href="/assets/js/34.c9b46696.js"><link rel="prefetch" href="/assets/js/35.77a81c6a.js"><link rel="prefetch" href="/assets/js/36.6048e328.js"><link rel="prefetch" href="/assets/js/37.b9f285de.js"><link rel="prefetch" href="/assets/js/38.ac5a2abf.js"><link rel="prefetch" href="/assets/js/39.97ca52cb.js"><link rel="prefetch" href="/assets/js/41.4d2d8182.js"><link rel="prefetch" href="/assets/js/42.8647a8ff.js"><link rel="prefetch" href="/assets/js/43.f867a280.js"><link rel="prefetch" href="/assets/js/44.a51272ee.js"><link rel="prefetch" href="/assets/js/45.c31e6474.js"><link rel="prefetch" href="/assets/js/46.fe85ae54.js"><link rel="prefetch" href="/assets/js/47.dc8a97d4.js"><link rel="prefetch" href="/assets/js/48.c97f7726.js"><link rel="prefetch" href="/assets/js/49.ac219d14.js"><link rel="prefetch" href="/assets/js/5.963fada3.js"><link rel="prefetch" href="/assets/js/50.926ecfa5.js"><link rel="prefetch" href="/assets/js/51.e776b5b1.js"><link rel="prefetch" href="/assets/js/52.4938314c.js"><link rel="prefetch" href="/assets/js/53.6b4d7266.js"><link rel="prefetch" href="/assets/js/54.bfaf622b.js"><link rel="prefetch" href="/assets/js/55.c6d160b9.js"><link rel="prefetch" href="/assets/js/56.31f6843c.js"><link rel="prefetch" href="/assets/js/57.55cbf7b8.js"><link rel="prefetch" href="/assets/js/58.8174871d.js"><link rel="prefetch" href="/assets/js/59.3eee2bde.js"><link rel="prefetch" href="/assets/js/6.b2e36a75.js"><link rel="prefetch" href="/assets/js/60.233a32ed.js"><link rel="prefetch" href="/assets/js/61.defb83ac.js"><link rel="prefetch" href="/assets/js/62.442070cd.js"><link rel="prefetch" href="/assets/js/63.cc121456.js"><link rel="prefetch" href="/assets/js/64.c8f83f5d.js"><link rel="prefetch" href="/assets/js/65.b9bc8c1c.js"><link rel="prefetch" href="/assets/js/7.fb6689bf.js"><link rel="prefetch" href="/assets/js/8.e390cc6b.js"><link rel="prefetch" href="/assets/js/9.c03c9dfe.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.db8a86c9.js">
    <link rel="stylesheet" href="/assets/css/0.styles.42b858ce.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Keep Running</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/kr/java/jvm/自动内存管理.html" class="nav-link">
  Java
</a></div><div class="nav-item"><a href="/kr/database/database.html" class="nav-link">
  数据库
</a></div><div class="nav-item"><a href="/kr/spring/MVC-IOC-AOP.html" class="nav-link">
  Spring
</a></div><div class="nav-item"><a href="/kr/middleware/redis/redis-base.html" class="nav-link">
  Redis/Zookeeper/Kafka
</a></div><div class="nav-item"><a href="/kr/bigdata/hadoop/Hadoop-分布式集群容器部署.html" class="nav-link">
  大数据
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/kr/java/jvm/自动内存管理.html" class="nav-link">
  Java
</a></div><div class="nav-item"><a href="/kr/database/database.html" class="nav-link">
  数据库
</a></div><div class="nav-item"><a href="/kr/spring/MVC-IOC-AOP.html" class="nav-link">
  Spring
</a></div><div class="nav-item"><a href="/kr/middleware/redis/redis-base.html" class="nav-link">
  Redis/Zookeeper/Kafka
</a></div><div class="nav-item"><a href="/kr/bigdata/hadoop/Hadoop-分布式集群容器部署.html" class="nav-link">
  大数据
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/kr/database/database.html" class="sidebar-link">数据库</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>MySQL</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/kr/database/mysql/storage-engine.html" aria-current="page" class="active sidebar-link">架构、存储引擎、事务、索引</a></li><li><a href="/kr/database/mysql/mysql-explain.html" class="sidebar-link">MySQL 执行计划</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>MyBatis</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/kr/database/mybatis/MyBatis-核心源码解析.html" class="sidebar-link">MyBatis 核心源码解析 (3.5.5)</a></li><li><a href="/kr/database/mybatis/mybatis.html" class="sidebar-link">MyBatis</a></li></ul></section></li></ul> </aside> <div><main class="page"> <div class="theme-default-content content__default"><h1 id="架构、存储引擎、事务、索引"><a href="#架构、存储引擎、事务、索引" class="header-anchor">#</a> 架构、存储引擎、事务、索引</h1> <h2 id="mysql-架构"><a href="#mysql-架构" class="header-anchor">#</a> MySQL 架构</h2> <p><img src="/images/kr/database/mysql/MySQL-%E4%BD%93%E7%B3%BB%E6%9E%B6%E6%9E%84.png" alt="MySQL-体系架构"></p> <ul><li>连接层：主要通过连接器建立客户端连接，授权认证等</li> <li>服务层
<ul><li>缓存（MySQL 8.0 版本后移除）：缓存查询的数据</li> <li>分析器：词法分析/语法分析</li> <li>优化器：生成执行计划，逻辑优化处理</li> <li>执行器：通过存储引擎处理数据</li></ul></li> <li>存储引擎：负责数据的存储和提取，服务器通过 API 与存储引擎进行通信</li></ul> <h2 id="sql-执行过程"><a href="#sql-执行过程" class="header-anchor">#</a> SQL 执行过程</h2> <p><img src="/images/kr/database/mysql/MySQL-SQL-%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B.webp" alt="MySQL-SQL-执行过程"></p> <p>注：在更新表的时候会清空缓存</p> <h2 id="myisam-innodb-区别"><a href="#myisam-innodb-区别" class="header-anchor">#</a> MyISAM/InnoDB 区别</h2> <ol><li>MyISAM 不支持事务，InnoDB 支持事务</li> <li>MyISAM 不支持外键，InnoDB 支持外键</li></ol> <blockquote><p>一般不建议在数据库层面使用外键，应用层面可以解决，但对数据的一致性造成影响</p></blockquote> <ol start="3"><li>MyISAM 只有表级锁，不适用于高并发，InnoDB 支持行级锁和表级锁，默认行级锁，适用于高并发</li> <li>MyISAM 只缓存索引，不缓存数据，InnoDB 缓存索引和数据</li> <li>MyISAM 是非聚集索引，InnoDB 是聚集索引</li> <li>MyISAM 用一个变量保存了表的行数，InnoDB 不保存表的函数，<code>count(*)</code>会全表扫描</li> <li>MyISAM 不支持数据库崩溃后的安全恢复，而 InnoDB 支持</li></ol> <h2 id="myisam"><a href="#myisam" class="header-anchor">#</a> MyISAM</h2> <p>每个 MyISAM 表存储在磁盘中三个文件（表名命名）：</p> <ul><li>.frm：文件存储表的格式</li> <li>.myd：文件存储表的数据</li> <li>.myi：文件存储表的索引</li></ul> <h2 id="innodb"><a href="#innodb" class="header-anchor">#</a> InnoDB</h2> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>mysql<span class="token operator">&gt;</span> show engines<span class="token punctuation">;</span>
+--------------------+---------+----------------------------------------------------------------+--------------+------+------------+
<span class="token operator">|</span> Engine             <span class="token operator">|</span> Support <span class="token operator">|</span> Comment                                                        <span class="token operator">|</span> Transactions <span class="token operator">|</span> XA   <span class="token operator">|</span> Savepoints <span class="token operator">|</span>
+--------------------+---------+----------------------------------------------------------------+--------------+------+------------+
<span class="token operator">|</span> MEMORY             <span class="token operator">|</span> YES     <span class="token operator">|</span> Hash based, stored <span class="token keyword">in</span> memory, useful <span class="token keyword">for</span> temporary tables      <span class="token operator">|</span> NO           <span class="token operator">|</span> NO   <span class="token operator">|</span> NO         <span class="token operator">|</span>
<span class="token operator">|</span> MRG_MYISAM         <span class="token operator">|</span> YES     <span class="token operator">|</span> Collection of identical MyISAM tables                          <span class="token operator">|</span> NO           <span class="token operator">|</span> NO   <span class="token operator">|</span> NO         <span class="token operator">|</span>
<span class="token operator">|</span> CSV                <span class="token operator">|</span> YES     <span class="token operator">|</span> CSV storage engine                                             <span class="token operator">|</span> NO           <span class="token operator">|</span> NO   <span class="token operator">|</span> NO         <span class="token operator">|</span>
<span class="token operator">|</span> FEDERATED          <span class="token operator">|</span> NO      <span class="token operator">|</span> Federated MySQL storage engine                                 <span class="token operator">|</span> NULL         <span class="token operator">|</span> NULL <span class="token operator">|</span> NULL       <span class="token operator">|</span>
<span class="token operator">|</span> PERFORMANCE_SCHEMA <span class="token operator">|</span> YES     <span class="token operator">|</span> Performance Schema                                             <span class="token operator">|</span> NO           <span class="token operator">|</span> NO   <span class="token operator">|</span> NO         <span class="token operator">|</span>
<span class="token operator">|</span> MyISAM             <span class="token operator">|</span> YES     <span class="token operator">|</span> MyISAM storage engine                                          <span class="token operator">|</span> NO           <span class="token operator">|</span> NO   <span class="token operator">|</span> NO         <span class="token operator">|</span>
<span class="token operator">|</span> InnoDB             <span class="token operator">|</span> DEFAULT <span class="token operator">|</span> Supports transactions, row-level locking, and foreign keys     <span class="token operator">|</span> YES          <span class="token operator">|</span> YES  <span class="token operator">|</span> YES        <span class="token operator">|</span>
<span class="token operator">|</span> BLACKHOLE          <span class="token operator">|</span> YES     <span class="token operator">|</span> /dev/null storage engine <span class="token punctuation">(</span>anything you <span class="token function">write</span> to it disappears<span class="token punctuation">)</span> <span class="token operator">|</span> NO           <span class="token operator">|</span> NO   <span class="token operator">|</span> NO         <span class="token operator">|</span>
<span class="token operator">|</span> ARCHIVE            <span class="token operator">|</span> YES     <span class="token operator">|</span> Archive storage engine                                         <span class="token operator">|</span> NO           <span class="token operator">|</span> NO   <span class="token operator">|</span> NO         <span class="token operator">|</span>
+--------------------+---------+----------------------------------------------------------------+--------------+------+------------+
mysql<span class="token operator">&gt;</span> show variables like <span class="token string">'%storage_engine%'</span><span class="token punctuation">;</span>
+---------------------------------+-----------+
<span class="token operator">|</span> Variable_name                   <span class="token operator">|</span> Value     <span class="token operator">|</span>
+---------------------------------+-----------+
<span class="token operator">|</span> default_storage_engine          <span class="token operator">|</span> InnoDB    <span class="token operator">|</span>
<span class="token operator">|</span> default_tmp_storage_engine      <span class="token operator">|</span> InnoDB    <span class="token operator">|</span>
<span class="token operator">|</span> disabled_storage_engines        <span class="token operator">|</span>           <span class="token operator">|</span>
<span class="token operator">|</span> internal_tmp_mem_storage_engine <span class="token operator">|</span> TempTable <span class="token operator">|</span>
+---------------------------------+-----------+
<span class="token comment"># 查看某库某表的状态信息</span>
mysql<span class="token operator">&gt;</span> show table status from dmc_dw where name <span class="token operator">=</span> <span class="token string">'user_info'</span><span class="token punctuation">\</span>G<span class="token punctuation">;</span>
*************************** <span class="token number">1</span>. row ***************************
           Name: user_info
         Engine: InnoDB
        Version: <span class="token number">10</span>
     Row_format: Dynamic
           Rows: <span class="token number">800</span>
 Avg_row_length: <span class="token number">143</span>
    Data_length: <span class="token number">114688</span>
Max_data_length: <span class="token number">0</span>
   Index_length: <span class="token number">0</span>
      Data_free: <span class="token number">0</span>
 Auto_increment: <span class="token number">801</span>
    Create_time: <span class="token number">2021</span>-09-26 <span class="token number">17</span>:35:44
    Update_time: NULL
     Check_time: NULL
      Collation: utf8_general_ci
       Checksum: NULL
 Create_options: <span class="token assign-left variable">row_format</span><span class="token operator">=</span>DYNAMIC
        Comment:
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><p>MySQL 5.5 之前，MyISAM 引擎是 MySQL 的默认存储引擎</p> <p>MySQL 5.5 之后，InnoDB 引擎是 MySQL 的默认存储引擎</p> <h3 id="体系架构"><a href="#体系架构" class="header-anchor">#</a> 体系架构</h3> <p><img src="/images/kr/database/mysql/InnoDB-%E4%BD%93%E7%B3%BB%E6%9E%B6%E6%9E%84.png" alt="InnoDB 体系架构"> <img src="/images/kr/database/mysql/InnoDB.webp" alt="InnoDB 体系架构"></p> <h3 id="逻辑存储"><a href="#逻辑存储" class="header-anchor">#</a> 逻辑存储</h3> <p><img src="/images/kr/database/mysql/InnoDB-%E9%80%BB%E8%BE%91%E5%AD%98%E5%82%A8.png" alt="InnoDB 逻辑存储">
表数据和索引存储于表空间中，表空间是存储引擎中最高的存储逻辑单位，在表空间中又包括段、区、页、行。表的存储文件：</p> <ul><li>.frm：存储表的结构定义，所有的存储引擎都使用该文件存储表的结构定义</li> <li>.idb：存储表的数据索引
<ul><li>共享表空间：系统表空间，存储了系统信息和所有库表和索引</li> <li>独占表空间：表的独占表空间，存储了当前表的数据和索引</li></ul></li></ul> <h2 id="事务"><a href="#事务" class="header-anchor">#</a> 事务</h2> <blockquote><p>MySQL 事务也是在存储引擎层面实现的，InnoDB 支持事务，而 MyISAM 不支持事务</p></blockquote> <p>事务（数据库事务）定义：一个有限的数据库操作序列构成，是一个不可分割的工作单位</p> <blockquote><p>MySQL 默认对每一个新建立的连接都启用了 autocommit 模式，在该模式下，每一个发送到 MySQL 服务器的 SQL 语句都会在一个单独的事务中进行处理，执行结束后会自动提交事务，并开启一个新的事务</p></blockquote> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">START</span> <span class="token keyword">TRANSACTION</span> <span class="token operator">|</span> <span class="token keyword">BEGIN</span> <span class="token punctuation">[</span><span class="token keyword">WORK</span><span class="token punctuation">]</span> 				<span class="token comment"># 开启事务</span>
<span class="token comment"># CHAIN、RELEASE：定义事务提交或回滚之后的操作</span>
<span class="token comment"># CHAIN 会立即启动一个具有相同隔离级别的新事务</span>
<span class="token comment"># RELEASE 会断开与客户端的连接</span>
<span class="token keyword">COMMIT</span> <span class="token punctuation">[</span><span class="token keyword">WORK</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">AND</span> <span class="token punctuation">[</span><span class="token keyword">NO</span><span class="token punctuation">]</span> <span class="token keyword">CHAIN</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token keyword">NO</span><span class="token punctuation">]</span> <span class="token keyword">RELEASE</span><span class="token punctuation">]</span> 	<span class="token comment"># 提交事务</span>
<span class="token keyword">ROLLBACK</span> <span class="token punctuation">[</span><span class="token keyword">WORK</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">AND</span> <span class="token punctuation">[</span><span class="token keyword">NO</span><span class="token punctuation">]</span> <span class="token keyword">CHAIN</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token keyword">NO</span><span class="token punctuation">]</span> <span class="token keyword">RELEASE</span><span class="token punctuation">]</span> <span class="token comment"># 回滚事务</span>
<span class="token keyword">SET</span> AUTOCOMMIT <span class="token operator">=</span> {<span class="token number">0</span> <span class="token operator">|</span> <span class="token number">1</span>}	<span class="token comment"># 是否自动提交事务，MySQL 默认自动提交事务</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>隐式锁定：InnoDB 事务执行过程中，使用两阶段锁协议：</p> <ul><li>随时都可以执行锁定，InnoDB 会根据隔离级别在需要的时候自动加锁</li> <li>锁只有在提交或回滚时才会释放，并且所有的锁都是在同一时刻被释放</li></ul> <p>显式锁定：InnoDB 也支持通过特定的语句进行显示锁定</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">lock</span> <span class="token operator">in</span> <span class="token keyword">share</span> <span class="token keyword">mode</span> 	<span class="token comment"># 共享锁 </span>
<span class="token keyword">select</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">for</span> <span class="token keyword">update</span> 			<span class="token comment"># 排他锁 </span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><img src="/images/kr/database/mysql/ACID.png" alt="事务-ACID"> <img src="/images/kr/database/mysql/%E4%BA%8B%E5%8A%A1%E5%88%86%E7%B1%BB.png" alt="事务分类"></p> <h3 id="事务原理"><a href="#事务原理" class="header-anchor">#</a> 事务原理</h3> <ol><li>InnoDB 使用 <code>redo log</code>（重做日志）保证事务的持久性，使用 <code>undo log</code>（回滚日志）来保证事务的原子性</li> <li>InnoDB 通过<code>锁机制</code>、<code>MVCC</code>等手段来保证事务的隔离</li> <li>保证了事务的持久性、原子性、隔离性之后，一致性才能得到保障</li></ol> <blockquote><p>在数据库系统中，事务的原子性和持久性是由事务日志保证，包含重做日志和回滚日志，回滚日志用于对事务的影响进行撤销，重做日志是在错误处理时对已经提交的事务进行重做，事务日志能保证两点：</p> <ul><li>发生错误或者需要回滚的事务能够成功回滚（原子性）</li> <li>在事务提交后，数据没来得及写会磁盘就宕机时，在下次重新启动后能够成功恢复数据（持久性）</li></ul></blockquote> <h3 id="隔离性"><a href="#隔离性" class="header-anchor">#</a> 隔离性</h3> <p><img src="/images/kr/database/mysql/%E5%B9%B6%E5%8F%91%E4%BA%8B%E5%8A%A1%E9%97%AE%E9%A2%98.png" alt="并发事务问题">
针对并发事务存在的数据库读一致性（脏读，不可重复读，幻读）问题，需要进行事务间的隔离，SQL 标准定义了四个隔离级别（由低到高）：</p> <p><img src="/images/kr/database/mysql/%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB.png" alt="事务隔离级别"></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>mysql<span class="token operator">&gt;</span> SELECT @@transaction_isolation<span class="token punctuation">;</span>		<span class="token comment"># mysql8 查看默认隔离级别，mysql5：SELECT @@tx_isolation</span>
+-------------------------+
<span class="token operator">|</span> @@transaction_isolation <span class="token operator">|</span>
+-------------------------+
<span class="token operator">|</span> REPEATABLE-READ         <span class="token operator">|</span>
+-------------------------+
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><blockquote><p>事务隔离级别和数据访问的并发性是对立的，事务隔离级别越高并发性就越差</p> <p>InnoDB 默认可重复读并不能保证避免幻读，因此通过使用行锁算法<code>Next-Key Locks</code>来保证</p> <p>Serializable 会在读取的每一行数据上都加锁，可能导致大量的超时和锁竞争问题，这种事务隔离级别效率低下，比较耗数据库性能，一般不使用</p> <p>InnoDB 支持 XA 事务，并通过 XA 事务来实现分布式事务。分布式事务指允许多个独立的事务资源参与到一个全局事务中。在使用分布式事务时，InnoDB 事务隔离级别必须设置为 SERIALIZABLE 串行化</p></blockquote> <h3 id="锁"><a href="#锁" class="header-anchor">#</a> 锁</h3> <p><img src="/images/kr/database/mysql/%E4%BA%8B%E5%8A%A1-%E9%94%81.png" alt="事务-锁"></p> <blockquote><ul><li>读锁（共享锁）：针对同一份数据，多个读操作可以同时进行，不会互相影响</li> <li>写锁（排他锁）：当前写操作没有完成前，会阻断其他写锁和读锁</li></ul> <p>锁粒度：在高并发响应和系统性能两方面进行平衡</p> <ul><li>全局锁：对整个数据库实例加锁，可以用<code>Flush tables with read lock (FTWRL)</code>设置为只读，相当于加全局锁</li> <li>表级锁：锁定粒度最大的一种锁，对当前表加锁；锁冲突概率高，并发度低，加锁快，不会死锁</li> <li>行级锁：锁定粒度最小的一种锁，对当前行加锁；锁冲突概率低，并发度高，加速慢，存在死锁</li></ul> <p>加锁机制：<code>乐观锁</code>与<code>悲观锁</code>是两种并发控制的思想，可用于解决<code>丢失更新</code>问题</p> <ul><li>乐观锁：假定不会发生并发更新冲突，访问处理数据过程中从不加锁，再根据版本号或时间戳判断是否有冲突，有则处理，无则提交事务</li> <li>悲观锁：假定总会发生并发更新冲突，访问处理数据过程中加排他锁，事务提交或回滚后才释放锁</li></ul></blockquote> <p>MyISAM 表锁（表共享读锁、表独占写锁），读写锁调度是写优先：</p> <ul><li>在执行查询语句前，会自动给涉及的表加读锁，在执行增删改操作前，会自动给涉及的表加写锁</li> <li>表共享读锁会阻塞写，但是不会堵塞读，而表独占写锁则会把读和写都堵塞</li> <li>也就是，MyISAM 表的读与写之间，及写之间都是串行执行的</li></ul> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">show</span> <span class="token keyword">open</span> <span class="token keyword">tables</span><span class="token punctuation">;</span>	<span class="token comment"># 查看表的加锁情况</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> <span class="token keyword">status</span> <span class="token operator">like</span> <span class="token string">'table%'</span><span class="token punctuation">;</span>		<span class="token comment"># 查看表级锁竞争情况</span>
<span class="token operator">+</span><span class="token comment">----------------------------+-------+</span>
<span class="token operator">|</span> Variable_name              <span class="token operator">|</span> <span class="token keyword">Value</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------------------------+-------+</span>
<span class="token operator">|</span> Table_locks_immediate      <span class="token operator">|</span> <span class="token number">3</span>     <span class="token operator">|</span>
<span class="token operator">|</span> Table_locks_waited         <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span>
<span class="token operator">|</span> Table_open_cache_hits      <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span>
<span class="token operator">|</span> Table_open_cache_misses    <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span>
<span class="token operator">|</span> Table_open_cache_overflows <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------------------------+-------+</span>
<span class="token comment"># Table_locks_immediate：产生表级锁定的次数，表示可以立即获取锁的查询次数，每立即获取锁值加1</span>
<span class="token comment"># Table_locks_waited：出现表级锁定竞争而发生等待的次数(不能立即获取锁的次数，每等待一次锁值加1)，此值高则说明存在着较严重的表级锁竞争情况</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>InnoDB 锁定模式：</p> <ul><li>共享锁（S），排他锁（X），意向共享锁（IS）和意向排他锁（IX）；</li> <li>如果一个事务请求的锁模式与当前的锁兼容，InnoDB 就将请求的锁授予该事务，反之，若两者不兼容，该事务就要等待锁释放</li> <li>意向锁（表级锁定）：当一个事务在需要获取锁时，若已被排他锁占用，则该事务可以再需要锁定行的表上添加一个合适的意向锁（共享锁/排他锁）</li> <li>对于 UPDATE、DELETE、INSERT，InnoDB 会自动给涉及数据集加排他锁（X)；对于普通 SELECT 语句，InnoDB 不会加任何锁</li></ul> <blockquote><p>InnoDB 行锁：通过给索引上的索引项加锁来实现，只有通过索引条件检索数据，InnoDB 才使用行级锁，否则，InnoDB 将使用表锁</p></blockquote> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> <span class="token keyword">status</span> <span class="token operator">like</span> <span class="token string">'innodb_row_lock%'</span><span class="token punctuation">;</span>		<span class="token comment"># 查看行级锁竞争情况</span>
<span class="token operator">+</span><span class="token comment">-------------------------------+-------+</span>
<span class="token operator">|</span> Variable_name                 <span class="token operator">|</span> <span class="token keyword">Value</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------------------------+-------+</span>
<span class="token operator">|</span> Innodb_row_lock_current_waits <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span>
<span class="token operator">|</span> Innodb_row_lock_time          <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span>
<span class="token operator">|</span> Innodb_row_lock_time_avg      <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span>
<span class="token operator">|</span> Innodb_row_lock_time_max      <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span>
<span class="token operator">|</span> Innodb_row_lock_waits         <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------------------------+-------+</span>
<span class="token comment"># Innodb_row_lock_current_waits：当前正在等待锁定的数量</span>
<span class="token comment"># Innodb_row_lock_time：从系统启动到现在锁定总时间长度</span>
<span class="token comment"># Innodb_row_lock_time_avg：每次等待所花平均时间</span>
<span class="token comment"># Innodb_row_lock_time_max：从系统启动到现在等待最常的一次所花的时间</span>
<span class="token comment"># Innodb_row_lock_waits：系统启动后到现在总共等待的次数</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><blockquote><p>行锁优化：</p> <ul><li>尽可能让所有数据检索都通过索引来完成，避免无索引行锁升级为表锁</li> <li>合理设计索引，尽量缩小锁的范围</li> <li>尽可能较少检索条件，避免间隙锁</li> <li>尽量控制事务大小，减少锁定资源量和时间长度</li> <li>尽可能低级别事务隔离</li></ul></blockquote> <p>读未提交：</p> <ul><li>事务读不加锁，不阻塞其他事务的读和写</li> <li>事务写阻塞其他事务写，但不阻塞其他事务读</li></ul> <p>可串行化：</p> <ul><li>所有 SELECT 语句会隐式转化为 SELECT...FOR SHARE，即加共享锁</li> <li>读加共享锁，写加排他锁，读写互斥</li> <li>如果有未提交的事务正在修改某些行，所有 select 这些行的语句都会阻塞</li></ul> <h3 id="mvcc-多版本并发控制"><a href="#mvcc-多版本并发控制" class="header-anchor">#</a> MVCC 多版本并发控制</h3> <p><img src="/images/kr/database/mysql/%E5%A4%9A%E7%89%88%E6%9C%AC%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6-MVCC.png" alt="多版本并发控制-MVCC"></p> <p>MVCC 是通过保存数据在某个时间点的快照（一致性非锁定读）来实现，分为<code>乐观并发控制</code>和<code>悲观并发控制</code>两种实现方式</p> <p>RR 和 RC 隔离级别下，MVCC 的实现差异：生成快照的时机不同：</p> <ul><li>RC：事务的每次 select 前都生成一个快照</li> <li>RR：在事务开启后，第一次 select 前生成一次快照</li></ul> <blockquote><p>在 RC 下，事务在每次查询开始时都会生成并设置新的快照，所以导致不可重复读</p> <p>在 RR 下，只会在事务开始后第一次读取数据时生成一个快照，所以实现可重复读</p></blockquote> <h3 id="解决幻读"><a href="#解决幻读" class="header-anchor">#</a> 解决幻读</h3> <p>在 RR 下通过 MVCC + Next-key Lock 来解决幻读问题：</p> <ul><li>执行普通 select，此时会以 MVCC 快照读的方式读取数据
<ul><li>在快照读情况下，RR 隔离级别只会在事务开启后的第一次查询生成快照，并使用至事务提交。</li> <li>所以在生成快照后其它事务所做的更新、插入对当前事务不可见，实现了可重复读和防止快照读下的“幻读”</li></ul></li> <li>执行 select...for update/lock in share mode、insert、update、delete 等锁定读（当前读）
<ul><li>在当前读下，读取的都是最新数据，若其它事务插入新的记录，且刚好在当前事务查询范围内，就会产生幻读</li> <li>当执行当前读时，Next-key Lock 会锁定读取到的记录，同时锁定记录的间隙，防止其它事务在查询范围内插入数据，实现当前读下的“幻读”</li></ul></li></ul> <h2 id="日志"><a href="#日志" class="header-anchor">#</a> 日志</h2> <p><img src="/images/kr/database/mysql/%E4%BA%8B%E5%8A%A1%E6%97%A5%E5%BF%97.png" alt="事务日志"></p> <h3 id="redo-log-重做日志"><a href="#redo-log-重做日志" class="header-anchor">#</a> redo log 重做日志</h3> <p><img src="/images/kr/database/mysql/%E9%87%8D%E5%81%9A%E6%97%A5%E5%BF%97.png" alt="重做日志"></p> <p>在 InnoDB 中，事务日志通过重做日志（redo log）和 InnoDB 的日志缓冲（InnoDB Log Buffer）实现。</p> <blockquote><p>预写日志：Write-Ahead Logging，WAL，事务开启时，事务中的操作都会先写入存储引擎的日志缓冲中，在事务提交之前，日志缓冲的日志都需要提前刷新（顺序追加）到重做日志文件上持久化</p></blockquote> <p>当事务提交之后，在 Buffer Pool 中映射的数据文件才会慢慢刷新到磁盘；</p> <ul><li>innodb_flush_log_at_trx_commit = 0：若 MySQL 挂了或系统宕机可能会丢失 1 秒数据</li> <li>innodb_flush_log_at_trx_commit = 1：事务提交成功，就不坏丢失数据；事务执行期间若 MySQL 挂了或系统宕机，由于事务没有提交，日志丢失也不会有损失</li> <li>innodb_flush_log_at_trx_commit = 2：若只是 MySQL 挂了不会丢失数据，但是系统宕机可能会丢失 1 秒数据</li></ul> <h3 id="undo-log-回滚日志"><a href="#undo-log-回滚日志" class="header-anchor">#</a> undo log 回滚日志</h3> <p><img src="/images/kr/database/mysql/%E5%9B%9E%E6%BB%9A%E6%97%A5%E5%BF%97.png" alt="回滚日志"></p> <blockquote><p>redo log 是恢复提交事务修改的页操作，而 undo log 是回滚行记录到特定版本</p> <p>redo log 是物理日志，记录页的物理修改操作，而 undo log 是逻辑日志，根据每行记录进行记录</p></blockquote> <h3 id="binlog-二进制日志"><a href="#binlog-二进制日志" class="header-anchor">#</a> binlog 二进制日志</h3> <blockquote><p>redo log、undo log 属于事务日志范畴，属于 InnoDB 存储引擎，而 binlog 是逻辑日志，属于 MySQL Server</p> <p>binlog 会记录所有涉及更新数据的逻辑操作，并且是顺序</p></blockquote> <p><img src="/images/kr/database/mysql/binlog.png" alt="binlog"></p> <p>binlog 三种日志格式（binlog_format）：</p> <ul><li>statement：记录的是 SQL 语句原文，可能导致数据不一致</li> <li>row：记录 SQL 语句，也包括操作的具体数据，需要更大的容量来记录，占用空间较大，恢复与同步时会更消耗 IO 资源，影响执行速度</li> <li>mixed：先判断 SQL 语句是否可能引起数据不一致，如果是，就用 row 格式，否则就用 statement 格式</li></ul> <blockquote><p>redo log 与 binlog 都能够保证数据的持久化，但 redo log 侧重故障时的数据恢复，而 binlog 侧重集群架构的数据一致性</p> <p>当 redo log 与 binlog 之间的逻辑不一致时，可能回会出现数据不一致，InnoDB 采用两阶段（<code>prepare</code>和<code>commit</code>）提交方案，将 redo log 的写入过程分为两步</p></blockquote> <h2 id="索引"><a href="#索引" class="header-anchor">#</a> 索引</h2> <p>在关系数据库中，索引（键）是一种单独的、物理的对数据库表中一列或多列的值进行排序的存储结构，它是某个表中一列或若干列值的集合和相应的指向表中物理标识这些值的数据页的逻辑指针清单</p> <blockquote><p>索引是一种对数据进行高效查找并以某种方式指向数据的独立、物理存储结构</p> <p>索引是一种用于快速查询和检索数据的满足特定查找算法的数据结构，并以某种方式指向数据，在该数据结构上可以实现高效查找算法</p> <p>常见有：哈希表、有序数组，各种搜索树等</p> <blockquote><p>注意：索引是在存储引擎层实现的，不同的存储引擎对索引的支持和实现有所差别</p></blockquote></blockquote> <p>磁盘 IO 与预读：磁盘读取数据靠的是机械运动，每次读取数据花费的时间可以分为寻道时间、旋转延迟、传输时间三个部分。计算机操作系统对磁盘 IO 做了一些优化，根据<code>局部预读性原理</code>，当计算机访问一个地址的数据时，与其相邻的数据也会很快被访问到，于是一次磁盘 IO 把当前磁盘地址的数据和相邻的数据都读取到内存缓冲区中，每一次磁盘 IO 读取的数据称为一页。</p> <blockquote><p>索引结构的选择要尽量减少磁盘 IO 次数</p></blockquote> <p>参考：<a href="https://tech.meituan.com/2014/06/30/mysql-index.html" target="_blank" rel="noopener noreferrer">MySQL索引原理及慢查询优化<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <blockquote><p>InnoDB 和 MyISAM 都使用 B+ 树作为索引结构，但实现方式有所区别</p></blockquote> <h3 id="优缺点"><a href="#优缺点" class="header-anchor">#</a> 优缺点</h3> <p><img src="/images/kr/database/mysql/%E7%B4%A2%E5%BC%95%E4%BC%98%E7%BC%BA%E7%82%B9.png" alt="索引优缺点"></p> <h3 id="分类"><a href="#分类" class="header-anchor">#</a> 分类</h3> <p>逻辑划分：</p> <ul><li>主键索引：唯一非空索引，不允许空值</li> <li>普通索引/单例索引/辅助索引：只包含单个数据列</li> <li>多列索引/复合索引/联合索引：基于多个数据列的索引，只有使用该索引的第一个数据列，索引才生效</li> <li>唯一索引/非唯一索引：允许空值</li> <li>Full-Text 全文索引：查找的是文本中的关键词，而不是直接比较索引中的值</li> <li>空间索引：对空间数据类型的字段建立的索引</li></ul> <p>索引结构划分：Hash 索引、B+ 树索引</p> <p>物理存储划分：聚集索引、非聚集索引（区别：索引和数据是否一起存储）</p> <h3 id="索引结构-hash-索引"><a href="#索引结构-hash-索引" class="header-anchor">#</a> 索引结构-Hash 索引</h3> <p>Hash 索引采用哈希表设计，通过哈希算法/散列算法计算 key 的哈希值并与表长取余得到索引位置，可快速查找到对应的 value，且可采用<code>链地址法</code>解决哈希冲突</p> <blockquote><p>为了减少哈希冲突的发生，一个优秀的哈希算法应该“均匀地”将数据分布在整个可能的哈希值集合中</p></blockquote> <p>MySQL 没有使用 Hash 索引（Hash 索引不适用）：</p> <ul><li>Hash 索引存在哈希冲突</li> <li>Hash 索引不支持顺序和范围查找（无法对范围内的全部数据进行哈希定位计算）</li></ul> <p><a href="https://www.cs.usfca.edu/~galles/visualization/Algorithms.html" target="_blank" rel="noopener noreferrer">数据结构可视化网站<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="索引结构-b-树索引"><a href="#索引结构-b-树索引" class="header-anchor">#</a> 索引结构-B+ 树索引</h3> <blockquote><p>B-Tree 和 B+Tree 都是为磁盘等外存储设备设计的一种平衡查找树，磁盘 IO 次数取决于树的高度</p></blockquote> <blockquote><p>B 树：</p> <ul><li>定义数据记录为 [key, data]，key 为记录键值，data 为除键值外的记录数据</li> <li>每个节点都存储键值数据，叶子节点之间无指针连接</li> <li>每个节点中的 key 从左到右非递减排列，key 和指针互相间隔，节点两端是指针</li> <li>相比二叉搜索树，对于相同数据量，B 树的高度比二叉树小，磁盘 IO 次数小，因此搜索速度快</li></ul></blockquote> <blockquote><p>B+ 树：</p> <ul><li>由 B 树和索引顺序访问方法(ISAM)演化而来，为磁盘或其它直接存取辅助设备设计的一种平衡查找树</li> <li>所有数据记录节点都是按键值的大小顺序存放在同一层的叶子节点上，由各叶子节点指针进行连接</li> <li>非叶子节点上只存储 key 值信息，大大加大每个节点存储的 key 值数量，降低 B+Tree 的高度</li> <li>性能分析：将一个节点的大小设为一个页，这样每个节点只需要一次I/O就可以完全载入，根据 B+ 树定义，可知检索一次最多需要访问 h(高度) 个节点</li> <li>范围查询：B+Tree 可以对 &lt;，&lt;=，=，&gt;，&gt;=，BETWEEN，IN，以及不以通配符开始的 LIKE 使用索引，该做法同时也违反了最左前缀原则，导致范围查询后的条件无法用到联合索引</li></ul> <p>B+ 树与 B 树的不同点：</p> <ul><li>B+ 树非叶子节点不存储 data，只存储 key，叶子节点存储 key、data，不存储指针</li> <li>顺序访问指针：叶子节点指向相邻叶子节点的指针；顺着叶子节点和指针顺序遍历就可提高区间查询效率</li></ul></blockquote> <blockquote><p>为什么使用 B+ 树，而不是 B 树？</p> <ul><li>磁盘 IO：B 树每个节点都存储键值数据，而 B+ 树只有叶子节点才存储数据，在相同数据量情况下，B 树的高度更高，IO 更频繁</li> <li>索引加载：索引是存储在磁盘文件中，数据量大时，只能逐一加载磁盘页（索引树节点），而 B+ 树的叶子节点中是双向链表，且在链表的头结点和尾节点也是循环指向的</li></ul></blockquote> <p>树高度决定磁盘 IO 次数：</p> <ul><li>若表数据量为 N，每个磁盘块（可设置为页的大小，即一页）的数据项的数量是 m，则有 <code>h=㏒(m+1)N</code></li> <li>当 N 一定时，m 越大，h 越小；而 m = 磁盘块的大小 / 数据项的大小</li> <li>如果数据项占的空间越小，数据项的数量越多，树的高度越低</li> <li>所以在设计索引时，每个数据项即索引字段要尽量的小</li> <li>这也是为什么 B+ 树把数据放到叶子节点而不是非叶子节点，一旦放到非叶子节点，磁盘块的数据项会大幅度下降，导致树增高，当数据项等于 1 时将会退化成线性表</li></ul> <h3 id="myisam-非聚集索引"><a href="#myisam-非聚集索引" class="header-anchor">#</a> MyISAM 非聚集索引</h3> <p>MyISAM 的索引文件和数据文件是分离（称为非聚集索引），MyISAM 索引结构的叶子节点的数据域，存放的并不是实际的数据记录，而是数据记录的地址。</p> <p>MyISAM 不管是主键索引还是普通索引，都是非聚集索引，通过索引查找数据的流程：先从索引文件中查找到索引节点，拿到数据的地址指针，再到数据文件中通过地址指针定位到具体的数据。</p> <h3 id="innodb-聚集索引"><a href="#innodb-聚集索引" class="header-anchor">#</a> InnoDB 聚集索引</h3> <p><img src="/images/kr/database/mysql/B+Tree-%E7%B4%A2%E5%BC%95.png" alt="B+Tree-索引"></p> <p>InnoDB 索引叶子节点的数据域，存放的是完整的数据记录，也即 InnoDB 的数据文件本身就是按照主键建立的主键索引文件，称为聚集索引，一个表只能有一个聚集索引（主键索引）。</p> <p>InnoDB 聚集索引的索引和数据都存储在一个 <code>.idb</code>文件中，非叶子节点存储索引段，叶子节点存储索引和索引对应的顺序排序的数据段。</p> <p>回表查询：对于辅助索引，需要检索辅助索引的叶子节点获取对应的主键，再到主键索引检索数据。</p> <blockquote><p>InnoDB 表必须要有主键，并且推荐使用整型自增主键，在设计表时，没有显示指定主键，InnoDB 会自动检查表中是否有唯一非空数据列，若有，则选择该列为默认的主键，否则 InnoDB 将会自动创建一个 6Byte 的自增整型主键。</p></blockquote> <h3 id="覆盖索引"><a href="#覆盖索引" class="header-anchor">#</a> 覆盖索引</h3> <p>覆盖索引：一个索引包含/覆盖所有需要查询的字段的值（非聚集索引不一定需要回表查询）</p> <p>覆盖索引即需要查询的字段正好是索引的字段，那么直接根据该索引，就可以查到数据了， 而无需回表查询。</p> <h2 id="索引优化"><a href="#索引优化" class="header-anchor">#</a> 索引优化</h2> <h3 id="索引设计原则"><a href="#索引设计原则" class="header-anchor">#</a> 索引设计原则</h3> <ul><li>选择合适的字段创建索引</li> <li>频繁更新的字段应该慎重建立索引，维护索引的成本较高</li> <li>尽可能的考虑建立联合索引而不是单列索引</li> <li>注意避免冗余索引和重复索引</li> <li>考虑在字符串类型的字段上使用前缀索引代替普通索引</li> <li>尽量选择区分度高的列作为索引</li></ul> <h3 id="索引使用原则"><a href="#索引使用原则" class="header-anchor">#</a> 索引使用原则</h3> <ul><li>全值匹配</li> <li>最左前缀原则</li> <li>索引不参与计算，会导致索引失效而转向全表扫描</li> <li>存储引擎不能使用索引中范围条件右边的列</li> <li>尽量使用覆盖索引</li> <li>like 以通配符开头('%')，造成索引失效会变成全表扫描的操作</li> <li>字符串不加单引号索引失效</li> <li>&lt;，&lt;=，=，&gt;，&gt;=，BETWEEN，IN 可用到索引，&lt;&gt;，not in ，!= 则不行，会导致全表扫描</li> <li>少用or，用它来连接时会索引失效</li> <li>is null ,is not null 也无法使用索引</li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">2022/6/8</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/kr/database/database.html" class="prev">
          数据库
        </a></span> <span class="next"><a href="/kr/database/mysql/mysql-explain.html">
          MySQL 执行计划
        </a>
        →
      </span></p></div> </main></div> <aside class="page-sidebar"> <div class="page-side-toolbar"><div class="option-box-toc-fixed"><div class="toc-container-sidebar"><div class="pos-box"><div class="icon-arrow"></div> <div class="scroll-box" style="max-height:650px"><div style="font-weight:bold;text-align:center;">架构、存储引擎、事务、索引</div> <hr> <div class="toc-box"><ul class="toc-sidebar-links"><li><a href="/kr/database/mysql/storage-engine.html#mysql-架构" class="toc-sidebar-link">MySQL 架构</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/kr/database/mysql/storage-engine.html#sql-执行过程" class="toc-sidebar-link">SQL 执行过程</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/kr/database/mysql/storage-engine.html#myisam-innodb-区别" class="toc-sidebar-link">MyISAM/InnoDB 区别</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/kr/database/mysql/storage-engine.html#myisam" class="toc-sidebar-link">MyISAM</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/kr/database/mysql/storage-engine.html#innodb" class="toc-sidebar-link">InnoDB</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/kr/database/mysql/storage-engine.html#体系架构" class="toc-sidebar-link">体系架构</a></li><li class="toc-sidebar-sub-header"><a href="/kr/database/mysql/storage-engine.html#逻辑存储" class="toc-sidebar-link">逻辑存储</a></li></ul></li><li><a href="/kr/database/mysql/storage-engine.html#事务" class="toc-sidebar-link">事务</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/kr/database/mysql/storage-engine.html#事务原理" class="toc-sidebar-link">事务原理</a></li><li class="toc-sidebar-sub-header"><a href="/kr/database/mysql/storage-engine.html#隔离性" class="toc-sidebar-link">隔离性</a></li><li class="toc-sidebar-sub-header"><a href="/kr/database/mysql/storage-engine.html#锁" class="toc-sidebar-link">锁</a></li><li class="toc-sidebar-sub-header"><a href="/kr/database/mysql/storage-engine.html#mvcc-多版本并发控制" class="toc-sidebar-link">MVCC 多版本并发控制</a></li><li class="toc-sidebar-sub-header"><a href="/kr/database/mysql/storage-engine.html#解决幻读" class="toc-sidebar-link">解决幻读</a></li></ul></li><li><a href="/kr/database/mysql/storage-engine.html#日志" class="toc-sidebar-link">日志</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/kr/database/mysql/storage-engine.html#redo-log-重做日志" class="toc-sidebar-link">redo log 重做日志</a></li><li class="toc-sidebar-sub-header"><a href="/kr/database/mysql/storage-engine.html#undo-log-回滚日志" class="toc-sidebar-link">undo log 回滚日志</a></li><li class="toc-sidebar-sub-header"><a href="/kr/database/mysql/storage-engine.html#binlog-二进制日志" class="toc-sidebar-link">binlog 二进制日志</a></li></ul></li><li><a href="/kr/database/mysql/storage-engine.html#索引" class="toc-sidebar-link">索引</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/kr/database/mysql/storage-engine.html#优缺点" class="toc-sidebar-link">优缺点</a></li><li class="toc-sidebar-sub-header"><a href="/kr/database/mysql/storage-engine.html#分类" class="toc-sidebar-link">分类</a></li><li class="toc-sidebar-sub-header"><a href="/kr/database/mysql/storage-engine.html#索引结构-hash-索引" class="toc-sidebar-link">索引结构-Hash 索引</a></li><li class="toc-sidebar-sub-header"><a href="/kr/database/mysql/storage-engine.html#索引结构-b-树索引" class="toc-sidebar-link">索引结构-B+ 树索引</a></li><li class="toc-sidebar-sub-header"><a href="/kr/database/mysql/storage-engine.html#myisam-非聚集索引" class="toc-sidebar-link">MyISAM 非聚集索引</a></li><li class="toc-sidebar-sub-header"><a href="/kr/database/mysql/storage-engine.html#innodb-聚集索引" class="toc-sidebar-link">InnoDB 聚集索引</a></li><li class="toc-sidebar-sub-header"><a href="/kr/database/mysql/storage-engine.html#覆盖索引" class="toc-sidebar-link">覆盖索引</a></li></ul></li><li><a href="/kr/database/mysql/storage-engine.html#索引优化" class="toc-sidebar-link">索引优化</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/kr/database/mysql/storage-engine.html#索引设计原则" class="toc-sidebar-link">索引设计原则</a></li><li class="toc-sidebar-sub-header"><a href="/kr/database/mysql/storage-engine.html#索引使用原则" class="toc-sidebar-link">索引使用原则</a></li></ul></li></ul></div></div></div></div></div> <div class="option-box-toc-over"><img src="/images/system/toc.png" class="nozoom"> <span class="show-txt">目录</span> <div class="toc-container"><div class="pos-box"><div class="icon-arrow"></div> <div class="scroll-box" style="max-height:550px"><div style="font-weight:bold;text-align:center;">架构、存储引擎、事务、索引</div> <hr> <div class="toc-box"><ul class="toc-sidebar-links"><li><a href="/kr/database/mysql/storage-engine.html#mysql-架构" class="toc-sidebar-link">MySQL 架构</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/kr/database/mysql/storage-engine.html#sql-执行过程" class="toc-sidebar-link">SQL 执行过程</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/kr/database/mysql/storage-engine.html#myisam-innodb-区别" class="toc-sidebar-link">MyISAM/InnoDB 区别</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/kr/database/mysql/storage-engine.html#myisam" class="toc-sidebar-link">MyISAM</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/kr/database/mysql/storage-engine.html#innodb" class="toc-sidebar-link">InnoDB</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/kr/database/mysql/storage-engine.html#体系架构" class="toc-sidebar-link">体系架构</a></li><li class="toc-sidebar-sub-header"><a href="/kr/database/mysql/storage-engine.html#逻辑存储" class="toc-sidebar-link">逻辑存储</a></li></ul></li><li><a href="/kr/database/mysql/storage-engine.html#事务" class="toc-sidebar-link">事务</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/kr/database/mysql/storage-engine.html#事务原理" class="toc-sidebar-link">事务原理</a></li><li class="toc-sidebar-sub-header"><a href="/kr/database/mysql/storage-engine.html#隔离性" class="toc-sidebar-link">隔离性</a></li><li class="toc-sidebar-sub-header"><a href="/kr/database/mysql/storage-engine.html#锁" class="toc-sidebar-link">锁</a></li><li class="toc-sidebar-sub-header"><a href="/kr/database/mysql/storage-engine.html#mvcc-多版本并发控制" class="toc-sidebar-link">MVCC 多版本并发控制</a></li><li class="toc-sidebar-sub-header"><a href="/kr/database/mysql/storage-engine.html#解决幻读" class="toc-sidebar-link">解决幻读</a></li></ul></li><li><a href="/kr/database/mysql/storage-engine.html#日志" class="toc-sidebar-link">日志</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/kr/database/mysql/storage-engine.html#redo-log-重做日志" class="toc-sidebar-link">redo log 重做日志</a></li><li class="toc-sidebar-sub-header"><a href="/kr/database/mysql/storage-engine.html#undo-log-回滚日志" class="toc-sidebar-link">undo log 回滚日志</a></li><li class="toc-sidebar-sub-header"><a href="/kr/database/mysql/storage-engine.html#binlog-二进制日志" class="toc-sidebar-link">binlog 二进制日志</a></li></ul></li><li><a href="/kr/database/mysql/storage-engine.html#索引" class="toc-sidebar-link">索引</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/kr/database/mysql/storage-engine.html#优缺点" class="toc-sidebar-link">优缺点</a></li><li class="toc-sidebar-sub-header"><a href="/kr/database/mysql/storage-engine.html#分类" class="toc-sidebar-link">分类</a></li><li class="toc-sidebar-sub-header"><a href="/kr/database/mysql/storage-engine.html#索引结构-hash-索引" class="toc-sidebar-link">索引结构-Hash 索引</a></li><li class="toc-sidebar-sub-header"><a href="/kr/database/mysql/storage-engine.html#索引结构-b-树索引" class="toc-sidebar-link">索引结构-B+ 树索引</a></li><li class="toc-sidebar-sub-header"><a href="/kr/database/mysql/storage-engine.html#myisam-非聚集索引" class="toc-sidebar-link">MyISAM 非聚集索引</a></li><li class="toc-sidebar-sub-header"><a href="/kr/database/mysql/storage-engine.html#innodb-聚集索引" class="toc-sidebar-link">InnoDB 聚集索引</a></li><li class="toc-sidebar-sub-header"><a href="/kr/database/mysql/storage-engine.html#覆盖索引" class="toc-sidebar-link">覆盖索引</a></li></ul></li><li><a href="/kr/database/mysql/storage-engine.html#索引优化" class="toc-sidebar-link">索引优化</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/kr/database/mysql/storage-engine.html#索引设计原则" class="toc-sidebar-link">索引设计原则</a></li><li class="toc-sidebar-sub-header"><a href="/kr/database/mysql/storage-engine.html#索引使用原则" class="toc-sidebar-link">索引使用原则</a></li></ul></li></ul></div></div></div></div></div></div>  </aside></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.cfd60917.js" defer></script><script src="/assets/js/4.8234885e.js" defer></script><script src="/assets/js/3.1429892b.js" defer></script><script src="/assets/js/40.1689d33f.js" defer></script>
  </body>
</html>
