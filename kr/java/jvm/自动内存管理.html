<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>自动内存管理 | Keep Running</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/favicon.png">
    <script charset="utf-8" async="async" src="/js/jquery.min.js"></script>
    <script charset="utf-8" async="async" src="/js/global.js"></script>
    <script charset="utf-8" async="async" src="/js/fingerprint2.min.js"></script>
    <meta name="description" content="">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <link rel="preload" href="/assets/css/0.styles.42b858ce.css" as="style"><link rel="preload" href="/assets/js/app.cfd60917.js" as="script"><link rel="preload" href="/assets/js/4.8234885e.js" as="script"><link rel="preload" href="/assets/js/3.1429892b.js" as="script"><link rel="preload" href="/assets/js/47.dc8a97d4.js" as="script"><link rel="prefetch" href="/assets/js/10.0f0de338.js"><link rel="prefetch" href="/assets/js/11.0c47d372.js"><link rel="prefetch" href="/assets/js/12.b45ce082.js"><link rel="prefetch" href="/assets/js/13.f2032214.js"><link rel="prefetch" href="/assets/js/14.0a8927b2.js"><link rel="prefetch" href="/assets/js/15.9ab1d206.js"><link rel="prefetch" href="/assets/js/16.f03f2e40.js"><link rel="prefetch" href="/assets/js/17.c6bbe2be.js"><link rel="prefetch" href="/assets/js/18.e08bb862.js"><link rel="prefetch" href="/assets/js/19.c00af7cb.js"><link rel="prefetch" href="/assets/js/20.35396483.js"><link rel="prefetch" href="/assets/js/21.fe05d239.js"><link rel="prefetch" href="/assets/js/22.80eaa289.js"><link rel="prefetch" href="/assets/js/23.bce5e854.js"><link rel="prefetch" href="/assets/js/24.fa104861.js"><link rel="prefetch" href="/assets/js/25.2c725be9.js"><link rel="prefetch" href="/assets/js/26.fc7addb7.js"><link rel="prefetch" href="/assets/js/27.fc831a66.js"><link rel="prefetch" href="/assets/js/28.3784f580.js"><link rel="prefetch" href="/assets/js/29.7e78aa5c.js"><link rel="prefetch" href="/assets/js/30.b074fddd.js"><link rel="prefetch" href="/assets/js/31.059ebf27.js"><link rel="prefetch" href="/assets/js/32.12570018.js"><link rel="prefetch" href="/assets/js/33.d0dc971f.js"><link rel="prefetch" href="/assets/js/34.c9b46696.js"><link rel="prefetch" href="/assets/js/35.77a81c6a.js"><link rel="prefetch" href="/assets/js/36.6048e328.js"><link rel="prefetch" href="/assets/js/37.b9f285de.js"><link rel="prefetch" href="/assets/js/38.ac5a2abf.js"><link rel="prefetch" href="/assets/js/39.97ca52cb.js"><link rel="prefetch" href="/assets/js/40.1689d33f.js"><link rel="prefetch" href="/assets/js/41.4d2d8182.js"><link rel="prefetch" href="/assets/js/42.8647a8ff.js"><link rel="prefetch" href="/assets/js/43.f867a280.js"><link rel="prefetch" href="/assets/js/44.a51272ee.js"><link rel="prefetch" href="/assets/js/45.c31e6474.js"><link rel="prefetch" href="/assets/js/46.fe85ae54.js"><link rel="prefetch" href="/assets/js/48.c97f7726.js"><link rel="prefetch" href="/assets/js/49.ac219d14.js"><link rel="prefetch" href="/assets/js/5.963fada3.js"><link rel="prefetch" href="/assets/js/50.926ecfa5.js"><link rel="prefetch" href="/assets/js/51.e776b5b1.js"><link rel="prefetch" href="/assets/js/52.4938314c.js"><link rel="prefetch" href="/assets/js/53.6b4d7266.js"><link rel="prefetch" href="/assets/js/54.bfaf622b.js"><link rel="prefetch" href="/assets/js/55.c6d160b9.js"><link rel="prefetch" href="/assets/js/56.31f6843c.js"><link rel="prefetch" href="/assets/js/57.55cbf7b8.js"><link rel="prefetch" href="/assets/js/58.8174871d.js"><link rel="prefetch" href="/assets/js/59.3eee2bde.js"><link rel="prefetch" href="/assets/js/6.b2e36a75.js"><link rel="prefetch" href="/assets/js/60.233a32ed.js"><link rel="prefetch" href="/assets/js/61.defb83ac.js"><link rel="prefetch" href="/assets/js/62.442070cd.js"><link rel="prefetch" href="/assets/js/63.cc121456.js"><link rel="prefetch" href="/assets/js/64.c8f83f5d.js"><link rel="prefetch" href="/assets/js/65.b9bc8c1c.js"><link rel="prefetch" href="/assets/js/7.fb6689bf.js"><link rel="prefetch" href="/assets/js/8.e390cc6b.js"><link rel="prefetch" href="/assets/js/9.c03c9dfe.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.db8a86c9.js">
    <link rel="stylesheet" href="/assets/css/0.styles.42b858ce.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Keep Running</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/kr/java/jvm/自动内存管理.html" class="nav-link">
  Java
</a></div><div class="nav-item"><a href="/kr/database/database.html" class="nav-link">
  数据库
</a></div><div class="nav-item"><a href="/kr/spring/MVC-IOC-AOP.html" class="nav-link">
  Spring
</a></div><div class="nav-item"><a href="/kr/middleware/redis/redis-base.html" class="nav-link">
  Redis/Zookeeper/Kafka
</a></div><div class="nav-item"><a href="/kr/bigdata/hadoop/Hadoop-分布式集群容器部署.html" class="nav-link">
  大数据
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/kr/java/jvm/自动内存管理.html" class="nav-link">
  Java
</a></div><div class="nav-item"><a href="/kr/database/database.html" class="nav-link">
  数据库
</a></div><div class="nav-item"><a href="/kr/spring/MVC-IOC-AOP.html" class="nav-link">
  Spring
</a></div><div class="nav-item"><a href="/kr/middleware/redis/redis-base.html" class="nav-link">
  Redis/Zookeeper/Kafka
</a></div><div class="nav-item"><a href="/kr/bigdata/hadoop/Hadoop-分布式集群容器部署.html" class="nav-link">
  大数据
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>JVM</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/kr/java/jvm/自动内存管理.html" class="active sidebar-link">自动内存管理</a></li><li><a href="/kr/java/jvm/类加载机制.html" class="sidebar-link">类加载机制</a></li><li><a href="/kr/java/jvm/JVM-工具应用.html" class="sidebar-link">JVM 工具应用</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>JUC</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/kr/java/juc/juc.html" class="sidebar-link">JUC</a></li><li><a href="/kr/java/juc/互斥同步-解决方案.html" class="sidebar-link">互斥同步-解决方案</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>集合</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/kr/java/collection/Java-集合.html" class="sidebar-link">Java 集合</a></li><li><a href="/kr/java/collection/常见容错机制.html" class="sidebar-link">常见容错机制</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Other</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/kr/java/other/docker-use.html" class="sidebar-link">Docker 使用问题记录</a></li><li><a href="/kr/java/other/Pro-Git-学习总结.html" class="sidebar-link">分布式版本控制系统 Git 学习总结</a></li><li><a href="/kr/java/other/Linux.html" class="sidebar-link">Linux</a></li></ul></section></li></ul> </aside> <div><main class="page"> <div class="theme-default-content content__default"><h1 id="自动内存管理"><a href="#自动内存管理" class="header-anchor">#</a> 自动内存管理</h1> <h2 id="运行时数据区"><a href="#运行时数据区" class="header-anchor">#</a> 运行时数据区</h2> <p><img src="/images/kr/java/jvm/%E8%BF%90%E8%A1%8C%E6%97%B6%E6%95%B0%E6%8D%AE%E5%8C%BA.png" alt="运行时数据区"></p> <h2 id="hotspot-虚拟机对象"><a href="#hotspot-虚拟机对象" class="header-anchor">#</a> HotSpot-虚拟机对象</h2> <p><img src="/images/kr/java/jvm/HotSpot-%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%AF%B9%E8%B1%A1.png" alt="HotSpot-虚拟机对象"></p> <blockquote><p>虚拟机是否使用<code>TLAB 本地线程分配缓冲</code>可通过设置<code>-XX:+/-UseTLAB</code>参数来指定，JDK8 默认开启</p></blockquote> <h2 id="堆内存回收"><a href="#堆内存回收" class="header-anchor">#</a> 堆内存回收</h2> <blockquote><p>一般说的内存回收主要指的是堆内存中的对象回收</p></blockquote> <h3 id="对象已死"><a href="#对象已死" class="header-anchor">#</a> 对象已死？</h3> <p><img src="/images/kr/java/jvm/%E5%AF%B9%E8%B1%A1%E5%B7%B2%E6%AD%BB.png" alt="对象已死"></p> <h3 id="引用关系"><a href="#引用关系" class="header-anchor">#</a> 引用关系</h3> <blockquote><p><code>引用计数算法</code>或<code>可达性分析算法</code>都是基于对象的引用关系计算对象的被引用情况，从而判断对象是否存活</p> <p>Java 的数据类型：<code>基本数据类型</code>和<code>引用数据类型</code>，引用数据类型通过某个符号（引用变量/引用指针）指向某个对象</p></blockquote> <p><img src="/images/kr/java/jvm/%E5%BC%95%E7%94%A8%E5%85%B3%E7%B3%BB.png" alt="引用关系"></p> <blockquote><p>Java 允许使用 finalize() 方法在垃圾收集器回收对象前做必要工作，虚引用的主要作用是跟踪对象垃圾回收的状态，
用来实现比 finalization 通知机制更灵活的回收通知操作，虚引用无法访问对象实例</p></blockquote> <p><img src="/images/kr/java/jvm/Reference.png" alt="Reference"> <code>java.lang.ref.Reference</code> 的 4 种状态：</p> <ul><li>Active：新创建引用实例处于 Active 状态，当 GC 检测到该实例所引用的对象不可达时，状态将发生变化：
<ul><li>如果 Reference 注册了 ReferenceQueue，则切换为 Pending 状态，且 Reference 会加入 Pending-Reference 链表中</li> <li>如果没有注册 ReferenceQueue，则切换为 Inactive 状态</li></ul></li> <li>Pending：当引用实例处于 Pending-Reference 链表中时，为 Pending 状态
<ul><li>此时该实例在等待 Reference-Handler 线程进行 Enqueue 操作，加入 ReferenceQueue 中</li> <li>如果某个引用实例没有注册在一个引用队列中，该实例永远不会进入 Pending 状态</li></ul></li> <li>Enqueued：在 ReferenceQueue 队列中的 Reference 的状态，若 Reference 从队列中移除，会进入 Inactive 状态</li> <li>Inactive：一旦某个引用实例处于 Inactive 状态，其状态不再改变，即该引用实例所指向的对象一定会被回收</li></ul> <h3 id="对象回收过程"><a href="#对象回收过程" class="header-anchor">#</a> 对象回收过程</h3> <p><img src="/images/kr/java/jvm/%E5%AF%B9%E8%B1%A1%E5%9B%9E%E6%94%B6%E8%BF%87%E7%A8%8B.png" alt="对象回收过程"></p> <blockquote><p>如果第一次执行 finalize 方法此对象变成了可达确实不会回收，但如果对象再次被 GC，则会忽略 finalize 方法，对象会被回收</p></blockquote> <h3 id="垃圾收集算法"><a href="#垃圾收集算法" class="header-anchor">#</a> 垃圾收集算法</h3> <p><img src="/images/kr/java/jvm/%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E7%AE%97%E6%B3%95.png" alt="垃圾收集算法"></p> <h3 id="分代收集理论"><a href="#分代收集理论" class="header-anchor">#</a> 分代收集理论</h3> <blockquote><p>分代收集理论根据分代假说综合应用了多种垃圾收集算法的优点</p></blockquote> <p><img src="/images/kr/java/jvm/%E5%88%86%E4%BB%A3%E6%94%B6%E9%9B%86%E7%90%86%E8%AE%BA.png" alt="分代收集理论"></p> <h3 id="垃圾收集类型"><a href="#垃圾收集类型" class="header-anchor">#</a> 垃圾收集类型</h3> <p><img src="/images/kr/java/jvm/%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E7%B1%BB%E5%9E%8B.png" alt="垃圾收集类型"></p> <blockquote><p>Stop The World（STW）：在 GC（Minor GC 或 Full GC）期间，用户线程会被挂起，以便正确标记对象的状态是垃圾还是非垃圾</p></blockquote> <h3 id="垃圾收集器"><a href="#垃圾收集器" class="header-anchor">#</a> 垃圾收集器</h3> <ul><li>在新生代工作的垃圾回收器：Serial、ParNew、Parallel Scavenge</li> <li>在老年代工作的垃圾回收器：Serial Old、Parallel Old、CMS</li> <li>同时在新生代和老年代工作的垃圾回收器：G1</li></ul> <blockquote><p>Java8 默认使用 Parallel Scavenge + Parallel Old 组合，Java9 开始使用 G1 收集器</p></blockquote> <h4 id="串行收集器-serial"><a href="#串行收集器-serial" class="header-anchor">#</a> 串行收集器-Serial</h4> <p><img src="/images/kr/java/jvm/%E4%B8%B2%E8%A1%8C%E6%94%B6%E9%9B%86%E5%99%A8-Serial.png" alt="串行收集器-Serial">
Serial/Serial Old，单线程收集器，Serial 是 Client 模式下默认新生代收集器，Serial Old 是对应的老年代收集器</p> <h4 id="并行收集器-parnew"><a href="#并行收集器-parnew" class="header-anchor">#</a> 并行收集器-ParNew</h4> <p><img src="/images/kr/java/jvm/%E5%B9%B6%E8%A1%8C%E6%94%B6%E9%9B%86%E5%99%A8-ParNew.png" alt="并行收集器-ParNew">
ParNew 是 Serial 的多线程版本，是 Server 模式下首选新生代收集器，除 Serial 外，只有它能与 CMS 配合工作</p> <h4 id="并行收集器-parallel-scavenge-parallel-old"><a href="#并行收集器-parallel-scavenge-parallel-old" class="header-anchor">#</a> 并行收集器-Parallel Scavenge/Parallel Old</h4> <p><img src="/images/kr/java/jvm/%E5%B9%B6%E8%A1%8C%E6%94%B6%E9%9B%86%E5%99%A8-Parallel.png" alt="并行收集器-Parallel">
Parallel Scavenge 新生代收集器，使用标记-复制算法；Parallel Old 老生代收集器，使用标记-整理算法。
Parallel Scavenge/Parallel Old 为吞吐量优先收集器，其关注点：</p> <ul><li>吞吐量优先收集器的目标是达到一个可控制的吞吐量（吞吐量 = 运行用户代码时间 / (运行用户代码时间 + 垃圾收集时间)）</li> <li>高吞吐量可最高效率利用处理器资源，适合后台运算而不需要太多交互的分析任务</li></ul> <blockquote><p>垃圾收集的自适应调节策略：根据当前系统运行性能，动态调整参数以提供最合适停顿时间或最大吞吐量</p></blockquote> <h4 id="并发收集器-cms"><a href="#并发收集器-cms" class="header-anchor">#</a> 并发收集器-CMS</h4> <p><img src="/images/kr/java/jvm/CMS-%E6%94%B6%E9%9B%86%E5%99%A8.png" alt="CMS-收集器"> <img src="/images/kr/java/jvm/CMS-%E6%94%B6%E9%9B%86%E5%99%A82.png" alt="CMS-收集器"></p> <h4 id="并发收集器-g1-分区收集"><a href="#并发收集器-g1-分区收集" class="header-anchor">#</a> 并发收集器-G1（分区收集）</h4> <p><img src="/images/kr/java/jvm/G1-%E6%94%B6%E9%9B%86%E5%99%A8.png" alt="G1-收集器"> <img src="/images/kr/java/jvm/G1-%E6%94%B6%E9%9B%86%E5%99%A82.png" alt="G1-收集器"> <img src="/images/kr/java/jvm/G1-%E6%94%B6%E9%9B%86%E5%99%A83.png" alt="G1-收集器3">
注：图片来自：<a href="https://blog.csdn.net/weixin_41300437/article/details/118636783" target="_blank" rel="noopener noreferrer">JVM垃圾回收算法及JVM垃圾收集器<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="方法区回收"><a href="#方法区回收" class="header-anchor">#</a> 方法区回收</h2> <blockquote><p>方法区回收主要回收废弃常量和无用的类</p></blockquote> <h2 id="jvm-参数"><a href="#jvm-参数" class="header-anchor">#</a> JVM 参数</h2> <ul><li>标准参数（-）：所有 JVM 的实现版本都必须实现这些参数，向后兼容</li> <li>非标准参数（-X）：默认 JVM 实现这些参数，但并不保证所有 JVM 实现版本都满足，且不保证向后兼容</li> <li>非 Stable 参数（-XX）：此类参数各个 JVM 实现会有所不同，将来可能会随时取消，需慎重使用</li></ul> <h3 id="标准参数"><a href="#标准参数" class="header-anchor">#</a> 标准参数（-）</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ java
用法: java <span class="token punctuation">[</span>-options<span class="token punctuation">]</span> class <span class="token punctuation">[</span>args<span class="token punctuation">..</span>.<span class="token punctuation">]</span>
           <span class="token punctuation">(</span>执行类<span class="token punctuation">)</span>
   或  java <span class="token punctuation">[</span>-options<span class="token punctuation">]</span> -jar jarfile <span class="token punctuation">[</span>args<span class="token punctuation">..</span>.<span class="token punctuation">]</span>
           <span class="token punctuation">(</span>执行 jar 文件<span class="token punctuation">)</span>
其中选项包括:
    -d32          使用 <span class="token number">32</span> 位数据模型 <span class="token punctuation">(</span>如果可用<span class="token punctuation">)</span>
    -d64          使用 <span class="token number">64</span> 位数据模型 <span class="token punctuation">(</span>如果可用<span class="token punctuation">)</span>
    -server       选择 <span class="token string">&quot;server&quot;</span> VM
                  默认 VM 是 server.

    -cp <span class="token operator">&lt;</span>目录和 zip/jar 文件的类搜索路径<span class="token operator">&gt;</span>
    -classpath <span class="token operator">&lt;</span>目录和 zip/jar 文件的类搜索路径<span class="token operator">&gt;</span>
                  用 <span class="token punctuation">;</span> 分隔的目录, JAR 档案
                  和 ZIP 档案列表, 用于搜索类文件。
    -D<span class="token operator">&lt;</span>名称<span class="token operator">&gt;=</span><span class="token operator">&lt;</span>值<span class="token operator">&gt;</span>
                  设置系统属性
    -verbose:<span class="token punctuation">[</span>class<span class="token operator">|</span>gc<span class="token operator">|</span>jni<span class="token punctuation">]</span>
                  启用详细输出
    -version      输出产品版本并退出
    -version:<span class="token operator">&lt;</span>值<span class="token operator">&gt;</span>
                  警告: 此功能已过时, 将在
                  未来发行版中删除。
                  需要指定的版本才能运行
    -showversion  输出产品版本并继续
    -jre-restrict-search <span class="token operator">|</span> -no-jre-restrict-search
                  警告: 此功能已过时, 将在
                  未来发行版中删除。
                  在版本搜索中包括/排除用户专用 JRE
    -? -help      输出此帮助消息
    -X            输出非标准选项的帮助
    -ea<span class="token punctuation">[</span>:<span class="token operator">&lt;</span>packagename<span class="token operator">&gt;</span><span class="token punctuation">..</span>.<span class="token operator">|</span>:<span class="token operator">&lt;</span>classname<span class="token operator">&gt;</span><span class="token punctuation">]</span>
    -enableassertions<span class="token punctuation">[</span>:<span class="token operator">&lt;</span>packagename<span class="token operator">&gt;</span><span class="token punctuation">..</span>.<span class="token operator">|</span>:<span class="token operator">&lt;</span>classname<span class="token operator">&gt;</span><span class="token punctuation">]</span>
                  按指定的粒度启用断言
    -da<span class="token punctuation">[</span>:<span class="token operator">&lt;</span>packagename<span class="token operator">&gt;</span><span class="token punctuation">..</span>.<span class="token operator">|</span>:<span class="token operator">&lt;</span>classname<span class="token operator">&gt;</span><span class="token punctuation">]</span>
    -disableassertions<span class="token punctuation">[</span>:<span class="token operator">&lt;</span>packagename<span class="token operator">&gt;</span><span class="token punctuation">..</span>.<span class="token operator">|</span>:<span class="token operator">&lt;</span>classname<span class="token operator">&gt;</span><span class="token punctuation">]</span>
                  禁用具有指定粒度的断言
    -esa <span class="token operator">|</span> -enablesystemassertions
                  启用系统断言
    -dsa <span class="token operator">|</span> -disablesystemassertions
                  禁用系统断言
    -agentlib:<span class="token operator">&lt;</span>libname<span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token operator">=</span><span class="token operator">&lt;</span>选项<span class="token operator">&gt;</span><span class="token punctuation">]</span>
                  加载本机代理库 <span class="token operator">&lt;</span>libname<span class="token operator">&gt;</span>, 例如 -agentlib:hprof
                  另请参阅 -agentlib:jdwp<span class="token operator">=</span>help 和 -agentlib:hprof<span class="token operator">=</span>help
    -agentpath:<span class="token operator">&lt;</span>pathname<span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token operator">=</span><span class="token operator">&lt;</span>选项<span class="token operator">&gt;</span><span class="token punctuation">]</span>
                  按完整路径名加载本机代理库
    -javaagent:<span class="token operator">&lt;</span>jarpath<span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token operator">=</span><span class="token operator">&lt;</span>选项<span class="token operator">&gt;</span><span class="token punctuation">]</span>
                  加载 Java 编程语言代理, 请参阅 java.lang.instrument
    -splash:<span class="token operator">&lt;</span>imagepath<span class="token operator">&gt;</span>
                  使用指定的图像显示启动屏幕
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><ul><li>-agentlib:libname[=options]：用于装载环境变量 PATH 中的本地代理库 lib 包</li> <li>-agentpath:pathname[=options]：按指定全路径装载本地库，不再搜索 PATH 中的路径</li> <li>-Dproperty=value：设置系统级全局变量，运行在此 JVM 之上的应用程序可用 <code>System.getProperty(&quot;property&quot;)</code>得到属性值</li></ul> <h3 id="非标准参数-x"><a href="#非标准参数-x" class="header-anchor">#</a> 非标准参数（-X）</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ java -X
    -Xmixed           混合模式执行（默认）
    -Xint             仅解释模式执行
    -Xbootclasspath:<span class="token operator">&lt;</span>用 <span class="token punctuation">;</span> 分隔的目录和 zip/jar 文件<span class="token operator">&gt;</span>
                      设置引导类和资源的搜索路径
    -Xbootclasspath/a:<span class="token operator">&lt;</span>用 <span class="token punctuation">;</span> 分隔的目录和 zip/jar 文件<span class="token operator">&gt;</span>
                      附加在引导类路径末尾
    -Xbootclasspath/p:<span class="token operator">&lt;</span>用 <span class="token punctuation">;</span> 分隔的目录和 zip/jar 文件<span class="token operator">&gt;</span>
                      置于引导类路径之前
    -Xdiag            显示附加诊断消息
    -Xnoclassgc        禁用类垃圾收集
    -Xincgc           启用增量垃圾收集
    -Xloggc:<span class="token operator">&lt;</span>file<span class="token operator">&gt;</span>    将 GC 状态记录在文件中（带时间戳）
    -Xbatch           禁用后台编译
    -Xms<span class="token operator">&lt;</span>size<span class="token operator">&gt;</span>        设置初始 Java 堆大小
    -Xmx<span class="token operator">&lt;</span>size<span class="token operator">&gt;</span>        设置最大 Java 堆大小
    -Xss<span class="token operator">&lt;</span>size<span class="token operator">&gt;</span>        设置 Java 线程堆栈大小
    -Xprof            输出 cpu 分析数据
    -Xfuture          启用最严格的检查，预计会成为将来的默认值
    -Xrs              减少 Java/VM 对操作系统信号的使用（请参阅文档）
    -Xcheck:jni       对 JNI 函数执行其他检查
    -Xshare:off       不尝试使用共享类数据
    -Xshare:auto      在可能的情况下使用共享类数据（默认）
    -Xshare:on        要求使用共享类数据，否则将失败。
    -XshowSettings    显示所有设置并继续
    -XshowSettings:system
                      （仅限 Linux）显示系统或容器
                      配置并继续
    -XshowSettings:all
                      显示所有设置并继续
    -XshowSettings:vm 显示所有与 vm 相关的设置并继续
    -XshowSettings:properties
                      显示所有属性设置并继续
    -XshowSettings:locale
                      显示所有与区域设置相关的设置并继续
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><ul><li>-Xloggc:file：与<code>-verbose:gc</code>类似，只是将每次 GC 事件的相关情况记录到一个文件中，若与<code>verbose</code>命令同时出现，则以<code>-Xloggc</code>为准</li> <li>-Xprof：跟踪正运行的程序，并将跟踪数据在标准输出输出；适合于开发环境调试</li></ul> <h3 id="非-stable-参数-xx"><a href="#非-stable-参数-xx" class="header-anchor">#</a> 非 Stable 参数（-XX）</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 查看 XX 参数的初始默认值，注：:= 说明参数有人为修改过或 JVM 加载修改</span>
$ java -XX:+PrintFlagsInitial
$ java -XX:+PrintFlagsInitial -version
    <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
     bool UseLWPSynchronization                     <span class="token operator">=</span> <span class="token boolean">true</span>                                <span class="token punctuation">{</span>product<span class="token punctuation">}</span>
     bool UseLargePages                             <span class="token operator">=</span> <span class="token boolean">false</span>                               <span class="token punctuation">{</span>pd product<span class="token punctuation">}</span>
     bool UseLargePagesInMetaspace                  <span class="token operator">=</span> <span class="token boolean">false</span>                               <span class="token punctuation">{</span>product<span class="token punctuation">}</span>
     bool UseLargePagesIndividualAllocation        :<span class="token operator">=</span> <span class="token boolean">false</span>                               <span class="token punctuation">{</span>pd product<span class="token punctuation">}</span>
     bool UseLockedTracing                          <span class="token operator">=</span> <span class="token boolean">false</span>                               <span class="token punctuation">{</span>product<span class="token punctuation">}</span>
     bool UseLoopCounter                            <span class="token operator">=</span> <span class="token boolean">true</span>                                <span class="token punctuation">{</span>product<span class="token punctuation">}</span>
     bool UseLoopInvariantCodeMotion                <span class="token operator">=</span> <span class="token boolean">true</span>                                <span class="token punctuation">{</span>C1 product<span class="token punctuation">}</span>
     bool UseLoopPredicate                          <span class="token operator">=</span> <span class="token boolean">true</span>                                <span class="token punctuation">{</span>C2 product<span class="token punctuation">}</span>
     bool UseMathExactIntrinsics                    <span class="token operator">=</span> <span class="token boolean">true</span>                                <span class="token punctuation">{</span>C2 product<span class="token punctuation">}</span>
    <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
<span class="token comment"># 查看参数修改更新</span>
$ java -XX:+PrintFlagsFinal
$ java -XX:+PrintFlagsFinal -version
<span class="token comment"># 打印命令行参数</span>
$ java -XX:+PrintCommandLineFlags -version
-XX:InitialHeapSize<span class="token operator">=</span><span class="token number">265738560</span> -XX:MaxHeapSize<span class="token operator">=</span><span class="token number">4251816960</span> -XX:+PrintCommandLineFlags -XX:+UseCompressedClassPointers 
-XX:+UseCompressedOops -XX:-UseLargePagesIndividualAllocation -XX:+UseParallelGC
java version <span class="token string">&quot;1.8.0_261&quot;</span>
Java<span class="token punctuation">(</span>TM<span class="token punctuation">)</span> SE Runtime Environment <span class="token punctuation">(</span>build <span class="token number">1.8</span>.0_261-b12<span class="token punctuation">)</span>
Java HotSpot<span class="token punctuation">(</span>TM<span class="token punctuation">)</span> <span class="token number">64</span>-Bit Server VM <span class="token punctuation">(</span>build <span class="token number">25.261</span>-b12, mixed mode<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>XX 参数主要分为 Boolean 类型参数和 KV 类型参数：</p> <ul><li>Boolean：<code>-XX:+option</code>/<code>-XX:-option</code>，（+ 表示开启，- 表示关闭），如：<code>-XX:+PrintGCDetails</code>/<code>-XX:-PrintGCDetails</code></li> <li>KV：-XX:Key=Value，如：<code>-Xms</code>等价于<code>-XX:InitialHeapSize</code>，<code>-Xmx</code>等价于<code>-XX:MaxHeapSize</code></li></ul> <h3 id="常用配置"><a href="#常用配置" class="header-anchor">#</a> 常用配置</h3> <p><img src="/images/kr/java/jvm/JVM-%E5%86%85%E5%AD%98%E5%8F%82%E6%95%B0.png" alt="JVM-内存参数"></p> <h2 id="gc-日志"><a href="#gc-日志" class="header-anchor">#</a> GC 日志</h2> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">x<span class="token punctuation">.</span>t</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JvmGCLog</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> _1MB <span class="token operator">=</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d<span class="token punctuation">;</span>
        a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">2</span> <span class="token operator">*</span> _1MB<span class="token punctuation">]</span><span class="token punctuation">;</span>
        b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">2</span> <span class="token operator">*</span> _1MB<span class="token punctuation">]</span><span class="token punctuation">;</span>
        c <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">2</span> <span class="token operator">*</span> _1MB<span class="token punctuation">]</span><span class="token punctuation">;</span>
        d <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">2</span> <span class="token operator">*</span> _1MB<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 使用默认的 Parallel Scavenge + Parallel Old 收集器</span>
$ java -Xms20M -Xmx20M -Xmn10M -XX:+PrintGCDetails -XX:+PrintGCCause -XX:+PrintGCDateStamps -XX:+PrintGCTimeStamps x.t.JvmGCLog
<span class="token number">2022</span>-05-11T20:27:01.135+0800: <span class="token number">0.151</span>: <span class="token punctuation">[</span>GC <span class="token punctuation">(</span>Allocation Failure<span class="token punctuation">)</span> <span class="token punctuation">[</span>PSYoungGen: 6965K-<span class="token operator">&gt;</span>632K<span class="token punctuation">(</span>9216K<span class="token punctuation">)</span><span class="token punctuation">]</span> 6965K-<span class="token operator">&gt;</span>6784K<span class="token punctuation">(</span>19456K<span class="token punctuation">)</span>, <span class="token number">0.0056997</span> secs<span class="token punctuation">]</span> <span class="token punctuation">[</span>Times: <span class="token assign-left variable">user</span><span class="token operator">=</span><span class="token number">0.00</span> <span class="token assign-left variable">sys</span><span class="token operator">=</span><span class="token number">0.00</span>, <span class="token assign-left variable">real</span><span class="token operator">=</span><span class="token number">0.02</span> secs<span class="token punctuation">]</span>
<span class="token number">2022</span>-05-11T20:27:01.150+0800: <span class="token number">0.157</span>: <span class="token punctuation">[</span>Full GC <span class="token punctuation">(</span>Ergonomics<span class="token punctuation">)</span> <span class="token punctuation">[</span>PSYoungGen: 632K-<span class="token operator">&gt;</span>0K<span class="token punctuation">(</span>9216K<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>ParOldGen: 6152K-<span class="token operator">&gt;</span>6664K<span class="token punctuation">(</span>10240K<span class="token punctuation">)</span><span class="token punctuation">]</span> 6784K-<span class="token operator">&gt;</span>6664K<span class="token punctuation">(</span>19456K<span class="token punctuation">)</span>, <span class="token punctuation">[</span>Metaspace: 2554K-<span class="token operator">&gt;</span>2554K<span class="token punctuation">(</span>1056768K<span class="token punctuation">)</span><span class="token punctuation">]</span>, <span class="token number">0.0107570</span> secs<span class="token punctuation">]</span> <span class="token punctuation">[</span>Times: <span class="token assign-left variable">user</span><span class="token operator">=</span><span class="token number">0.00</span> <span class="token assign-left variable">sys</span><span class="token operator">=</span><span class="token number">0.00</span>, <span class="token assign-left variable">real</span><span class="token operator">=</span><span class="token number">0.01</span> secs<span class="token punctuation">]</span>
Heap
 PSYoungGen      total 9216K, used 2212K <span class="token punctuation">[</span>0x00000000ff600000, 0x0000000100000000, 0x0000000100000000<span class="token punctuation">)</span>
  eden space 8192K, <span class="token number">27</span>% used <span class="token punctuation">[</span>0x00000000ff600000,0x00000000ff8290e0,0x00000000ffe00000<span class="token punctuation">)</span>
  from space 1024K, <span class="token number">0</span>% used <span class="token punctuation">[</span>0x00000000ffe00000,0x00000000ffe00000,0x00000000fff00000<span class="token punctuation">)</span>
  to   space 1024K, <span class="token number">0</span>% used <span class="token punctuation">[</span>0x00000000fff00000,0x00000000fff00000,0x0000000100000000<span class="token punctuation">)</span>
 ParOldGen       total 10240K, used 6664K <span class="token punctuation">[</span>0x00000000fec00000, 0x00000000ff600000, 0x00000000ff600000<span class="token punctuation">)</span>
  object space 10240K, <span class="token number">65</span>% used <span class="token punctuation">[</span>0x00000000fec00000,0x00000000ff282320,0x00000000ff600000<span class="token punctuation">)</span>
 Metaspace       used 2560K, capacity 4486K, committed 4864K, reserved 1056768K
  class space    used 279K, capacity 386K, committed 512K, reserved 1048576K
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>GC 日志格式解释：</p> <ul><li>2022-05-11T20:27:01.135+0800：GC 发生日期</li> <li>0.151：GC 发生时间，表示从 JVM 启动以来经过的秒数</li> <li><code>GC</code>/<code>Full GC</code>：区分是 <code>Minor GC</code>、还是<code>Full GC</code></li> <li><code>Allocation Failure</code>/<code>Ergonomics</code>：引起 GC 的原因</li> <li><code>PSYoungGen</code>/<code>ParOldGen</code>/<code>Metaspace</code>：GC 发生的区域，区域名称由收集器决定</li> <li>6965K-&gt;632K(9216K)：表示「GC 前对应区域已使用容量 -&gt; GC 后对应区域已使用容量(对应区域总容量)」</li> <li>0.0056997 secs：对应区域或整个 Java 堆所 GC 持续时间，单位秒</li> <li>[Times: user=0.00 sys=0.00, real=0.02 secs]：GC 持续时间，通过多种分类来进行衡量:
<ul><li>user：此次 GC，垃圾收集线程消耗的所有 CPU 时间（用户态耗时）</li> <li>sys：操作系统调用及等待系统事件的时间（内核态耗时）</li> <li>real：应用程序暂停的时间（总耗时）</li></ul></li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 使用 Serial 收集器</span>
$ java -Xms20M -Xmx20M -Xmn10M -XX:+PrintGCDetails -XX:+PrintGCCause -XX:+PrintGCDateStamps -XX:+PrintGCTimeStamps -XX:+UseSerialGC x.t.JvmGCLog
<span class="token number">2022</span>-05-11T20:55:29.194+0800: <span class="token number">0.138</span>: <span class="token punctuation">[</span>GC <span class="token punctuation">(</span>Allocation Failure<span class="token punctuation">)</span> <span class="token number">2022</span>-05-11T20:55:29.194+0800: <span class="token number">0.138</span>: <span class="token punctuation">[</span>DefNew: 6965K-<span class="token operator">&gt;</span>521K<span class="token punctuation">(</span>9216K<span class="token punctuation">)</span>, <span class="token number">0.0079264</span> secs<span class="token punctuation">]</span> 6965K-<span class="token operator">&gt;</span>6665K<span class="token punctuation">(</span>19456K<span class="token punctuation">)</span>, <span class="token number">0.0080321</span> secs<span class="token punctuation">]</span> <span class="token punctuation">[</span>Times: <span class="token assign-left variable">user</span><span class="token operator">=</span><span class="token number">0.00</span> <span class="token assign-left variable">sys</span><span class="token operator">=</span><span class="token number">0.00</span>, <span class="token assign-left variable">real</span><span class="token operator">=</span><span class="token number">0.01</span> secs<span class="token punctuation">]</span>
Heap
 def new generation   total 9216K, used 2733K <span class="token punctuation">[</span>0x00000000fec00000, 0x00000000ff600000, 0x00000000ff600000<span class="token punctuation">)</span>
  eden space 8192K,  <span class="token number">27</span>% used <span class="token punctuation">[</span>0x00000000fec00000, 0x00000000fee290e0, 0x00000000ff400000<span class="token punctuation">)</span>
  from space 1024K,  <span class="token number">50</span>% used <span class="token punctuation">[</span>0x00000000ff500000, 0x00000000ff582700, 0x00000000ff600000<span class="token punctuation">)</span>
  to   space 1024K,   <span class="token number">0</span>% used <span class="token punctuation">[</span>0x00000000ff400000, 0x00000000ff400000, 0x00000000ff500000<span class="token punctuation">)</span>
 tenured generation   total 10240K, used 6144K <span class="token punctuation">[</span>0x00000000ff600000, 0x0000000100000000, 0x0000000100000000<span class="token punctuation">)</span>
   the space 10240K,  <span class="token number">60</span>% used <span class="token punctuation">[</span>0x00000000ff600000, 0x00000000ffc00030, 0x00000000ffc00200, 0x0000000100000000<span class="token punctuation">)</span>
 Metaspace       used 2560K, capacity 4486K, committed 4864K, reserved 1056768K
  class space    used 279K, capacity 386K, committed 512K, reserved 1048576K
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h2 id="oom-场景与解决方案"><a href="#oom-场景与解决方案" class="header-anchor">#</a> OOM 场景与解决方案</h2> <blockquote><p><code>StackOverflowError</code>和<code>OutOfMemoryError</code>都间接继承了 <code>Error</code> 类</p></blockquote> <h3 id="stackoverflowerror"><a href="#stackoverflowerror" class="header-anchor">#</a> StackOverflowError</h3> <p>JVM 虚拟机栈是有深度的，执行方法时伴随着栈帧入栈和出栈，当虚拟机栈无法再容纳新的栈帧入栈时，会发生栈深度溢出异常，场景：</p> <ul><li>无限递归循环调用方法而无法退出</li> <li>执行了大量方法，导致线程栈空间耗尽</li> <li>方法内声明了海量的局部变量</li></ul> <p>解决方案：</p> <ul><li>递归循环调用时注意退出逻辑</li> <li>排查是否存在类间的循环依赖（当两个对象相互引用，在调用 toString() 时也会产生这个异常）</li> <li>某些执行大量方法或包含大量局部变量的使用场景，可通过<code>-Xss</code>增加线程栈内存空间</li></ul> <h3 id="outofmemoryerror"><a href="#outofmemoryerror" class="header-anchor">#</a> OutOfMemoryError</h3> <h4 id="java-heap-space"><a href="#java-heap-space" class="header-anchor">#</a> Java heap space</h4> <p>当 Java 堆没有足够内存空间分配新对象时，内存溢出异常，场景：</p> <ul><li>创建超大对象/超大数组时，新生代 Eden 区空间不够，且老年代空间也不够无法提供内存分配担保</li> <li>超出预期的请求流量导致内存空间不够使用，可以结合业务流量指标排查是否有尖状峰值</li> <li>过度使用<code>Finalizer</code>，该对象没有立即被 GC</li> <li>内存泄漏（<code>Memory Leak</code>），大量对象引用没有被释放</li></ul> <blockquote><p>内存泄漏与内存溢出区别？</p> <ul><li>内存溢出(<code>Out Of Memory</code>)：在申请内存时，无足够内存空间可使用，比如一个 Integer 空间存了 Long 类型的值，会发生内存溢出</li> <li>内存泄露(<code>Memory Leak</code>)：在申请内存后，无释放已申请的内存空间，一次内存泄露危害可以忽略，但内存泄露堆积后果很严重</li></ul></blockquote> <p>解决方案：通常只需通过<code>-Xmx</code>参数调高 JVM 堆内存空间最大上限即可，也可考虑：</p> <ul><li>若是超大对象/超大数组，可以检查其合理性/有无必要</li> <li>若是业务峰值流量压力，可以考虑添加机器资源，或限流降级</li> <li>如果是内存泄漏，需要找到持有的对象，修改代码设计，比如关闭没有释放的连接</li></ul> <h4 id="gc-overhead-limit-exceeded"><a href="#gc-overhead-limit-exceeded" class="header-anchor">#</a> GC overhead limit exceeded</h4> <p>当 Java 进程花费 98% 以上的时间执行 GC，但只恢复了不到 2% 的内存，且该动作连续重复了 5 次，就会抛出<code>GC overhead limit exceeded</code>。
简单地说，就是应用程序已经基本耗尽了所有可用内存，GC 也无法回收，回收空间很快被使用，又会陷入 GC 恶性循环中</p> <h4 id="permgen-space"><a href="#permgen-space" class="header-anchor">#</a> Permgen space</h4> <p>表示永久代（<code>Permanent Generation</code>）已用满，通常是因为加载的 class 数目太多或体积太大，<code>PermGen</code>的使用量与加载到内存的 class 的数量/大小正相关</p> <p>永久代主要存储对象包括：</p> <ul><li>加载/缓存到内存中的 class 定义</li> <li>常量池</li> <li>对象数组/类型数组所关联的 class</li> <li>JIT 编译器优化后的 class 信息</li></ul> <p>解决方案：</p> <ul><li>程序启动时报错，则可修改<code>-XX:MaxPermSize</code>，调大永久代空间</li> <li>运行时报错，程序可能会动态创建大量短生命周期的 class，但 JVM 默认不卸载，可设置<code>-XX:+CMSClassUnloadingEnabled</code>及<code>-XX:+UseConcMarkSweepGC</code>允许 JVM 卸载</li></ul> <h4 id="metaspace"><a href="#metaspace" class="header-anchor">#</a> Metaspace</h4> <p>JDK 1.8 使用<code>Metaspace</code>替换了永久代（<code>Permanent Generation</code>），该错误表示<code>Metaspace</code>已被用满，通常是因为加载的 class 数目太多或体积太大，
该问题与<code>Permgen space</code>类似，调整<code>Metaspace</code>空间大小的启动参数为<code>-XX:MaxMetaspaceSize</code></p> <blockquote><p>永久代和元空间都是方法区（非堆）的实现方式</p> <p>JDK1.8 之前使用永久代，JDK1.8 之后使用元空间</p> <p>永久代使用的是 JVM 内存，而元空间并不在虚拟机内存中而是使用本地内存（直接内存）</p></blockquote> <blockquote><p>方法区溢出也是一种常见的内存溢出异常，在经常运行时生成大量动态类的应用场景中，应特别关注这些类的卸载回收情况</p></blockquote> <h4 id="unable-to-create-new-native-thread"><a href="#unable-to-create-new-native-thread" class="header-anchor">#</a> Unable to create new native thread</h4> <p>当 JVM 向底层操作系统（OS）请求创建<code>native</code>线程时，若没有足够的资源分配造成创建失败则报此类错误，常见场景：</p> <ul><li>线程数超过操作系统最大线程数 ulimit 限制</li> <li>线程数超过 kernel.pid_max（只能重启）</li> <li>native 内存不足：以下几步：
<ul><li>JVM 应用程序请求创建新 Java 线程</li> <li>JVM native 方法代理该次请求，并向操作系统请求创建 native 线程</li> <li>操作系统尝试创建一个新 native 线程，并为其分配内存</li> <li>如果操作系统的虚拟内存已耗尽，或受到 32 位进程的地址空间限制，操作系统就会拒绝本次 native 内存分配</li> <li>JVM 将抛出<code>Unable to create new native thread</code>异常</li></ul></li></ul> <p>解决方案：</p> <ul><li>修复线程泄漏问题，限制线程池大小</li> <li>调高 OS 层面的线程最大数：执行<code>ulimit -a</code>查看最大线程数限制，使用<code>ulimit -u xxx</code>调整最大线程数限制</li></ul> <h4 id="out-of-swap-space"><a href="#out-of-swap-space" class="header-anchor">#</a> Out of swap space</h4> <blockquote><p>虚拟内存（Virtual Memory）由物理内存（Physical Memory）和交换空间（Swap Space）两部分组成，在 JVM 请求的总内存大于可用物理内存时，操作系统开始将内容从内存换出到硬盘驱动器（使用交换空间）</p></blockquote> <p>表示所有可用的虚拟内存已耗尽</p> <h4 id="kill-process-or-sacrifice-child"><a href="#kill-process-or-sacrifice-child" class="header-anchor">#</a> Kill process or sacrifice child</h4> <p>有一种内核作业（Kernel Job）名为 Out of Memory Killer，它会在可用内存极低的情况下“杀死”（kill）某些进程。OOM Killer 会对所有进程进行打分，然后将评分较低的进程“杀死”</p> <p>该错误不是由 JVM 层面触发的，而是由操作系统层面触发的。</p> <h4 id="requested-array-size-exceeds-vm-limit"><a href="#requested-array-size-exceeds-vm-limit" class="header-anchor">#</a> Requested array size exceeds VM limit</h4> <p>JVM 限制了数组的最大长度，该错误表示程序请求创建的数组超过最大长度限制</p> <h4 id="direct-buffer-memory"><a href="#direct-buffer-memory" class="header-anchor">#</a> Direct buffer memory</h4> <blockquote><p>Java 允许应用程序通过<code>Direct ByteBuffer</code>直接访问堆外内存，许多高性能程序通过<code>Direct ByteBuffer</code>结合内存映射文件（<code>Memory Mapped File</code>）实现高速 IO</p></blockquote> <p><code>Direct ByteBuffer</code>的默认大小为 64 MB，一旦使用超出限制，就会抛出该错误，解决方案：</p> <ul><li>Java 只能通过<code>ByteBuffer.allocateDirect()</code>使用<code>Direct ByteBuffer</code></li> <li>通过启动参数<code>-XX:MaxDirectMemorySize</code>调整<code>Direct ByteBuffer</code>的上限值</li> <li>检查 JVM 参数是否有<code>-XX:+DisableExplicitGC</code>选项，若有就去掉，因为该参数会使<code>System.gc()</code>失效</li> <li>检查堆外内存是否存在内存泄漏，或反射调用<code>sun.misc.Cleaner.clean()</code>来主动释放被<code>Direct ByteBuffer</code>持有的内存空间</li></ul> <blockquote><p><code>ByteBuffer.allocate(capability)</code>：分配 JVM 堆内存，属于 GC 范围，需内存拷贝所以速度相对较慢</p> <p><code>ByteBuffer.allocateDirect(capability)</code>：分配 OS 本地内存，不属于 GC 范围，无需内存拷贝所以速度相对较快</p></blockquote> <h2 id="参考"><a href="#参考" class="header-anchor">#</a> 参考</h2> <p><a href="https://cloud.tencent.com/developer/article/1480668" target="_blank" rel="noopener noreferrer">教你分析9种 OOM 常见原因及解决方案<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">2022/6/8</span></div></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/kr/java/jvm/类加载机制.html">
          类加载机制
        </a>
        →
      </span></p></div> </main></div> <aside class="page-sidebar"> <div class="page-side-toolbar"><div class="option-box-toc-fixed"><div class="toc-container-sidebar"><div class="pos-box"><div class="icon-arrow"></div> <div class="scroll-box" style="max-height:650px"><div style="font-weight:bold;text-align:center;">自动内存管理</div> <hr> <div class="toc-box"><ul class="toc-sidebar-links"><li><a href="/kr/java/jvm/%E8%87%AA%E5%8A%A8%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86.html#运行时数据区" class="toc-sidebar-link">运行时数据区</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/kr/java/jvm/%E8%87%AA%E5%8A%A8%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86.html#hotspot-虚拟机对象" class="toc-sidebar-link">HotSpot-虚拟机对象</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/kr/java/jvm/%E8%87%AA%E5%8A%A8%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86.html#堆内存回收" class="toc-sidebar-link">堆内存回收</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/kr/java/jvm/%E8%87%AA%E5%8A%A8%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86.html#对象已死" class="toc-sidebar-link">对象已死？</a></li><li class="toc-sidebar-sub-header"><a href="/kr/java/jvm/%E8%87%AA%E5%8A%A8%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86.html#引用关系" class="toc-sidebar-link">引用关系</a></li><li class="toc-sidebar-sub-header"><a href="/kr/java/jvm/%E8%87%AA%E5%8A%A8%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86.html#对象回收过程" class="toc-sidebar-link">对象回收过程</a></li><li class="toc-sidebar-sub-header"><a href="/kr/java/jvm/%E8%87%AA%E5%8A%A8%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86.html#垃圾收集算法" class="toc-sidebar-link">垃圾收集算法</a></li><li class="toc-sidebar-sub-header"><a href="/kr/java/jvm/%E8%87%AA%E5%8A%A8%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86.html#分代收集理论" class="toc-sidebar-link">分代收集理论</a></li><li class="toc-sidebar-sub-header"><a href="/kr/java/jvm/%E8%87%AA%E5%8A%A8%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86.html#垃圾收集类型" class="toc-sidebar-link">垃圾收集类型</a></li><li class="toc-sidebar-sub-header"><a href="/kr/java/jvm/%E8%87%AA%E5%8A%A8%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86.html#垃圾收集器" class="toc-sidebar-link">垃圾收集器</a></li></ul></li><li><a href="/kr/java/jvm/%E8%87%AA%E5%8A%A8%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86.html#方法区回收" class="toc-sidebar-link">方法区回收</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/kr/java/jvm/%E8%87%AA%E5%8A%A8%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86.html#jvm-参数" class="toc-sidebar-link">JVM 参数</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/kr/java/jvm/%E8%87%AA%E5%8A%A8%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86.html#标准参数" class="toc-sidebar-link">标准参数（-）</a></li><li class="toc-sidebar-sub-header"><a href="/kr/java/jvm/%E8%87%AA%E5%8A%A8%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86.html#非标准参数-x" class="toc-sidebar-link">非标准参数（-X）</a></li><li class="toc-sidebar-sub-header"><a href="/kr/java/jvm/%E8%87%AA%E5%8A%A8%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86.html#非-stable-参数-xx" class="toc-sidebar-link">非 Stable 参数（-XX）</a></li><li class="toc-sidebar-sub-header"><a href="/kr/java/jvm/%E8%87%AA%E5%8A%A8%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86.html#常用配置" class="toc-sidebar-link">常用配置</a></li></ul></li><li><a href="/kr/java/jvm/%E8%87%AA%E5%8A%A8%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86.html#gc-日志" class="toc-sidebar-link">GC 日志</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/kr/java/jvm/%E8%87%AA%E5%8A%A8%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86.html#oom-场景与解决方案" class="toc-sidebar-link">OOM 场景与解决方案</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/kr/java/jvm/%E8%87%AA%E5%8A%A8%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86.html#stackoverflowerror" class="toc-sidebar-link">StackOverflowError</a></li><li class="toc-sidebar-sub-header"><a href="/kr/java/jvm/%E8%87%AA%E5%8A%A8%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86.html#outofmemoryerror" class="toc-sidebar-link">OutOfMemoryError</a></li></ul></li><li><a href="/kr/java/jvm/%E8%87%AA%E5%8A%A8%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86.html#参考" class="toc-sidebar-link">参考</a><ul class="toc-sidebar-sub-headers"></ul></li></ul></div></div></div></div></div> <div class="option-box-toc-over"><img src="/images/system/toc.png" class="nozoom"> <span class="show-txt">目录</span> <div class="toc-container"><div class="pos-box"><div class="icon-arrow"></div> <div class="scroll-box" style="max-height:550px"><div style="font-weight:bold;text-align:center;">自动内存管理</div> <hr> <div class="toc-box"><ul class="toc-sidebar-links"><li><a href="/kr/java/jvm/%E8%87%AA%E5%8A%A8%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86.html#运行时数据区" class="toc-sidebar-link">运行时数据区</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/kr/java/jvm/%E8%87%AA%E5%8A%A8%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86.html#hotspot-虚拟机对象" class="toc-sidebar-link">HotSpot-虚拟机对象</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/kr/java/jvm/%E8%87%AA%E5%8A%A8%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86.html#堆内存回收" class="toc-sidebar-link">堆内存回收</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/kr/java/jvm/%E8%87%AA%E5%8A%A8%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86.html#对象已死" class="toc-sidebar-link">对象已死？</a></li><li class="toc-sidebar-sub-header"><a href="/kr/java/jvm/%E8%87%AA%E5%8A%A8%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86.html#引用关系" class="toc-sidebar-link">引用关系</a></li><li class="toc-sidebar-sub-header"><a href="/kr/java/jvm/%E8%87%AA%E5%8A%A8%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86.html#对象回收过程" class="toc-sidebar-link">对象回收过程</a></li><li class="toc-sidebar-sub-header"><a href="/kr/java/jvm/%E8%87%AA%E5%8A%A8%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86.html#垃圾收集算法" class="toc-sidebar-link">垃圾收集算法</a></li><li class="toc-sidebar-sub-header"><a href="/kr/java/jvm/%E8%87%AA%E5%8A%A8%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86.html#分代收集理论" class="toc-sidebar-link">分代收集理论</a></li><li class="toc-sidebar-sub-header"><a href="/kr/java/jvm/%E8%87%AA%E5%8A%A8%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86.html#垃圾收集类型" class="toc-sidebar-link">垃圾收集类型</a></li><li class="toc-sidebar-sub-header"><a href="/kr/java/jvm/%E8%87%AA%E5%8A%A8%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86.html#垃圾收集器" class="toc-sidebar-link">垃圾收集器</a></li></ul></li><li><a href="/kr/java/jvm/%E8%87%AA%E5%8A%A8%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86.html#方法区回收" class="toc-sidebar-link">方法区回收</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/kr/java/jvm/%E8%87%AA%E5%8A%A8%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86.html#jvm-参数" class="toc-sidebar-link">JVM 参数</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/kr/java/jvm/%E8%87%AA%E5%8A%A8%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86.html#标准参数" class="toc-sidebar-link">标准参数（-）</a></li><li class="toc-sidebar-sub-header"><a href="/kr/java/jvm/%E8%87%AA%E5%8A%A8%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86.html#非标准参数-x" class="toc-sidebar-link">非标准参数（-X）</a></li><li class="toc-sidebar-sub-header"><a href="/kr/java/jvm/%E8%87%AA%E5%8A%A8%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86.html#非-stable-参数-xx" class="toc-sidebar-link">非 Stable 参数（-XX）</a></li><li class="toc-sidebar-sub-header"><a href="/kr/java/jvm/%E8%87%AA%E5%8A%A8%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86.html#常用配置" class="toc-sidebar-link">常用配置</a></li></ul></li><li><a href="/kr/java/jvm/%E8%87%AA%E5%8A%A8%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86.html#gc-日志" class="toc-sidebar-link">GC 日志</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/kr/java/jvm/%E8%87%AA%E5%8A%A8%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86.html#oom-场景与解决方案" class="toc-sidebar-link">OOM 场景与解决方案</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/kr/java/jvm/%E8%87%AA%E5%8A%A8%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86.html#stackoverflowerror" class="toc-sidebar-link">StackOverflowError</a></li><li class="toc-sidebar-sub-header"><a href="/kr/java/jvm/%E8%87%AA%E5%8A%A8%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86.html#outofmemoryerror" class="toc-sidebar-link">OutOfMemoryError</a></li></ul></li><li><a href="/kr/java/jvm/%E8%87%AA%E5%8A%A8%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86.html#参考" class="toc-sidebar-link">参考</a><ul class="toc-sidebar-sub-headers"></ul></li></ul></div></div></div></div></div></div>  </aside></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.cfd60917.js" defer></script><script src="/assets/js/4.8234885e.js" defer></script><script src="/assets/js/3.1429892b.js" defer></script><script src="/assets/js/47.dc8a97d4.js" defer></script>
  </body>
</html>
