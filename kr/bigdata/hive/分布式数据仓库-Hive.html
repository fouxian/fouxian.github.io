<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>分布式数据仓库 Hive | Keep Running</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/favicon.png">
    <script charset="utf-8" async="async" src="/js/jquery.min.js"></script>
    <script charset="utf-8" async="async" src="/js/global.js"></script>
    <script charset="utf-8" async="async" src="/js/fingerprint2.min.js"></script>
    <meta name="description" content="">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <link rel="preload" href="/assets/css/0.styles.42b858ce.css" as="style"><link rel="preload" href="/assets/js/app.cfd60917.js" as="script"><link rel="preload" href="/assets/js/4.8234885e.js" as="script"><link rel="preload" href="/assets/js/3.1429892b.js" as="script"><link rel="preload" href="/assets/js/29.7e78aa5c.js" as="script"><link rel="prefetch" href="/assets/js/10.0f0de338.js"><link rel="prefetch" href="/assets/js/11.0c47d372.js"><link rel="prefetch" href="/assets/js/12.b45ce082.js"><link rel="prefetch" href="/assets/js/13.f2032214.js"><link rel="prefetch" href="/assets/js/14.0a8927b2.js"><link rel="prefetch" href="/assets/js/15.9ab1d206.js"><link rel="prefetch" href="/assets/js/16.f03f2e40.js"><link rel="prefetch" href="/assets/js/17.c6bbe2be.js"><link rel="prefetch" href="/assets/js/18.e08bb862.js"><link rel="prefetch" href="/assets/js/19.c00af7cb.js"><link rel="prefetch" href="/assets/js/20.35396483.js"><link rel="prefetch" href="/assets/js/21.fe05d239.js"><link rel="prefetch" href="/assets/js/22.80eaa289.js"><link rel="prefetch" href="/assets/js/23.bce5e854.js"><link rel="prefetch" href="/assets/js/24.fa104861.js"><link rel="prefetch" href="/assets/js/25.2c725be9.js"><link rel="prefetch" href="/assets/js/26.fc7addb7.js"><link rel="prefetch" href="/assets/js/27.fc831a66.js"><link rel="prefetch" href="/assets/js/28.3784f580.js"><link rel="prefetch" href="/assets/js/30.b074fddd.js"><link rel="prefetch" href="/assets/js/31.059ebf27.js"><link rel="prefetch" href="/assets/js/32.12570018.js"><link rel="prefetch" href="/assets/js/33.d0dc971f.js"><link rel="prefetch" href="/assets/js/34.c9b46696.js"><link rel="prefetch" href="/assets/js/35.77a81c6a.js"><link rel="prefetch" href="/assets/js/36.6048e328.js"><link rel="prefetch" href="/assets/js/37.b9f285de.js"><link rel="prefetch" href="/assets/js/38.ac5a2abf.js"><link rel="prefetch" href="/assets/js/39.97ca52cb.js"><link rel="prefetch" href="/assets/js/40.1689d33f.js"><link rel="prefetch" href="/assets/js/41.4d2d8182.js"><link rel="prefetch" href="/assets/js/42.8647a8ff.js"><link rel="prefetch" href="/assets/js/43.f867a280.js"><link rel="prefetch" href="/assets/js/44.a51272ee.js"><link rel="prefetch" href="/assets/js/45.c31e6474.js"><link rel="prefetch" href="/assets/js/46.fe85ae54.js"><link rel="prefetch" href="/assets/js/47.dc8a97d4.js"><link rel="prefetch" href="/assets/js/48.c97f7726.js"><link rel="prefetch" href="/assets/js/49.ac219d14.js"><link rel="prefetch" href="/assets/js/5.963fada3.js"><link rel="prefetch" href="/assets/js/50.926ecfa5.js"><link rel="prefetch" href="/assets/js/51.e776b5b1.js"><link rel="prefetch" href="/assets/js/52.4938314c.js"><link rel="prefetch" href="/assets/js/53.6b4d7266.js"><link rel="prefetch" href="/assets/js/54.bfaf622b.js"><link rel="prefetch" href="/assets/js/55.c6d160b9.js"><link rel="prefetch" href="/assets/js/56.31f6843c.js"><link rel="prefetch" href="/assets/js/57.55cbf7b8.js"><link rel="prefetch" href="/assets/js/58.8174871d.js"><link rel="prefetch" href="/assets/js/59.3eee2bde.js"><link rel="prefetch" href="/assets/js/6.b2e36a75.js"><link rel="prefetch" href="/assets/js/60.233a32ed.js"><link rel="prefetch" href="/assets/js/61.defb83ac.js"><link rel="prefetch" href="/assets/js/62.442070cd.js"><link rel="prefetch" href="/assets/js/63.cc121456.js"><link rel="prefetch" href="/assets/js/64.c8f83f5d.js"><link rel="prefetch" href="/assets/js/65.b9bc8c1c.js"><link rel="prefetch" href="/assets/js/7.fb6689bf.js"><link rel="prefetch" href="/assets/js/8.e390cc6b.js"><link rel="prefetch" href="/assets/js/9.c03c9dfe.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.db8a86c9.js">
    <link rel="stylesheet" href="/assets/css/0.styles.42b858ce.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Keep Running</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/kr/java/jvm/自动内存管理.html" class="nav-link">
  Java
</a></div><div class="nav-item"><a href="/kr/database/database.html" class="nav-link">
  数据库
</a></div><div class="nav-item"><a href="/kr/spring/MVC-IOC-AOP.html" class="nav-link">
  Spring
</a></div><div class="nav-item"><a href="/kr/middleware/redis/redis-base.html" class="nav-link">
  Redis/Zookeeper/Kafka
</a></div><div class="nav-item"><a href="/kr/bigdata/hadoop/Hadoop-分布式集群容器部署.html" class="nav-link">
  大数据
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/kr/java/jvm/自动内存管理.html" class="nav-link">
  Java
</a></div><div class="nav-item"><a href="/kr/database/database.html" class="nav-link">
  数据库
</a></div><div class="nav-item"><a href="/kr/spring/MVC-IOC-AOP.html" class="nav-link">
  Spring
</a></div><div class="nav-item"><a href="/kr/middleware/redis/redis-base.html" class="nav-link">
  Redis/Zookeeper/Kafka
</a></div><div class="nav-item"><a href="/kr/bigdata/hadoop/Hadoop-分布式集群容器部署.html" class="nav-link">
  大数据
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Hadoop</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/kr/bigdata/hadoop/Hadoop-分布式集群容器部署.html" class="sidebar-link">Hadoop概述及分布式集群容器化部署</a></li><li><a href="/kr/bigdata/hadoop/分布式文件系统-HDFS-体系架构及原理.html" class="sidebar-link">分布式文件系统 HDFS 体系架构及原理</a></li><li><a href="/kr/bigdata/hadoop/分布式并行计算-MapReduce-概述及原理.html" class="sidebar-link">分布式并行计算 MapReduce 概述及原理</a></li><li><a href="/kr/bigdata/hadoop/集群资源管理与调度平台-YARN-概述及原理.html" class="sidebar-link">集群资源管理与调度平台 YARN 概述及原理</a></li><li><a href="/kr/bigdata/hadoop/MapReduce-实例-WordCount.html" class="sidebar-link">MapReduce 经典案例：WordCount</a></li><li><a href="/kr/bigdata/hadoop/HDFS-3-X-纠删码.html" class="sidebar-link">HDFS 3.X 纠删码</a></li><li><a href="/kr/bigdata/hadoop/大数据生态圈与离线实时数据平台实践.html" class="sidebar-link">大数据生态圈与离线实时数据平台实践</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Hive</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/kr/bigdata/hive/分布式数据仓库-Hive.html" class="active sidebar-link">分布式数据仓库 Hive</a></li><li><a href="/kr/bigdata/hive/Hive-SQL.html" class="sidebar-link">Hive SQL 执行计划|数据倾斜|性能优化</a></li><li><a href="/kr/bigdata/hive/HiveSQL-编译过程.html" class="sidebar-link">Hive 工作原理：Hive SQL 编译过程</a></li><li><a href="/kr/bigdata/hive/Hive-function.html" class="sidebar-link">Hive Function</a></li><li><a href="/kr/bigdata/hive/Hive-SQL-Examples.html" class="sidebar-link">Hive SQL Examples</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Spark</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/kr/bigdata/spark/Spark-概述与集群部署模式.html" class="sidebar-link">Spark 概述与集群部署模式</a></li><li><a href="/kr/bigdata/spark/Spark-RDD-弹性分布式数据集.html" class="sidebar-link">Spark RDD 弹性分布式数据集</a></li><li><a href="/kr/bigdata/spark/Spark-运行架构.html" class="sidebar-link">Spark 运行架构及作业提交流程</a></li><li><a href="/kr/bigdata/spark/Spark-Streaming.html" class="sidebar-link">Spark Streaming</a></li><li><a href="/kr/bigdata/spark/Spark-sql.html" class="sidebar-link">Spark SQL</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Other</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/kr/bigdata/Canal-MySQL-binlog-增量订阅与消费组件.html" class="sidebar-link">Canal：MySQL Binlog 增量订阅与消费组件</a></li><li><a href="/kr/bigdata/Sqoop-数据迁移工具.html" class="sidebar-link">Sqoop 数据迁移工具</a></li><li><a href="/kr/bigdata/Flume-基本架构及应用场景.html" class="sidebar-link">Flume 基本架构及应用场景</a></li><li><a href="/kr/bigdata/Azkaban-编译镜像及基本使用.html" class="sidebar-link">Azkaban 编译镜像及基本使用</a></li><li><a href="/kr/bigdata/Maxwell.html" class="sidebar-link">Maxwell</a></li><li><a href="/kr/bigdata/Elaticsearch.html" class="sidebar-link">Elaticsearch</a></li><li><a href="/kr/bigdata/大数据可视化交互平台-Hue.html" class="sidebar-link">大数据可视化交互平台 Hue</a></li></ul></section></li></ul> </aside> <div><main class="page"> <div class="theme-default-content content__default"><h1 id="分布式数据仓库-hive"><a href="#分布式数据仓库-hive" class="header-anchor">#</a> 分布式数据仓库 Hive</h1> <blockquote><p>Hive 本质：将 HQL 转化成 MapReduce 程序，用于分析处理 HDFS 上的数据，该程序运行在 Yarn 上；目前 Hive 支持 MapReduce、Tez、Spark 三种计算引擎</p></blockquote> <h2 id="hive-概述"><a href="#hive-概述" class="header-anchor">#</a> Hive 概述</h2> <ul><li>功能：Hive 是基于 Hadoop 的一个用于解决海量结构化日志的数据仓库工具，可以将结构化的数据文件映射为一张数据库表(<code>元数据管理</code>)，并提供类 SQL 查询功能(<code>查询引擎</code>)</li> <li>场景：Hive 专为联机分析处理(OLAP)设计，但由于  MapReduce 并不实时，所以 Hive 并不适合联机事务处理(OLTP)，Hive 的最佳使用场合是大数据集的批处理作业</li></ul> <blockquote><p>Hive 本质：将 HQL 转化成 MapReduce 程序，用于分析处理 HDFS 上的数据，该程序运行在 Yarn 上</p></blockquote> <p><img src="/images/kr/bigdata/hive/SQL-MapReduce.jpg" alt="SQL-MapReduce"></p> <h3 id="hive-优缺点"><a href="#hive-优缺点" class="header-anchor">#</a> Hive 优缺点</h3> <ul><li>提供类 SQL 语法，具备快速开发的能力，避免了开发 MapReduce 复杂程序，减低学习成本</li> <li>由于 MapReduce 具有较高延迟，故 Hive 也有较高延迟，因此常用于对实时性要求不高的场合</li> <li>Hive 优势在于处理大数据，对于处理小数据没有优势，因为 Hive 的执行延迟比较高</li> <li>Hive 支持用户自定义函数（扩展 UDF 函数），来完成内置函数无法实现的操作</li> <li>将元数据保存在关系数据库中，可大大减少在查询过程中执行语义检查的时间</li> <li>Hive 的 HQL 表达能力有限，迭代式算法和数据挖掘无法表达</li> <li>Hive 的效率比较低，自动生成 Mapreduce，执行速度慢；调优比较困难，粒度较粗</li></ul> <h3 id="hive-体系架构"><a href="#hive-体系架构" class="header-anchor">#</a> Hive 体系架构</h3> <p><img src="/images/kr/bigdata/hive/Hive-%E4%BD%93%E7%B3%BB%E6%9E%B6%E6%9E%84.jpg" alt="Hive-体系架构"></p> <ul><li>Hive Clients：Hive 客户端，为不同类型的应用程序提供不同的驱动，使得 Hive 可以通过类似 Java、Python 等语言连接，同时也提供了 JDBC/ODBC 驱动、CLI 命令行、WEBGUI</li> <li>Hive Services：Hive 服务端，客户端必须通过服务端与 Hive 交互：
<ul><li>用户接口组件(CLI/HiveServer/HWI)：分别以命令行、程序语言/驱动、WEBGUI 连接 Hive</li> <li><code>Driver</code>：包含解析器(Parser)、编译器(Complier)、优化器(Optimizer)和执行器(Executor)，作用是将 HQL 语句进行解析(词法分析/语法分析)、编译优化、生成执行计划，执行计划最终存储在 HDFS 中，然后调用 MapReduce 计算引擎执行
<ul><li>解析器(Parser)：将 HQL 解析成抽象语法树(AST)，并进行词法分析/语法分析</li> <li>编译器(Complier)：将 AST 编译生成逻辑执行计划</li> <li>优化器(Optimizer)：对逻辑执行计划进行优化</li> <li>执行器(Executor)：把逻辑执行计划转换成物理执行计划：MapReduce/Spark</li></ul></li> <li><code>Metastore</code>：元数据服务组件，存取 Hive 的元数据，Hive 的元数据存储在关系数据库里，Hive 支持关系数据库有 Derby/Mysql，元数据是对真实数据的描述</li></ul></li> <li>Hive Storage and Compute：包括元数据存储数据库和 Hadoop 集群，Hive 元数据存储在 RDBMS 中，Hive 数据存储在 HDFS 中，查询由 MapReduce 完成</li></ul> <h3 id="hql-编译过程"><a href="#hql-编译过程" class="header-anchor">#</a> HQL 编译过程</h3> <ul><li>词法/语法解析：Antlr 定义 SQL 的语法规则，完成 SQL 词法，语法解析，将 SQL 转化为抽象语法树 AST Tree</li> <li>语义解析：遍历 AST Tree，抽象出查询的基本组成单元 QueryBlock</li> <li>生成逻辑执行计划：遍历 QueryBlock，翻译为执行操作树 OperatorTree</li> <li>优化逻辑执行计划：逻辑层优化器进行 OperatorTree 变换，合并 Operator，达到减少 MapReduce Job，减少数据传输及 shuffle 数据量</li> <li>生成物理执行计划：遍历 OperatorTree，翻译为 MapReduce 任务</li> <li>优化物理执行计划：物理层优化器进行 MapReduce 任务的变换，生成最终的执行计划</li></ul> <h3 id="数据库-数据仓库"><a href="#数据库-数据仓库" class="header-anchor">#</a> 数据库/数据仓库</h3> <table><thead><tr><th style="text-align:center;"></th> <th style="text-align:center;">Hive</th> <th style="text-align:center;">MySql</th></tr></thead> <tbody><tr><td style="text-align:center;">数据存储位置</td> <td style="text-align:center;">HDFS</td> <td style="text-align:center;">本地磁盘</td></tr> <tr><td style="text-align:center;">数据格式</td> <td style="text-align:center;">用户定义</td> <td style="text-align:center;">系统决定</td></tr> <tr><td style="text-align:center;">数据更新</td> <td style="text-align:center;">不支持(不支持修改和删除)</td> <td style="text-align:center;">支持(支持增删改查)</td></tr> <tr><td style="text-align:center;">索引</td> <td style="text-align:center;">有，但较弱，一般很少用</td> <td style="text-align:center;">有，经常使用的</td></tr> <tr><td style="text-align:center;">执行</td> <td style="text-align:center;">MapReduce</td> <td style="text-align:center;">Executor</td></tr> <tr><td style="text-align:center;">执行延迟</td> <td style="text-align:center;">高</td> <td style="text-align:center;">低</td></tr> <tr><td style="text-align:center;">可扩展性</td> <td style="text-align:center;">高</td> <td style="text-align:center;">低</td></tr> <tr><td style="text-align:center;">数据规模</td> <td style="text-align:center;">大</td> <td style="text-align:center;">小</td></tr></tbody></table> <ul><li>数据库：传统的关系型数据库主要应用在基本的事务处理，支持增删改查操作</li> <li>数据仓库：主要做一些复杂的分析操作，侧重决策支持，只支持查询操作，不支持修改和删除</li></ul> <p>其实数据库与数据仓库的本质区别就是 OLTP 与 OLAP 的区别：</p> <ul><li>OLTP(On-Line Transaction Processing)：操作型处理，称为联机事务处理，是针对具体业务在数据库联机的日常操作，通常对少数记录进行查询、修改。用户较为关心操作的响应时间、数据的安全性、完整性等问题</li> <li>OLAP(On-Line Analytical Processing)：分析型处理，称为联机分析处理，一般针对某些主题历史数据进行分析，支持管理决策</li></ul> <h2 id="hive-部署"><a href="#hive-部署" class="header-anchor">#</a> Hive 部署</h2> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">create</span> <span class="token keyword">user</span> <span class="token string">'xzxHive'</span><span class="token variable">@'%'</span> identified <span class="token keyword">by</span> <span class="token string">'xzxHive'</span><span class="token punctuation">;</span>    <span class="token comment">-- 创建用户</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">grant</span> <span class="token keyword">all</span> <span class="token keyword">privileges</span> <span class="token keyword">on</span> xzx_hive<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">to</span> <span class="token string">'xzxHive'</span><span class="token variable">@'%'</span><span class="token punctuation">;</span>  <span class="token comment">-- 授权数据库 xzx_hive 的所有权限</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> grants <span class="token keyword">for</span> <span class="token string">'xzxHive'</span><span class="token variable">@'%'</span><span class="token punctuation">;</span>                        <span class="token comment">-- 查看用户授权信息</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">alter</span> <span class="token keyword">table</span> COLUMNS_V2 <span class="token keyword">modify</span> <span class="token keyword">column</span> <span class="token keyword">COMMENT</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">character</span> <span class="token keyword">set</span> utf8<span class="token punctuation">;</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">alter</span> <span class="token keyword">table</span> TABLE_PARAMS <span class="token keyword">modify</span> <span class="token keyword">column</span> PARAM_VALUE <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span> <span class="token keyword">character</span> <span class="token keyword">set</span> utf8<span class="token punctuation">;</span>
<span class="token comment">-- 若表创建了分区，还需修改：</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">alter</span> <span class="token keyword">table</span> PARTITION_PARAMS <span class="token keyword">modify</span> <span class="token keyword">column</span> PARAM_VALUE <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span> <span class="token keyword">character</span> <span class="token keyword">set</span> utf8<span class="token punctuation">;</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">alter</span> <span class="token keyword">table</span> PARTITION_KEYS <span class="token keyword">modify</span> <span class="token keyword">column</span> PKEY_COMMENT <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span> <span class="token keyword">character</span> <span class="token keyword">set</span> utf8<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><blockquote><p>Hive 数据库中表是 latin1 编码，对于表/字段的中文注释会出现乱码，需要将 Mysql 中相关的存储注释元数据的表修改为 UTF-8；
在 hive-site.xml 中参数 hive.metastore.warehouse.dir 配置着 default 默认数据库在 HDFS 上的存储路径，Hive 数据库及表在 HDFS
上以目录形式体现，表中的数据是存储在 HDFS 中，但是表的名称、字段信息是存储在 MetaStore 中。</p></blockquote> <h3 id="metastore"><a href="#metastore" class="header-anchor">#</a> Metastore</h3> <ul><li>Metadata：元数据包括表的属性、表的名称、表的列、分区及其属性以及表数据所在的目录等，由于元数据不断地修改、更新，所以 Hive 元数据不适合存储在 HDFS 中，一般存在 RDBMS 中</li> <li>Metastore：客户端连接 Metastore 服务，Metastore 再连接 MySQL 数据库来存取元数据，通过 Metastore 服务，多个客户端可以同时连接 Metastore 服务，而无需数据库凭据即可访问元数据存储库</li></ul> <p>配置参数：</p> <ul><li>hive.metastore.uris：远程元数据存储的 Thrift URI；若为空，则为本地模式，否则为远程模式</li> <li>javax.jdo.option.ConnectionURL：元数据存储的 JDBC 连接 URL</li> <li>javax.jdo.option.ConnectionDriverName：元数据存储的 JDBC 驱动类</li> <li>javax.jdo.option.ConnectionUserName：元数据存储数据库用户名</li> <li>javax.jdo.option.ConnectionPassword：元数据存储数据库密码</li> <li>hive.metastore.warehouse.dir：数据仓库存储位置</li></ul> <p>Hive Metastore 是无状态的，可通过多个实例实现高可用性；使用 hive.metastore.uris 可以指定多个远程 Metastore，Hive 将默认使用第一个，但会在连接失败时随机选择一个并尝试重新连接</p> <p>部署模式：</p> <p><em><strong>内嵌模式</strong></em>：默认情况下，Metastore 服务和以本地磁盘作为存储的 Derby 数据库服务运行在 Hive Service JVM 中</p> <p><img src="/images/kr/bigdata/hive/Embedded-Metastore.jpeg" alt="Embedded-Metastore"></p> <p>当开启多个 Hive Service JVM 时，每次只有一个内嵌的 Derby 数据库可以访问某个磁盘上的数据库文件，一次只能有一个进程可以连接到数据库，故适合单元测试，不适合生产环境</p> <p><em><strong>本地模式</strong></em>：MetaStore 服务运行在 Hive Service JVM 中，但连接同一台机器/远程机器上另一进程中的数据库服务，从而支持多会话多租户</p> <p><img src="/images/kr/bigdata/hive/Local-Metastore.jpeg" alt="Local-Metastore"></p> <p>在本地模式下不需要配置 hive.metastore.uris，默认为空表示是本地模式</p> <p><em><strong>远程模式</strong></em></p> <ul><li>在远程模式下，MetaStore 服务和 Hive 服务运行在不同进程中。</li> <li>CLI、HiveServer2、HCatalog、Impala 使用 Thrift API(hive.metastore.uris)与 Metastore 服务通信。</li> <li>Metastore 服务通过 JDBC 与 Metastore 数据库(javax.jdo.option.ConnectionURL)进行通信</li></ul> <p><img src="/images/kr/bigdata/hive/Remote-Matestore.jpeg" alt="Remote-Matestore"></p> <p>在这种情况下，可以单独部署 Metastore 服务器，以提高可用性，也可以有更好的可管理性/安全性，因为数据库层可以完全防火墙关闭。Hive 客户端不再需要通过数据库凭据即可访问元存储数据库</p> <h3 id="hiveserver2"><a href="#hiveserver2" class="header-anchor">#</a> HiveServer2</h3> <p>HiveServer2（HS2）允许远程客户端使用各种编程语言向 Hive 提交请求并检索结果，支持多客户端并发访问和身份验证。HS2 是由多个服务组成的单进程，其包括基于 Thrift 的 Hive 服务（TCP 或 HTTP）和用于 Web UI 的 Jetty Web 服务器。</p> <p>HiveServer2 拥有自己的 CLI(Beeline)，Beeline 是基于 SQL Line CLI 的 JDBC 客户端。Hive CLI 只能操作本地 Hive 服务，而 Beeline 可以通过 JDBC 连接远程服务，建议使用 Beeline 替代 Hive CLI。</p> <p>Beeline 基于 Hive JDBC，在使用 JDBC 访问 Hive 时，可能出现访问权限问题：</p> <div class="language-xml core-site.xml line-numbers-mode"><pre class="language-xml"><code><span class="token comment">&lt;!-- 赋予代理用户 xzx-hive.root 访问权限，解决 beeline 连接 hive 时访问 HDFS 的权限问题 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>hadoop.proxyuser.root.hosts<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>xzx-hive<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>hadoop.proxyuser.root.groups<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>*<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@xzx-hive /<span class="token punctuation">]</span><span class="token comment"># nohup hiveserver2 &amp;     # 开启 hiveserver2 服务，默认开启 10000 端口</span>
<span class="token comment"># -u：连接信息，-n：登录用户，-p：登录密码，-e：执行 sql</span>
beeline -u jdbc:hive2://localhost:10000 -n root -p root -e <span class="token string">'sql'</span>
<span class="token comment"># 进入 beeline 后，执行 beeline 管理命令需要在命令前加上“!”</span>
<span class="token operator">!</span>help   <span class="token comment"># 显示全部管理命令列表</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><blockquote><p>在 Hive 命令行中通过 set 命令临时设置参数值，即临时修改 hive-site.xml 中参数值，但只对当前会话有效，若要对当前机器上的当前用户有效，则把命令配置在 ~/.hiverc 文件中。
Hive 中历史命令会存储在当前用户目录下的 .hivehistory 目录中。</p></blockquote> <h3 id="配置文件"><a href="#配置文件" class="header-anchor">#</a> 配置文件</h3> <ul><li>hive-default.xml：Hive 默认配置文件</li> <li>hive-site.xml：Hive 用户自定义配置文件，会覆盖默认配置</li> <li>启动命令行时通过 --hiveconf 指定配置，作用于整个 Session</li> <li>交互环境下，使用 set 命令指定配置，作用于 Session，配置对于执行该命令后的所有命令生效</li></ul> <p>配置优先级（低到高）：hive-default.xml -&gt; hive-site.xml -&gt; --hiveconf -&gt; set</p> <div class="language-xml hive-site.xml line-numbers-mode"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;no&quot;?&gt;</span>
<span class="token prolog">&lt;?xml-stylesheet type=&quot;text/xsl&quot; href=&quot;configuration.xsl&quot;?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 注意：XML 文件中不能出现 &amp; 字符，需要使用转义字符 &amp;amp; --&gt;</span>
  <span class="token comment">&lt;!-- 配置 MySql 元数据存储数据库 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>javax.jdo.option.ConnectionURL<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>jdbc:mysql://192.168.72.1:3306/xzx_hive?createDatabaseIfNotExist=true<span class="token entity named-entity" title="&amp;">&amp;amp;</span>serverTimezone=Asia/Shanghai<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">&gt;</span></span>JDBC connect string for a JDBC metastore<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>javax.jdo.option.ConnectionDriverName<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>com.mysql.cj.jdbc.Driver<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">&gt;</span></span>Driver class name for a JDBC metastore<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>javax.jdo.option.ConnectionUserName<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>xzxHive<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">&gt;</span></span>username to use against metastore database<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>javax.jdo.option.ConnectionPassword<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>xzxHive<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">&gt;</span></span>password to use against metastore database<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>hive.metastore.uris<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>thrift://xzx-hive:9083<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">&gt;</span></span>远程模式：客户端连接 Metastore 服务，这里客户端和 Metastore 服务放在同一容器中<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>hive.server2.thrift.bind.host<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>xzx-hive<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">&gt;</span></span>HiveServer2 Thrift service host<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>hive.cli.print.header<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>hive.cli.print.current.db<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><h3 id="hive-镜像"><a href="#hive-镜像" class="header-anchor">#</a> Hive 镜像</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>FROM xzx/hadoop-3.2.2
RUN yum -y <span class="token function">install</span> <span class="token function">wget</span>
<span class="token comment"># 下载 Hive 并解压</span>
<span class="token comment"># -nv : wget 关闭详尽输出，但不进入安静模式</span>
<span class="token comment"># 不单独将 wget 当一行命令，因为下载下来的文件在容器中消失</span>
<span class="token comment"># &gt; /dev/null : 丢弃日志输出</span>
RUN <span class="token function">wget</span> -nv https://mirrors.bfsu.edu.cn/apache/hive/hive-3.1.2/apache-hive-3.1.2-bin.tar.gz <span class="token operator">&amp;&amp;</span> <span class="token punctuation">\</span>
        <span class="token function">tar</span> -zxvf apache-hive-3.1.2-bin.tar.gz -C /usr/local <span class="token operator">&gt;</span> /dev/null <span class="token operator">&amp;&amp;</span> <span class="token punctuation">\</span>
        <span class="token function">rm</span> apache-hive-3.1.2-bin.tar.gz <span class="token operator">&amp;&amp;</span> <span class="token punctuation">\</span>
        <span class="token function">mv</span> /usr/local/apache-hive-3.1.2-bin /usr/local/apache-hive-3.1.2
<span class="token comment"># 配置环境变量</span>
ENV HIVE_HOME /usr/local/apache-hive-3.1.2
<span class="token comment"># 将环境变量添加到系统变量中</span>
ENV <span class="token environment constant">PATH</span> <span class="token variable">$HIVE_HOME</span>/bin:<span class="token environment constant">$PATH</span>
<span class="token comment"># 配置</span>
RUN <span class="token function">cp</span> <span class="token variable">$HIVE_HOME</span>/conf/hive-env.sh.template <span class="token variable">$HIVE_HOME</span>/conf/hive-env.sh
RUN <span class="token function">cp</span> <span class="token variable">$HIVE_HOME</span>/conf/hive-default.xml.template <span class="token variable">$HIVE_HOME</span>/conf/hive-default.xml
COPY config/hive-site.xml <span class="token variable">$HIVE_HOME</span>/conf/hive-site.xml
COPY script/hiveservices.sh <span class="token variable">$HIVE_HOME</span>/bin/hiveservices.sh
<span class="token comment"># 解决与 hadoop 中日志 Jar 冲突</span>
RUN <span class="token function">mv</span> <span class="token variable">$HIVE_HOME</span>/lib/log4j-slf4j-impl-2.10.0.jar <span class="token variable">$HIVE_HOME</span>/lib/log4j-slf4j-impl-2.10.0.jar.bak 
<span class="token comment"># MySql 驱动</span>
COPY mysql-connector-java-8.0.21.jar <span class="token variable">$HIVE_HOME</span>/lib/
<span class="token comment"># 解决 guava 包版本问题</span>
RUN <span class="token function">rm</span> <span class="token variable">$HIVE_HOME</span>/lib/guava-19.0.jar
RUN <span class="token function">cp</span> <span class="token variable">$HADOOP_HOME</span>/share/hadoop/common/lib/guava-27.0-jre.jar <span class="token variable">$HIVE_HOME</span>/lib/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h3 id="启动容器并初始化"><a href="#启动容器并初始化" class="header-anchor">#</a> 启动容器并初始化</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">docker</span> run -itd --restart<span class="token operator">=</span>always --net<span class="token operator">=</span>xzx-hadoop-bridge --privileged <span class="token punctuation">\</span>
        -p <span class="token number">10000</span>:10000 <span class="token punctuation">\</span>
        --name xzx-hive <span class="token punctuation">\</span>
        --hostname xzx-hive <span class="token punctuation">\</span>
        xzx/hive-3.1.2 <span class="token punctuation">\</span>
        /bin/bash
<span class="token function">docker</span> <span class="token builtin class-name">exec</span> -it xzx-hive /bin/bash -c <span class="token string">'schematool -dbType mysql -initSchema'</span>  <span class="token comment"># 初始化 Hive Metastore</span>
<span class="token function">docker</span> <span class="token builtin class-name">exec</span> -it xzx-hive /bin/bash -c <span class="token string">'sh hiveservices.sh start'</span>    <span class="token comment"># 启动 Metastore/hiverserver2服务</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="language-sh  hiveservices.sh line-numbers-mode"><pre class="language-sh"><code><span class="token shebang important">#!/bin/bash</span>
<span class="token comment"># 该脚本用于启动 Metastore/hiveserver2 服务</span>
<span class="token assign-left variable">HIVE_LOG_DIR</span><span class="token operator">=</span>/usr/local/data/hive/serverLogs
<span class="token comment"># -d：判断 HIVE_LOG_DIR 是否为目录，!：取反</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -d <span class="token variable">$HIVE_LOG_DIR</span> <span class="token punctuation">]</span>
<span class="token keyword">then</span>
        <span class="token function">mkdir</span> -p <span class="token variable">$HIVE_LOG_DIR</span>
<span class="token keyword">fi</span>
<span class="token comment"># 2：错误输出，2&gt;/dev/null：将错误输出丢掉</span>
<span class="token comment"># grep -v grep：去除包含 grep 的进程行</span>
<span class="token comment"># grep：-v：显示不包含匹配文本的所有行；-i：忽略字符大小写的差别</span>
<span class="token comment"># awk：文本处理命令，print $2：输出第二域(列)</span>
<span class="token comment"># cut：将字符按(-d)分割并取(-f)位置的内容</span>
<span class="token comment"># 2&gt;&amp;1：表示将错误重定向到标准输出上</span>
<span class="token comment"># -z：字符串长度为零(即为 NULL)为真</span>
<span class="token comment"># eval：执行命令</span>
<span class="token comment"># |：管道运算符</span>
<span class="token comment"># ||：只有在 || 左边的命令返回假，|| 右边的命令才会被执行</span>
<span class="token comment"># &amp;&amp;：只有在 &amp;&amp; 左边的命令返回真，&amp;&amp; 右边的命令才会被执行</span>
<span class="token comment"># 检查进程是否运行正常，参数1为进程名，参数2为进程端口</span>
<span class="token keyword">function</span> <span class="token function-name function">check_process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token assign-left variable">pid</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">ps</span> -ef <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span>/dev/null <span class="token operator">|</span> <span class="token function">grep</span> -v <span class="token function">grep</span> <span class="token operator">|</span> <span class="token function">grep</span> -i $1 <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{print $2}'</span><span class="token variable">)</span></span>
        <span class="token assign-left variable">ppid</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">netstat</span> -nltp <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span>/dev/null <span class="token operator">|</span> <span class="token function">grep</span> $2 <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{print $7}'</span> <span class="token operator">|</span> <span class="token function">cut</span> -d <span class="token string">'/'</span> -f <span class="token number">1</span><span class="token variable">)</span></span>
        <span class="token builtin class-name">echo</span> <span class="token variable">$pid</span>
        <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token string">&quot;<span class="token variable">$pid</span>&quot;</span> <span class="token operator">=~</span> <span class="token string">&quot;<span class="token variable">$ppid</span>&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">[</span> <span class="token string">&quot;<span class="token variable">$ppid</span>&quot;</span> <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">return</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token builtin class-name">return</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
<span class="token comment"># 启动 Metastore/hiveserver2</span>
<span class="token keyword">function</span> <span class="token function-name function">hive_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token assign-left variable">metapid</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>check_process HiveMetastore <span class="token number">9083</span><span class="token variable">)</span></span>
        <span class="token assign-left variable">cmd</span><span class="token operator">=</span><span class="token string">&quot;nohup hive --service metastore &gt; <span class="token variable">$HIVE_LOG_DIR</span>/metastore.log 2&gt;&amp;1 &amp;&quot;</span>
        <span class="token punctuation">[</span> -z <span class="token string">&quot;<span class="token variable">$metapid</span>&quot;</span> <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">eval</span> <span class="token variable">$cmd</span> <span class="token operator">||</span> <span class="token builtin class-name">echo</span> <span class="token string">&quot;Metastore Server started!&quot;</span>
        <span class="token assign-left variable">server2pid</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>check_process HiveServer2 <span class="token number">10000</span><span class="token variable">)</span></span>
        <span class="token assign-left variable">cmd</span><span class="token operator">=</span><span class="token string">&quot;nohup hiveserver2 &gt; <span class="token variable">$HIVE_LOG_DIR</span>/hiveserver2.log 2&gt;&amp;1 &amp;&quot;</span>
        <span class="token punctuation">[</span> -z <span class="token string">&quot;<span class="token variable">$server2pid</span>&quot;</span> <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">eval</span> <span class="token variable">$cmd</span> <span class="token operator">||</span> <span class="token builtin class-name">echo</span> <span class="token string">&quot;HiveServer2 Server started!&quot;</span>
<span class="token punctuation">}</span>
<span class="token comment"># 停止 Metastore/hiveserver2</span>
<span class="token keyword">function</span> <span class="token function-name function">hive_stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token assign-left variable">metapid</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>check_process HiveMetastore <span class="token number">9083</span><span class="token variable">)</span></span>
        <span class="token punctuation">[</span> <span class="token string">&quot;<span class="token variable">$metapid</span>&quot;</span> <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token function">kill</span> <span class="token variable">$metapid</span> <span class="token operator">||</span> <span class="token builtin class-name">echo</span> <span class="token string">&quot;Metastore Server stoped!&quot;</span>
        <span class="token assign-left variable">server2pid</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>check_process HiveServer2 <span class="token number">10000</span><span class="token variable">)</span></span>
        <span class="token punctuation">[</span> <span class="token string">&quot;<span class="token variable">$server2pid</span>&quot;</span> <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token function">kill</span> <span class="token variable">$server2pid</span> <span class="token operator">||</span> <span class="token builtin class-name">echo</span> <span class="token string">&quot;HiveServer2 Server stoped!&quot;</span>
<span class="token punctuation">}</span>
<span class="token keyword">case</span> <span class="token variable">$1</span> <span class="token keyword">in</span>
        <span class="token string">&quot;start&quot;</span><span class="token punctuation">)</span>
        hive_start
        <span class="token punctuation">;</span><span class="token punctuation">;</span>
        <span class="token string">&quot;stop&quot;</span><span class="token punctuation">)</span>
        hive_stop
        <span class="token punctuation">;</span><span class="token punctuation">;</span>
        <span class="token string">&quot;restart&quot;</span><span class="token punctuation">)</span>
        hive_stop
        <span class="token function">sleep</span> <span class="token number">2</span>
        hive_start
        <span class="token punctuation">;</span><span class="token punctuation">;</span>
        <span class="token string">&quot;status&quot;</span><span class="token punctuation">)</span>
        check_process HiveMetastore <span class="token number">9083</span> <span class="token operator">&gt;</span> /dev/null <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">echo</span> <span class="token string">&quot;Metastore Server running!&quot;</span> <span class="token operator">||</span> <span class="token builtin class-name">echo</span> <span class="token string">&quot;Metastore Server error!&quot;</span>
        check_process HiveServer2 <span class="token number">10000</span> <span class="token operator">&gt;</span> /dev/null <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">echo</span> <span class="token string">&quot;HiveServer2 Server running!&quot;</span> <span class="token operator">||</span> <span class="token builtin class-name">echo</span> <span class="token string">&quot;HiveServer2 Server error!&quot;</span>
        <span class="token punctuation">;</span><span class="token punctuation">;</span>
        *<span class="token punctuation">)</span>
        <span class="token builtin class-name">echo</span> Invalid Args<span class="token operator">!</span>
        <span class="token builtin class-name">echo</span> <span class="token string">'Usage: '</span><span class="token variable"><span class="token variable">$(</span><span class="token function">basename</span> $0<span class="token variable">)</span></span><span class="token string">' start|stop|restart|status'</span>
        <span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token keyword">esac</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br></div></div><h2 id="hive-实战"><a href="#hive-实战" class="header-anchor">#</a> Hive 实战</h2> <h3 id="hive-数据类型"><a href="#hive-数据类型" class="header-anchor">#</a> Hive 数据类型</h3> <ul><li>Integers（整型）：
<ul><li>TINYINT （1 字节的有符号整数）</li> <li>SMALLINT（2 字节的有符号整数）</li> <li>INT（4 字节的有符号整数）</li> <li>BIGINT（8 字节的有符号整数）</li></ul></li> <li>Boolean（布尔型）：BOOLEAN（TRUE/FALSE）</li> <li>Floating point numbers（浮点型）：
<ul><li>FLOAT（单精度浮点型）</li> <li>DOUBLE（双精度浮点型）</li></ul></li> <li>Fixed point numbers（定点数）：DECIMAL（用户自定义精度定点数）</li> <li>String types（字符串）：
<ul><li>STRING（指定字符集的字符序列）</li> <li>VARCHAR（具有最大长度限制的字符序列）</li> <li>CHAR（固定长度的字符序列）</li></ul></li> <li>Date and time types（日期时间类型）：
<ul><li>TIMESTAMP（时间戳）：不做任何转换</li> <li>TIMESTAMP WITH LOCAL TIME ZONE（时间戳，纳秒精度）：用户提交时间给数据库时，会被转换成数据库所在的时区来保存。查询时则转换为查询客户端所在时区的时间</li> <li>DATE（日期类型）</li></ul></li> <li>Binary types（二进制类型）：BINARY（字节序列）</li></ul> <p>复杂类型：</p> <ul><li>STRUCT：类似对象，是字段集合，字段类型可以不同，可以使用（名称.字段名）方式进行访问</li> <li>MAP：键值对集合，可以使用（名称[key]）方式访问对应值</li> <li>ARRAY：数组，是一组具有相同类型和名称的变量集合，可以使用（名称[index]）访问对应值</li></ul> <p>隐式类型转换：</p> <ul><li>TINYINT -&gt; SMALLINT -&gt; INT -&gt; BIGINT -&gt; FLOAT -&gt; DOUBLE</li> <li>所有整型、FLOAT、STRING -&gt; BOOLEAN</li> <li>CAST：显示强制类型转换，若转换失败，表达式返回空值 NULL</li></ul> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> students<span class="token punctuation">(</span>
  name      STRING<span class="token punctuation">,</span>   <span class="token comment">-- 姓名</span>
  age       <span class="token keyword">INT</span><span class="token punctuation">,</span>      <span class="token comment">-- 年龄</span>
  subject   ARRAY<span class="token operator">&lt;</span>STRING<span class="token operator">&gt;</span><span class="token punctuation">,</span>   <span class="token comment">--学科</span>
  score     MAP<span class="token operator">&lt;</span>STRING<span class="token punctuation">,</span><span class="token keyword">FLOAT</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>  <span class="token comment">--各个学科考试成绩</span>
  address   STRUCT<span class="token operator">&lt;</span>houseNumber:<span class="token keyword">int</span><span class="token punctuation">,</span> street:STRING<span class="token punctuation">,</span> city:STRING<span class="token punctuation">,</span> province：STRING<span class="token operator">&gt;</span>  <span class="token comment">--家庭居住地址</span>
<span class="token punctuation">)</span> <span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED</span> <span class="token keyword">BY</span> <span class="token string">&quot;\t&quot;</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><blockquote><p>Map 比较灵活，但是会额外占用磁盘空间，因为比 Struct 多存储了数据的 key，
Struct 只需要存储 Value，比较节省空间，但是灵活性有限，后期无法动态增加 key/value</p></blockquote> <h3 id="ddl-数据定义"><a href="#ddl-数据定义" class="header-anchor">#</a> DDL 数据定义</h3> <p>DDL：数据定义语言，用于定义和管理数据库中的所有对象的语言</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 创建数据库</span>
<span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> <span class="token punctuation">[</span><span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span><span class="token punctuation">]</span> database_name <span class="token punctuation">[</span><span class="token keyword">COMMENT</span> database_comment<span class="token punctuation">]</span> <span class="token punctuation">[</span>LOCATION hdfs_path<span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token keyword">WITH</span> DBPROPERTIES <span class="token punctuation">(</span>property_name<span class="token operator">=</span>property_value<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>   <span class="token comment">-- 指定额外属性</span>
<span class="token keyword">show</span> <span class="token keyword">databases</span> <span class="token operator">like</span> <span class="token string">'db*'</span><span class="token punctuation">;</span>      <span class="token comment">-- 过滤查询数据库</span>
<span class="token keyword">desc</span> <span class="token keyword">database</span> <span class="token punctuation">[</span><span class="token keyword">extended</span><span class="token punctuation">]</span> db<span class="token punctuation">;</span>    <span class="token comment">-- 显示数据库信息，extended：是否显示额外属性</span>
<span class="token keyword">use</span> db<span class="token punctuation">;</span>
<span class="token keyword">alter</span> <span class="token keyword">database</span> db <span class="token keyword">set</span> dbproperties<span class="token punctuation">(</span>property_name<span class="token operator">=</span>property_value<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">-- 修改数据库属性信息</span>
<span class="token keyword">drop</span> <span class="token keyword">database</span> <span class="token punctuation">[</span><span class="token keyword">if</span> <span class="token keyword">exists</span><span class="token punctuation">]</span> db <span class="token punctuation">[</span><span class="token keyword">restrict</span><span class="token operator">|</span><span class="token keyword">cascade</span><span class="token punctuation">]</span><span class="token punctuation">;</span>   <span class="token comment">-- restrict：数据库中存在表则删除失败；cascade：级联删除数据库及表</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token punctuation">[</span><span class="token keyword">TEMPORARY</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>EXTERNAL<span class="token punctuation">]</span> <span class="token keyword">TABLE</span> <span class="token punctuation">[</span><span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span><span class="token punctuation">]</span> table_name    <span class="token comment">-- TEMPORARY：临时表，不支持分区；EXTERNAL：外部表</span>
<span class="token punctuation">[</span><span class="token punctuation">(</span>
  col_name data_type <span class="token punctuation">[</span><span class="token keyword">COMMENT</span> col_comment<span class="token punctuation">]</span><span class="token punctuation">,</span> 
  col_name array<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> <span class="token keyword">comment</span> <span class="token string">'array 数据类型'</span><span class="token punctuation">,</span>
  col_name map<span class="token operator">&lt;</span>string<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">&gt;</span> <span class="token keyword">comment</span> <span class="token string">'map 数据类型'</span><span class="token punctuation">,</span>
  col_name struct<span class="token operator">&lt;</span>col_name1:string<span class="token punctuation">,</span> col_name2:string<span class="token operator">&gt;</span> <span class="token keyword">comment</span> <span class="token string">'struct 数据类型'</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">)</span><span class="token punctuation">]</span> 
<span class="token punctuation">[</span><span class="token keyword">COMMENT</span> table_comment<span class="token punctuation">]</span> 
<span class="token punctuation">[</span>PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span>col_name data_type <span class="token punctuation">[</span><span class="token keyword">COMMENT</span> col_comment<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">]</span>  <span class="token comment">-- 分区表</span>
<span class="token comment">-- CLUSTERED BY：分桶表；SORTED BY：对桶中一个或多个列排序；按字段散列到 num_buckets 个 bucket 中</span>
<span class="token punctuation">[</span><span class="token keyword">CLUSTERED</span> <span class="token keyword">BY</span> <span class="token punctuation">(</span>col_name<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">[</span>SORTED <span class="token keyword">BY</span> <span class="token punctuation">(</span>col_name <span class="token punctuation">[</span><span class="token keyword">ASC</span><span class="token operator">|</span><span class="token keyword">DESC</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token keyword">INTO</span> num_buckets BUCKETS<span class="token punctuation">]</span>
<span class="token comment">-- 倾斜表，指定倾斜列和值</span>
<span class="token punctuation">[</span>SKEWED <span class="token keyword">BY</span> <span class="token punctuation">(</span>col_name<span class="token punctuation">,</span> col_name<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token keyword">ON</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>col_value<span class="token punctuation">,</span> col_value<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">[</span>STORED <span class="token keyword">AS</span> DIRECTORIES<span class="token punctuation">]</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token keyword">ROW</span> FORMAT row_format<span class="token punctuation">]</span>                                           <span class="token comment">-- 指定行格式</span>
<span class="token punctuation">[</span><span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED</span> <span class="token keyword">BY</span> <span class="token string">'\t'</span><span class="token punctuation">]</span>                                       <span class="token comment">-- 指定列分隔符</span>
<span class="token punctuation">[</span><span class="token keyword">LINES</span> <span class="token keyword">TERMINATED</span> <span class="token keyword">BY</span> <span class="token string">'\n'</span><span class="token punctuation">]</span>                                        <span class="token comment">-- 行分隔符，只能放在列分隔符后</span>
<span class="token punctuation">[</span>COLLECTION ITEMS <span class="token keyword">TERMINATED</span> <span class="token keyword">BY</span> <span class="token string">','</span><span class="token punctuation">]</span>                              <span class="token comment">-- 指定 array/map/struct 元素分隔符</span>
<span class="token punctuation">[</span>MAP <span class="token keyword">KEYS</span> <span class="token keyword">TERMINATED</span> <span class="token keyword">BY</span> <span class="token string">':'</span><span class="token punctuation">]</span>                                      <span class="token comment">-- 指定 map 的 key/value 间分隔符</span>
<span class="token punctuation">[</span>STORED <span class="token keyword">AS</span> file_format<span class="token punctuation">]</span>                                           <span class="token comment">-- 指定存储文件类型</span>
<span class="token punctuation">[</span>LOCATION hdfs_path<span class="token punctuation">]</span>                                              <span class="token comment">-- 指定表在 HDFS 上的存储位置</span>
<span class="token punctuation">[</span>TBLPROPERTIES <span class="token punctuation">(</span>property_name<span class="token operator">=</span>property_value<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">]</span>               <span class="token comment">-- 表额外属性</span>
<span class="token punctuation">[</span><span class="token keyword">AS</span> select_statement<span class="token punctuation">]</span>                                             <span class="token comment">-- AS：后跟查询语句，根据查询结果创建表</span>
<span class="token punctuation">[</span><span class="token operator">LIKE</span> table_name2<span class="token punctuation">]</span><span class="token punctuation">;</span>                                               <span class="token comment">-- 根据已有表结构创建表</span>

<span class="token keyword">show</span> <span class="token keyword">tables</span> <span class="token punctuation">[</span><span class="token operator">IN</span> database_name<span class="token punctuation">]</span><span class="token punctuation">;</span>                                   <span class="token comment">-- 显示数据库数据表</span>
<span class="token keyword">show</span> views <span class="token punctuation">[</span><span class="token operator">IN</span><span class="token operator">/</span><span class="token keyword">FROM</span> database_name<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">LIKE</span> <span class="token string">''</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                     <span class="token comment">-- 视图列表</span>
<span class="token keyword">show</span> partitions table_name<span class="token punctuation">;</span>                                       <span class="token comment">-- 查询表的分区信息</span>
<span class="token keyword">show</span> <span class="token keyword">create</span> <span class="token keyword">table</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>db_name<span class="token punctuation">.</span><span class="token punctuation">]</span>table_name<span class="token operator">|</span>view_name<span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">-- 查看表/视图的创建语句</span>
<span class="token keyword">desc</span> <span class="token punctuation">[</span><span class="token keyword">EXTENDED</span><span class="token operator">|</span>FORMATTED<span class="token punctuation">]</span> table_name<span class="token punctuation">;</span>                             <span class="token comment">-- 查询表结构</span>
<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token punctuation">[</span><span class="token keyword">IF</span> <span class="token keyword">EXISTS</span><span class="token punctuation">]</span> table_name <span class="token punctuation">[</span><span class="token keyword">PURGE</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                        <span class="token comment">-- 删除表</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> table_name <span class="token keyword">set</span> tblproperties<span class="token punctuation">(</span><span class="token string">'EXTERNAL'</span><span class="token operator">=</span><span class="token string">'TRUE'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">-- 内部表改为外部表</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> table_name <span class="token keyword">set</span> tblproperties<span class="token punctuation">(</span><span class="token string">'EXTERNAL'</span><span class="token operator">=</span><span class="token string">'FALSE'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">-- 外部表改为内部表</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> table_name <span class="token keyword">rename</span> <span class="token keyword">to</span> table_name2<span class="token punctuation">;</span>                     <span class="token comment">-- 重命名表</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> table_name <span class="token punctuation">[</span><span class="token keyword">PARTITION</span> partition_spec<span class="token punctuation">]</span> CHANGE <span class="token punctuation">[</span><span class="token keyword">column</span><span class="token punctuation">]</span> col_old_name col_new_name column_type 
<span class="token punctuation">[</span><span class="token keyword">COMMENT</span> col_comment<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token keyword">FIRST</span><span class="token operator">|</span><span class="token keyword">AFTER</span> colume_name<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token keyword">CASCADE</span><span class="token operator">|</span><span class="token keyword">RESTRICT</span><span class="token punctuation">]</span><span class="token punctuation">;</span>           <span class="token comment">-- 更新列</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> table_name <span class="token keyword">ADD</span><span class="token operator">|</span><span class="token keyword">REPLACE</span> <span class="token keyword">COLUMNS</span> <span class="token punctuation">(</span>col_name data_type <span class="token punctuation">[</span><span class="token keyword">COMMENT</span> col_comment<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">-- 新增/替换列</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> table_name <span class="token keyword">add</span><span class="token operator">|</span><span class="token keyword">drop</span> <span class="token keyword">partition</span><span class="token punctuation">(</span>partcol_name<span class="token operator">=</span>partcol_value<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">-- 添加/删除分区</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><h3 id="dml-数据操作"><a href="#dml-数据操作" class="header-anchor">#</a> DML 数据操作</h3> <p>DML：数据操作语言，SQL 中处理数据等操作统称为数据操作语言</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 向表中加载数据，加载文件的格式必须与建表时使用 STORED AS 指定的存储格式相同</span>
<span class="token keyword">load</span> <span class="token keyword">data</span> <span class="token punctuation">[</span><span class="token keyword">local</span><span class="token punctuation">]</span> inpath <span class="token string">'path'</span>                     <span class="token comment">-- local：从本地加载数据，否则从 HDFS 加载数据且文件是直接移动</span>
<span class="token punctuation">[</span>overwrite<span class="token punctuation">]</span> <span class="token keyword">into</span> <span class="token keyword">table</span> table_name                   <span class="token comment">-- overwrite：覆盖表/分区中已有数据，否则追加</span>
<span class="token punctuation">[</span><span class="token keyword">partition</span> <span class="token punctuation">(</span>partcol_name<span class="token operator">=</span>partcol_value<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>      <span class="token comment">-- 若是分区表，显示指定数据所在分区</span>

<span class="token comment">-- 查询结果插入到表</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span><span class="token operator">|</span>overwrite <span class="token keyword">table</span> table_name              <span class="token comment">-- into：追加；overwrite：覆盖</span>
<span class="token punctuation">[</span><span class="token keyword">partition</span> <span class="token punctuation">(</span>partcol_name<span class="token operator">=</span>partcol_value<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token keyword">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>select_statement<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token keyword">table</span> table_name <span class="token keyword">from</span> <span class="token string">'path'</span><span class="token punctuation">;</span>                <span class="token comment">-- 从指定 HDFS 路径导入数据到 Hive 表</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">insert</span> overwrite <span class="token punctuation">[</span><span class="token keyword">local</span><span class="token punctuation">]</span> directory <span class="token string">'path'</span>           <span class="token comment">-- local：导出本地，否则导出 HDFS</span>
<span class="token punctuation">[</span><span class="token keyword">row</span> format delimited <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">'\t'</span><span class="token punctuation">]</span>    <span class="token comment">-- 格式化导出</span>
select_statement<span class="token punctuation">;</span>                                   <span class="token comment">-- 导出查询结果</span>
export <span class="token keyword">table</span> table_name <span class="token keyword">to</span> <span class="token string">'path'</span><span class="token punctuation">;</span>                  <span class="token comment">-- 从指定 Hive 表导出数据到 HDFS</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 清空整个表或表指定分区中的数据，只有内部表才能执行 TRUNCATE 操作</span>
<span class="token keyword">truncate</span> <span class="token keyword">table</span> table_name <span class="token punctuation">[</span><span class="token keyword">PARTITION</span> <span class="token punctuation">(</span>partition_column <span class="token operator">=</span> partition_col_value<span class="token punctuation">,</span>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token punctuation">[</span><span class="token keyword">ALL</span> <span class="token operator">|</span> <span class="token keyword">DISTINCT</span><span class="token punctuation">]</span> select_expr<span class="token punctuation">,</span> select_expr<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                 <span class="token comment">-- DISTINCT：去重</span>
<span class="token keyword">FROM</span> table_reference <span class="token punctuation">[</span><span class="token keyword">INNER</span> <span class="token keyword">JOIN</span><span class="token operator">|</span><span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span><span class="token operator">|</span><span class="token keyword">RIGHT</span> <span class="token keyword">JOIN</span><span class="token operator">|</span><span class="token keyword">LEFT</span> SEMI <span class="token keyword">JOIN</span><span class="token operator">|</span><span class="token keyword">JOIN</span> t <span class="token keyword">on</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token keyword">WHERE</span> where_condition<span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token keyword">GROUP</span> <span class="token keyword">BY</span> col_list <span class="token punctuation">[</span><span class="token keyword">HAVING</span> condition<span class="token punctuation">]</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> col_list<span class="token punctuation">]</span>   <span class="token comment">-- 会有一个 Reducer 对全部查询结果进行排序，可以保证数据的全局有序性</span>
<span class="token punctuation">[</span>CLUSTER <span class="token keyword">BY</span> col_list 
  <span class="token operator">|</span> <span class="token punctuation">[</span>DISTRIBUTE <span class="token keyword">BY</span> col_list<span class="token punctuation">]</span> <span class="token punctuation">[</span>SORT <span class="token keyword">BY</span> <span class="token operator">|</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> col_list<span class="token punctuation">]</span>
<span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token keyword">LIMIT</span> number<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="hive-表类型"><a href="#hive-表类型" class="header-anchor">#</a> Hive 表类型</h3> <ul><li>内部表：
<ul><li>也称受控表(管理表)，默认表类型，表数据默认存储在 warehouse 目录中</li> <li>使用 load 加载数据时，数据会被加载到 warehouse 中表对应目录</li> <li>删除表时，表中的数据和元数据将会被同时删除</li></ul></li> <li>外部表：建表语句中包含 External 的表叫外部表
<ul><li>外部表在加载数据时，实际数据并不会移动到 warehouse 目录中，只是与外部数据建立一个链接(映射关系)</li> <li>表的定义和数据的生命周期互相不约束，数据只是表对 HDFS 上某个目录的引用</li> <li>当删除表定义时，数据依然是存在，仅删除表和数据之间引用关系及表元数据，所以这种表是比较安全的，误删但数据没丢</li></ul></li> <li>分区表：提供了一个隔离数据和优化查询的可行方案，Hive 会限制动态分区可以创建的最大分区数
<ul><li>Hive 表对应 HDFS 指定目录，通过分区字段（可多个）把不同类型的数据放到不同目录中</li> <li>通过分区条件优化查询，而不是扫描整个表目录，合理分区设计可以极大提高查询速度和性能</li> <li>使用 PARTITIONED BY 子句创建分区表，加载数据到分区表时候必须要指定数据所处的分区</li></ul></li> <li>分桶表：bucket Table，一种更加细粒度的数据拆分方案，物理上每个桶就是表/分区里的一个文件
<ul><li>针对数据倾斜(数据存储不均匀)问题，可以采用分桶概念解决</li> <li>分桶规则：分桶表将指定列的值进行哈希散列并对桶数取余，然后存储到对应的桶(文件)中</li> <li>通过 CLUSTERED BY 指定分桶列，并通过 SORTED BY 指定桶中数据的排序参考列</li> <li>直接使用 Load 语句向分桶表加载数据，数据是可以加载成功的，但是数据并不会分桶</li> <li>向分桶表中插入数据是必然要通过 MapReduce，且 Reducer 数量必须等于分桶数量</li> <li>分桶表的数据通常只能使用 CTAS(CREATE TABLE AS SELECT) 方式插入，因为 CTAS 操作会触发 MapReduce</li></ul></li></ul> <blockquote><p>分区针对的是数据的存储路径，提供了一个隔离数据和优化查询的可行方案；</p> <p>而分桶针对的是数据文件，提供了一种更加细粒度的数据拆分方案。</p></blockquote> <h3 id="hive-视图"><a href="#hive-视图" class="header-anchor">#</a> Hive 视图</h3> <p>Hive 视图是一组数据的逻辑表示，本质上就是一条 SELECT 语句的结果集。</p> <p>视图是纯粹的逻辑对象，没有关联的存储 (Hive 3.0.0 引入的物化视图除外)，当查询引用视图时，Hive 可以将视图的定义与查询结合起来，例如将查询中的过滤器推送到视图中。</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 通过 create view 命令创建视图，视图在 /user/hive/warehouse 中是不存在的，因为它只是一个虚拟逻辑表</span>
<span class="token keyword">CREATE</span> <span class="token keyword">VIEW</span> <span class="token punctuation">[</span><span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>db_name<span class="token punctuation">.</span><span class="token punctuation">]</span>view_name           <span class="token comment">-- 视图名称</span>
  <span class="token punctuation">[</span><span class="token punctuation">(</span>column_name <span class="token punctuation">[</span><span class="token keyword">COMMENT</span> column_comment<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">]</span>          <span class="token comment">-- 列名</span>
  <span class="token punctuation">[</span><span class="token keyword">COMMENT</span> view_comment<span class="token punctuation">]</span>                                  <span class="token comment">-- 视图注释</span>
  <span class="token punctuation">[</span>TBLPROPERTIES <span class="token punctuation">(</span>property_name <span class="token operator">=</span> property_value<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">]</span>   <span class="token comment">-- 额外信息</span>
  <span class="token keyword">AS</span> <span class="token keyword">SELECT</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
<span class="token keyword">desc</span> view_name<span class="token punctuation">;</span>                                           <span class="token comment">-- 查看某个视图</span>
<span class="token keyword">desc</span> formatted view_name<span class="token punctuation">;</span>                                 <span class="token comment">-- 查看某个视图详细信息</span>
<span class="token keyword">DROP</span> <span class="token keyword">VIEW</span> <span class="token punctuation">[</span><span class="token keyword">IF</span> <span class="token keyword">EXISTS</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>db_name<span class="token punctuation">.</span><span class="token punctuation">]</span>view_name<span class="token punctuation">;</span>                <span class="token comment">-- 删除视图</span>
<span class="token keyword">ALTER</span> <span class="token keyword">VIEW</span> <span class="token punctuation">[</span>db_name<span class="token punctuation">.</span><span class="token punctuation">]</span>view_name <span class="token keyword">AS</span> select_statement<span class="token punctuation">;</span>       <span class="token comment">-- 修改视图（存在且不能有分区）</span>
<span class="token keyword">ALTER</span> <span class="token keyword">VIEW</span> <span class="token punctuation">[</span>db_name<span class="token punctuation">.</span><span class="token punctuation">]</span>view_name <span class="token keyword">SET</span> TBLPROPERTIES <span class="token punctuation">(</span>property_name <span class="token operator">=</span> property_value<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">-- 修改视图属性</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><ul><li>视图是只读的，不能用作 LOAD / INSERT / ALTER 的目标</li> <li>在创建视图时视图就已经固定，对基表的后续更改（如添加列）将不会反映在视图种</li> <li>删除基表并不会删除视图，需要手动删除视图</li> <li>视图可能包含 ORDER BY 和 LIMIT 子句；如果引用视图的查询语句也包含这类子句，其执行优先级低于视图对应子句</li> <li>创建视图时，如果未提供列名，则将从 SELECT 语句中自动派生列名</li> <li>创建视图时，如果 SELECT 语句中包含其他表达式，则列名称将以_C0，_C1 等形式生成</li></ul> <h3 id="动态分区"><a href="#动态分区" class="header-anchor">#</a> 动态分区</h3> <p>关系型数据库中，对分区表 Insert 时，数据库自动会根据分区字段的值，将数据插入到相应的分区中，Hive 中也提供了类似的机制，即动态分区 (Dynamic Partition)，参数：</p> <ul><li>hive.exec.dynamic.partition=true：开启动态分区功能，默认开启</li> <li>hive.exec.dynamic.partition.mode=nonstrict：动态分区模式，默认 strict，表示必须指定至少一个分区为静态分区，nonstrict：表示允许所有分区字段都可以使用动态分区</li> <li>hive.exec.max.dynamic.partitions=1000：在所有执行 MR 节点上，最大一共可以创建多少个动态分区</li> <li>hive.exec.max.dynamic.partitions.pernode=100：在每个执行 MR 节点上，最大可以创建多少个动态分区</li> <li>hive.exec.max.created.files=100000：整个 MR 中，最大可以创建多少个 HDFS 文件</li> <li>hive.error.on.empty.partition=false：当有空分区生成时，是否抛出异常</li></ul> <h3 id="hive-索引-3-0后被移除"><a href="#hive-索引-3-0后被移除" class="header-anchor">#</a> Hive 索引(3.0后被移除)</h3> <p>索引原理：在指定列上建立索引，会产生一张索引表（表结构如下），里面的字段包括：索引列的值、该值对应的 HDFS 文件路径、该值在文件中的偏移量。在查询涉及到索引字段时，首先到索引表查找索引列值对应的 HDFS 文件路径及偏移量，这样就避免了全表扫描</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>+--------------+----------------+----------+--+
|   col_name   |   data_type    | comment     |
+--------------+----------------+----------+--+
| empno        | int            |  建立索引的列  |   
| _bucketname  | string         |  HDFS 文件路径  |
| _offsets     | array&lt;bigint&gt;  |  偏移量       |
+--------------+----------------+----------+--+
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> index_name                                <span class="token comment">-- 索引名称</span>
  <span class="token keyword">ON</span> <span class="token keyword">TABLE</span> base_table_name <span class="token punctuation">(</span>col_name<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>             <span class="token comment">-- 建立索引的列</span>
  <span class="token keyword">AS</span> index_type                                        <span class="token comment">-- 索引类型</span>
  <span class="token punctuation">[</span><span class="token keyword">WITH</span> DEFERRED REBUILD<span class="token punctuation">]</span>                              <span class="token comment">-- 重建索引</span>
  <span class="token punctuation">[</span>IDXPROPERTIES <span class="token punctuation">(</span>property_name<span class="token operator">=</span>property_value<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">]</span>  <span class="token comment">-- 索引额外属性</span>
  <span class="token punctuation">[</span><span class="token operator">IN</span> <span class="token keyword">TABLE</span> index_table_name<span class="token punctuation">]</span>                          <span class="token comment">-- 索引表的名字</span>
  <span class="token punctuation">[</span>
     <span class="token punctuation">[</span> <span class="token keyword">ROW</span> FORMAT <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span> STORED <span class="token keyword">AS</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  
     <span class="token operator">|</span> STORED <span class="token keyword">BY</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">]</span>                                                    <span class="token comment">-- 索引表行分隔符、存储格式</span>
  <span class="token punctuation">[</span>LOCATION hdfs_path<span class="token punctuation">]</span>                                 <span class="token comment">-- 索引表存储位置</span>
  <span class="token punctuation">[</span>TBLPROPERTIES <span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">]</span>                                <span class="token comment">-- 索引表表属性</span>
  <span class="token punctuation">[</span><span class="token keyword">COMMENT</span> <span class="token string">&quot;index comment&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                           <span class="token comment">-- 索引注释</span>
<span class="token keyword">SHOW</span> FORMATTED <span class="token keyword">INDEX</span> <span class="token keyword">ON</span> table_name<span class="token punctuation">;</span>                    <span class="token comment">-- 显示表上所有列的索引</span>

<span class="token comment">-- 如果存在索引的表被删除了，其对应的索引和索引表都会被删除</span>
<span class="token comment">-- 如果被索引表的某个分区被删除了，那么分区对应的分区索引也会被删除</span>
<span class="token keyword">DROP</span> <span class="token keyword">INDEX</span> <span class="token punctuation">[</span><span class="token keyword">IF</span> <span class="token keyword">EXISTS</span><span class="token punctuation">]</span> index_name <span class="token keyword">ON</span> table_name<span class="token punctuation">;</span>       <span class="token comment">-- 删除索引会删除对应的索引表</span>
<span class="token comment">-- 重建索引，如果指定了 PARTITION，则仅重建该分区的索引，Hive 会启动 MapReduce 作业去建立索引</span>
<span class="token keyword">ALTER</span> <span class="token keyword">INDEX</span> index_name <span class="token keyword">ON</span> table_name <span class="token punctuation">[</span><span class="token keyword">PARTITION</span> partition_spec<span class="token punctuation">]</span> REBUILD<span class="token punctuation">;</span>

<span class="token comment">-- 默认情况下，虽然建立了索引，但是 Hive 在查询时是不会自动去使用索引的</span>
<span class="token comment">-- 需要开启相关配置，开启配置后，涉及到索引列的查询就会使用索引功能去优化查询</span>
<span class="token keyword">SET</span> hive<span class="token punctuation">.</span>input<span class="token punctuation">.</span>format<span class="token operator">=</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>hive<span class="token punctuation">.</span>ql<span class="token punctuation">.</span>io<span class="token punctuation">.</span>HiveInputFormat<span class="token punctuation">;</span>
<span class="token keyword">SET</span> hive<span class="token punctuation">.</span><span class="token keyword">optimize</span><span class="token punctuation">.</span><span class="token keyword">index</span><span class="token punctuation">.</span>filter<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token keyword">SET</span> hive<span class="token punctuation">.</span><span class="token keyword">optimize</span><span class="token punctuation">.</span><span class="token keyword">index</span><span class="token punctuation">.</span>filter<span class="token punctuation">.</span>compact<span class="token punctuation">.</span>minsize<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>索引表最主要的一个缺陷在于：索引表无法自动 rebuild，即如果表中有数据新增或删除，则必须手动 rebuild，重新执行 MapReduce 作业，生成索引表数据。</p> <p>Hive 会从 3.0 开始移除索引功能，主要基于以下两个原因：</p> <ul><li>具有自动重写的物化视图 (Materialized View) 可以产生与索引相似的效果（Hive 2.3.0 增加了对物化视图的支持，在 3.0 之后正式引入）</li> <li>使用列式存储文件格式（Parquet，ORC）进行存储时，这些格式支持选择性扫描，可以跳过不需要的文件或块</li></ul> <h3 id="数据抽样"><a href="#数据抽样" class="header-anchor">#</a> 数据抽样</h3> <p>对于非常大的数据集，有时需要使用一个具有代表性的查询结果而不是全部结果，来加快数据分析效率，有三种方式来进行抽样：</p> <ul><li>随机抽样：使用 rand() 函数进行随机抽样，limit 关键字限制抽样返回的数据，其中 rand 函数前的 distribute 和 sort 关键字可以保证数据在 mapper 和 reducer 阶段是随机分布的</li></ul> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> table_name <span class="token keyword">where</span> col <span class="token operator">=</span> xxx distribute <span class="token keyword">by</span> rand<span class="token punctuation">(</span><span class="token punctuation">)</span> sort <span class="token keyword">by</span> rand<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">limit</span> num<span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> table_name <span class="token keyword">where</span> col <span class="token operator">=</span> xxx <span class="token keyword">order</span> <span class="token keyword">by</span> rand<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">limit</span> num<span class="token punctuation">;</span>   <span class="token comment">-- 使用 Order By 方式较耗时</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>分桶抽样</li></ul> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- x 代表从当前的第几桶(桶编号，1 开始)开始抽样</span>
<span class="token comment">-- y 表示是每间隔几桶抽一桶，尽可能是桶表的 bucket 数的倍数或者因子，而且 y &gt;= x &gt; 0</span>
<span class="token comment">-- 分桶抽样：从第 x 桶开始抽，当 y&lt;=z 每间隔 y 桶抽一桶，直到抽满 z/y(代表一共抽多少桶) 桶</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> bucket_tb tablesample<span class="token punctuation">(</span>bucket x <span class="token keyword">out</span> <span class="token keyword">of</span> y <span class="token punctuation">[</span><span class="token keyword">on</span> bucket_column<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><blockquote><p>在实际工作中，Hive 中创建的表 95% 以上的都是外部表，通过 Flume 采集数据，把数据上传到 HDFS 中，然后在 Hive 中创建外部表和 HDFS 上的数据绑定关系，就可以查询数据了，所以连 load 步骤都可以省略，因为是先有数据，才创建的表</p></blockquote> <ul><li>块抽样
<ul><li>tablesample(n percent)：根据 hive 表数据大小按比例抽取数据，并保存到新的表中</li> <li>tablesample(nM)：指定抽样数据的大小，单位为 M</li> <li>tablesample(n rows)：指定抽样数据的行数，其中 n 代表每个 map 任务均取 n 行数据</li></ul></li></ul> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> xxx tablesample<span class="token punctuation">(</span><span class="token number">10</span> <span class="token keyword">percent</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> xxx tablesample<span class="token punctuation">(</span><span class="token number">20</span>M<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> xxx tablesample<span class="token punctuation">(</span><span class="token number">100</span> <span class="token keyword">rows</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">2022/6/8</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/kr/bigdata/hadoop/大数据生态圈与离线实时数据平台实践.html" class="prev">
          大数据生态圈与离线实时数据平台实践
        </a></span> <span class="next"><a href="/kr/bigdata/hive/Hive-SQL.html">
          Hive SQL 执行计划|数据倾斜|性能优化
        </a>
        →
      </span></p></div> </main></div> <aside class="page-sidebar"> <div class="page-side-toolbar"><div class="option-box-toc-fixed"><div class="toc-container-sidebar"><div class="pos-box"><div class="icon-arrow"></div> <div class="scroll-box" style="max-height:650px"><div style="font-weight:bold;text-align:center;">分布式数据仓库 Hive</div> <hr> <div class="toc-box"><ul class="toc-sidebar-links"><li><a href="/kr/bigdata/hive/%E5%88%86%E5%B8%83%E5%BC%8F%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93-Hive.html#hive-概述" class="toc-sidebar-link">Hive 概述</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/kr/bigdata/hive/%E5%88%86%E5%B8%83%E5%BC%8F%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93-Hive.html#hive-优缺点" class="toc-sidebar-link">Hive 优缺点</a></li><li class="toc-sidebar-sub-header"><a href="/kr/bigdata/hive/%E5%88%86%E5%B8%83%E5%BC%8F%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93-Hive.html#hive-体系架构" class="toc-sidebar-link">Hive 体系架构</a></li><li class="toc-sidebar-sub-header"><a href="/kr/bigdata/hive/%E5%88%86%E5%B8%83%E5%BC%8F%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93-Hive.html#hql-编译过程" class="toc-sidebar-link">HQL 编译过程</a></li><li class="toc-sidebar-sub-header"><a href="/kr/bigdata/hive/%E5%88%86%E5%B8%83%E5%BC%8F%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93-Hive.html#数据库-数据仓库" class="toc-sidebar-link">数据库/数据仓库</a></li></ul></li><li><a href="/kr/bigdata/hive/%E5%88%86%E5%B8%83%E5%BC%8F%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93-Hive.html#hive-部署" class="toc-sidebar-link">Hive 部署</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/kr/bigdata/hive/%E5%88%86%E5%B8%83%E5%BC%8F%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93-Hive.html#metastore" class="toc-sidebar-link">Metastore</a></li><li class="toc-sidebar-sub-header"><a href="/kr/bigdata/hive/%E5%88%86%E5%B8%83%E5%BC%8F%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93-Hive.html#hiveserver2" class="toc-sidebar-link">HiveServer2</a></li><li class="toc-sidebar-sub-header"><a href="/kr/bigdata/hive/%E5%88%86%E5%B8%83%E5%BC%8F%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93-Hive.html#配置文件" class="toc-sidebar-link">配置文件</a></li><li class="toc-sidebar-sub-header"><a href="/kr/bigdata/hive/%E5%88%86%E5%B8%83%E5%BC%8F%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93-Hive.html#hive-镜像" class="toc-sidebar-link">Hive 镜像</a></li><li class="toc-sidebar-sub-header"><a href="/kr/bigdata/hive/%E5%88%86%E5%B8%83%E5%BC%8F%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93-Hive.html#启动容器并初始化" class="toc-sidebar-link">启动容器并初始化</a></li></ul></li><li><a href="/kr/bigdata/hive/%E5%88%86%E5%B8%83%E5%BC%8F%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93-Hive.html#hive-实战" class="toc-sidebar-link">Hive 实战</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/kr/bigdata/hive/%E5%88%86%E5%B8%83%E5%BC%8F%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93-Hive.html#hive-数据类型" class="toc-sidebar-link">Hive 数据类型</a></li><li class="toc-sidebar-sub-header"><a href="/kr/bigdata/hive/%E5%88%86%E5%B8%83%E5%BC%8F%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93-Hive.html#ddl-数据定义" class="toc-sidebar-link">DDL 数据定义</a></li><li class="toc-sidebar-sub-header"><a href="/kr/bigdata/hive/%E5%88%86%E5%B8%83%E5%BC%8F%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93-Hive.html#dml-数据操作" class="toc-sidebar-link">DML 数据操作</a></li><li class="toc-sidebar-sub-header"><a href="/kr/bigdata/hive/%E5%88%86%E5%B8%83%E5%BC%8F%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93-Hive.html#hive-表类型" class="toc-sidebar-link">Hive 表类型</a></li><li class="toc-sidebar-sub-header"><a href="/kr/bigdata/hive/%E5%88%86%E5%B8%83%E5%BC%8F%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93-Hive.html#hive-视图" class="toc-sidebar-link">Hive 视图</a></li><li class="toc-sidebar-sub-header"><a href="/kr/bigdata/hive/%E5%88%86%E5%B8%83%E5%BC%8F%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93-Hive.html#动态分区" class="toc-sidebar-link">动态分区</a></li><li class="toc-sidebar-sub-header"><a href="/kr/bigdata/hive/%E5%88%86%E5%B8%83%E5%BC%8F%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93-Hive.html#hive-索引-3-0后被移除" class="toc-sidebar-link">Hive 索引(3.0后被移除)</a></li><li class="toc-sidebar-sub-header"><a href="/kr/bigdata/hive/%E5%88%86%E5%B8%83%E5%BC%8F%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93-Hive.html#数据抽样" class="toc-sidebar-link">数据抽样</a></li></ul></li></ul></div></div></div></div></div> <div class="option-box-toc-over"><img src="/images/system/toc.png" class="nozoom"> <span class="show-txt">目录</span> <div class="toc-container"><div class="pos-box"><div class="icon-arrow"></div> <div class="scroll-box" style="max-height:550px"><div style="font-weight:bold;text-align:center;">分布式数据仓库 Hive</div> <hr> <div class="toc-box"><ul class="toc-sidebar-links"><li><a href="/kr/bigdata/hive/%E5%88%86%E5%B8%83%E5%BC%8F%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93-Hive.html#hive-概述" class="toc-sidebar-link">Hive 概述</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/kr/bigdata/hive/%E5%88%86%E5%B8%83%E5%BC%8F%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93-Hive.html#hive-优缺点" class="toc-sidebar-link">Hive 优缺点</a></li><li class="toc-sidebar-sub-header"><a href="/kr/bigdata/hive/%E5%88%86%E5%B8%83%E5%BC%8F%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93-Hive.html#hive-体系架构" class="toc-sidebar-link">Hive 体系架构</a></li><li class="toc-sidebar-sub-header"><a href="/kr/bigdata/hive/%E5%88%86%E5%B8%83%E5%BC%8F%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93-Hive.html#hql-编译过程" class="toc-sidebar-link">HQL 编译过程</a></li><li class="toc-sidebar-sub-header"><a href="/kr/bigdata/hive/%E5%88%86%E5%B8%83%E5%BC%8F%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93-Hive.html#数据库-数据仓库" class="toc-sidebar-link">数据库/数据仓库</a></li></ul></li><li><a href="/kr/bigdata/hive/%E5%88%86%E5%B8%83%E5%BC%8F%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93-Hive.html#hive-部署" class="toc-sidebar-link">Hive 部署</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/kr/bigdata/hive/%E5%88%86%E5%B8%83%E5%BC%8F%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93-Hive.html#metastore" class="toc-sidebar-link">Metastore</a></li><li class="toc-sidebar-sub-header"><a href="/kr/bigdata/hive/%E5%88%86%E5%B8%83%E5%BC%8F%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93-Hive.html#hiveserver2" class="toc-sidebar-link">HiveServer2</a></li><li class="toc-sidebar-sub-header"><a href="/kr/bigdata/hive/%E5%88%86%E5%B8%83%E5%BC%8F%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93-Hive.html#配置文件" class="toc-sidebar-link">配置文件</a></li><li class="toc-sidebar-sub-header"><a href="/kr/bigdata/hive/%E5%88%86%E5%B8%83%E5%BC%8F%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93-Hive.html#hive-镜像" class="toc-sidebar-link">Hive 镜像</a></li><li class="toc-sidebar-sub-header"><a href="/kr/bigdata/hive/%E5%88%86%E5%B8%83%E5%BC%8F%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93-Hive.html#启动容器并初始化" class="toc-sidebar-link">启动容器并初始化</a></li></ul></li><li><a href="/kr/bigdata/hive/%E5%88%86%E5%B8%83%E5%BC%8F%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93-Hive.html#hive-实战" class="toc-sidebar-link">Hive 实战</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/kr/bigdata/hive/%E5%88%86%E5%B8%83%E5%BC%8F%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93-Hive.html#hive-数据类型" class="toc-sidebar-link">Hive 数据类型</a></li><li class="toc-sidebar-sub-header"><a href="/kr/bigdata/hive/%E5%88%86%E5%B8%83%E5%BC%8F%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93-Hive.html#ddl-数据定义" class="toc-sidebar-link">DDL 数据定义</a></li><li class="toc-sidebar-sub-header"><a href="/kr/bigdata/hive/%E5%88%86%E5%B8%83%E5%BC%8F%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93-Hive.html#dml-数据操作" class="toc-sidebar-link">DML 数据操作</a></li><li class="toc-sidebar-sub-header"><a href="/kr/bigdata/hive/%E5%88%86%E5%B8%83%E5%BC%8F%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93-Hive.html#hive-表类型" class="toc-sidebar-link">Hive 表类型</a></li><li class="toc-sidebar-sub-header"><a href="/kr/bigdata/hive/%E5%88%86%E5%B8%83%E5%BC%8F%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93-Hive.html#hive-视图" class="toc-sidebar-link">Hive 视图</a></li><li class="toc-sidebar-sub-header"><a href="/kr/bigdata/hive/%E5%88%86%E5%B8%83%E5%BC%8F%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93-Hive.html#动态分区" class="toc-sidebar-link">动态分区</a></li><li class="toc-sidebar-sub-header"><a href="/kr/bigdata/hive/%E5%88%86%E5%B8%83%E5%BC%8F%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93-Hive.html#hive-索引-3-0后被移除" class="toc-sidebar-link">Hive 索引(3.0后被移除)</a></li><li class="toc-sidebar-sub-header"><a href="/kr/bigdata/hive/%E5%88%86%E5%B8%83%E5%BC%8F%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93-Hive.html#数据抽样" class="toc-sidebar-link">数据抽样</a></li></ul></li></ul></div></div></div></div></div></div>  </aside></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.cfd60917.js" defer></script><script src="/assets/js/4.8234885e.js" defer></script><script src="/assets/js/3.1429892b.js" defer></script><script src="/assets/js/29.7e78aa5c.js" defer></script>
  </body>
</html>
