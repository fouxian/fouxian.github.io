<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Redis | Keep Running</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/favicon.png">
    <script charset="utf-8" async="async" src="/js/jquery.min.js"></script>
    <script charset="utf-8" async="async" src="/js/global.js"></script>
    <script charset="utf-8" async="async" src="/js/fingerprint2.min.js"></script>
    <meta name="description" content="">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <link rel="preload" href="/assets/css/0.styles.42b858ce.css" as="style"><link rel="preload" href="/assets/js/app.cfd60917.js" as="script"><link rel="preload" href="/assets/js/4.8234885e.js" as="script"><link rel="preload" href="/assets/js/3.1429892b.js" as="script"><link rel="preload" href="/assets/js/58.8174871d.js" as="script"><link rel="prefetch" href="/assets/js/10.0f0de338.js"><link rel="prefetch" href="/assets/js/11.0c47d372.js"><link rel="prefetch" href="/assets/js/12.b45ce082.js"><link rel="prefetch" href="/assets/js/13.f2032214.js"><link rel="prefetch" href="/assets/js/14.0a8927b2.js"><link rel="prefetch" href="/assets/js/15.9ab1d206.js"><link rel="prefetch" href="/assets/js/16.f03f2e40.js"><link rel="prefetch" href="/assets/js/17.c6bbe2be.js"><link rel="prefetch" href="/assets/js/18.e08bb862.js"><link rel="prefetch" href="/assets/js/19.c00af7cb.js"><link rel="prefetch" href="/assets/js/20.35396483.js"><link rel="prefetch" href="/assets/js/21.fe05d239.js"><link rel="prefetch" href="/assets/js/22.80eaa289.js"><link rel="prefetch" href="/assets/js/23.bce5e854.js"><link rel="prefetch" href="/assets/js/24.fa104861.js"><link rel="prefetch" href="/assets/js/25.2c725be9.js"><link rel="prefetch" href="/assets/js/26.fc7addb7.js"><link rel="prefetch" href="/assets/js/27.fc831a66.js"><link rel="prefetch" href="/assets/js/28.3784f580.js"><link rel="prefetch" href="/assets/js/29.7e78aa5c.js"><link rel="prefetch" href="/assets/js/30.b074fddd.js"><link rel="prefetch" href="/assets/js/31.059ebf27.js"><link rel="prefetch" href="/assets/js/32.12570018.js"><link rel="prefetch" href="/assets/js/33.d0dc971f.js"><link rel="prefetch" href="/assets/js/34.c9b46696.js"><link rel="prefetch" href="/assets/js/35.77a81c6a.js"><link rel="prefetch" href="/assets/js/36.6048e328.js"><link rel="prefetch" href="/assets/js/37.b9f285de.js"><link rel="prefetch" href="/assets/js/38.ac5a2abf.js"><link rel="prefetch" href="/assets/js/39.97ca52cb.js"><link rel="prefetch" href="/assets/js/40.1689d33f.js"><link rel="prefetch" href="/assets/js/41.4d2d8182.js"><link rel="prefetch" href="/assets/js/42.8647a8ff.js"><link rel="prefetch" href="/assets/js/43.f867a280.js"><link rel="prefetch" href="/assets/js/44.a51272ee.js"><link rel="prefetch" href="/assets/js/45.c31e6474.js"><link rel="prefetch" href="/assets/js/46.fe85ae54.js"><link rel="prefetch" href="/assets/js/47.dc8a97d4.js"><link rel="prefetch" href="/assets/js/48.c97f7726.js"><link rel="prefetch" href="/assets/js/49.ac219d14.js"><link rel="prefetch" href="/assets/js/5.963fada3.js"><link rel="prefetch" href="/assets/js/50.926ecfa5.js"><link rel="prefetch" href="/assets/js/51.e776b5b1.js"><link rel="prefetch" href="/assets/js/52.4938314c.js"><link rel="prefetch" href="/assets/js/53.6b4d7266.js"><link rel="prefetch" href="/assets/js/54.bfaf622b.js"><link rel="prefetch" href="/assets/js/55.c6d160b9.js"><link rel="prefetch" href="/assets/js/56.31f6843c.js"><link rel="prefetch" href="/assets/js/57.55cbf7b8.js"><link rel="prefetch" href="/assets/js/59.3eee2bde.js"><link rel="prefetch" href="/assets/js/6.b2e36a75.js"><link rel="prefetch" href="/assets/js/60.233a32ed.js"><link rel="prefetch" href="/assets/js/61.defb83ac.js"><link rel="prefetch" href="/assets/js/62.442070cd.js"><link rel="prefetch" href="/assets/js/63.cc121456.js"><link rel="prefetch" href="/assets/js/64.c8f83f5d.js"><link rel="prefetch" href="/assets/js/65.b9bc8c1c.js"><link rel="prefetch" href="/assets/js/7.fb6689bf.js"><link rel="prefetch" href="/assets/js/8.e390cc6b.js"><link rel="prefetch" href="/assets/js/9.c03c9dfe.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.db8a86c9.js">
    <link rel="stylesheet" href="/assets/css/0.styles.42b858ce.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Keep Running</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/kr/java/jvm/自动内存管理.html" class="nav-link">
  Java
</a></div><div class="nav-item"><a href="/kr/database/database.html" class="nav-link">
  数据库
</a></div><div class="nav-item"><a href="/kr/spring/MVC-IOC-AOP.html" class="nav-link">
  Spring
</a></div><div class="nav-item"><a href="/kr/middleware/redis/redis-base.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Redis/Zookeeper/Kafka
</a></div><div class="nav-item"><a href="/kr/bigdata/hadoop/Hadoop-分布式集群容器部署.html" class="nav-link">
  大数据
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/kr/java/jvm/自动内存管理.html" class="nav-link">
  Java
</a></div><div class="nav-item"><a href="/kr/database/database.html" class="nav-link">
  数据库
</a></div><div class="nav-item"><a href="/kr/spring/MVC-IOC-AOP.html" class="nav-link">
  Spring
</a></div><div class="nav-item"><a href="/kr/middleware/redis/redis-base.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Redis/Zookeeper/Kafka
</a></div><div class="nav-item"><a href="/kr/bigdata/hadoop/Hadoop-分布式集群容器部署.html" class="nav-link">
  大数据
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Redis</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/kr/middleware/redis/redis-base.html" aria-current="page" class="active sidebar-link">Redis</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Zookeeper</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/kr/middleware/zookeeper/Zookeeper-ZNode.html" class="sidebar-link">文件系统/通知机制/会话/ACL</a></li><li><a href="/kr/middleware/zookeeper/Zookeeper-Zab.html" class="sidebar-link">Zab 数据一致性及选举机制</a></li><li><a href="/kr/middleware/zookeeper/Zookeeper-lock.html" class="sidebar-link">基于 Zookeeper 的分布式锁</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Kafka</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/kr/middleware/kafka/Kafka-架构与日志存储.html" class="sidebar-link">Kafka 架构与日志存储</a></li><li><a href="/kr/middleware/kafka/Kafka-分区多副本可靠性剖析.html" class="sidebar-link">Kafka 分区多副本可靠性剖析</a></li><li><a href="/kr/middleware/kafka/消息可靠性和幂等性.html" class="sidebar-link">消息可靠性和幂等性</a></li><li><a href="/kr/middleware/kafka/Kafka-生产者.html" class="sidebar-link">Kafka 生产者</a></li><li><a href="/kr/middleware/kafka/Kafka-消费者.html" class="sidebar-link">Kafka 消费者</a></li><li><a href="/kr/middleware/kafka/Kafka-为什么快？.html" class="sidebar-link">Kafka 为什么快？</a></li><li><a href="/kr/middleware/kafka/Kafka-时间轮与延时操作.html" class="sidebar-link">Kafka 时间轮与延时操作</a></li></ul></section></li></ul> </aside> <div><main class="page"> <div class="theme-default-content content__default"><h1 id="redis"><a href="#redis" class="header-anchor">#</a> Redis</h1> <blockquote><p>Redis（REmote DIctionary Server）是一个使用 ANSI C 编写的、开源的、支持网络的、基于内存的、可选持久化的键值对存储系统</p></blockquote> <p><a href="https://try.redis.io/" target="_blank" rel="noopener noreferrer">在线 Redis 环境<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="单线程模型"><a href="#单线程模型" class="header-anchor">#</a> 单线程模型</h2> <p>Redis 基于 Reactor 模式设计的事件处理模型，是单线程运行（减少多线程上下文切换，降低资源消耗）的，通过 IO 多路复用监听多个客户端连接</p> <p><img src="/images/kr/redis/Redis-%E5%8D%95%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B.png" alt="Redis-单线程模型">
https://www.cnblogs.com/barrywxx/p/8570821.html</p> <h2 id="数据结构"><a href="#数据结构" class="header-anchor">#</a> 数据结构</h2> <ul><li>string：二进制安全，能包含任意类型的数据，使用简单动态字符串(SDS)作为表示，最多存储512M字节</li> <li>list：基于Linked Lists实现的双向链表，有序，可重复</li> <li>hash：字符串间的键值映射，无序的散列表；是一个 string 类型的 field 和 value 的映射表，特别适合用于存储对象</li> <li>set：无序的字符串集合，元素不重复，集合间操作</li> <li>zset：和 set 相比，sorted set 增加了一个权重参数 score，使得集合中的元素能够按 score 进行有序排列</li></ul> <h2 id="持久化"><a href="#持久化" class="header-anchor">#</a> 持久化</h2> <p><img src="/images/kr/redis/Redis-%E6%8C%81%E4%B9%85%E5%8C%96.png" alt="Redis-持久化"></p> <h2 id="高可用-哨兵-集群"><a href="#高可用-哨兵-集群" class="header-anchor">#</a> 高可用（哨兵/集群）</h2> <p><img src="/images/kr/redis/Redis-%E9%AB%98%E5%8F%AF%E7%94%A8.png" alt="Redis-高可用"></p> <h2 id="主从复制"><a href="#主从复制" class="header-anchor">#</a> 主从复制</h2> <p>主从(master-slave)复制：主服务器更新数据时同步数据副本到从服务器，Redis 支持<code>主从同步</code>和<code>从从同步</code>两种，目的：</p> <ul><li>数据冗余：实现数据的热备份，高可用性</li> <li>故障恢复：服务的冗余，避免单点故障</li> <li>负载均衡：通过主从复制，实现读写分离，提高集群的并发和吞吐量，分担服务器负载
::: info
高可用或高可靠性问题：从数据和服务两个角度思考，数据的持久化和副本机制，服务的单点故障和负载均衡
:::
配置(命令或配置文件)：</li> <li>在从服务器中配置 slaveof masterip masterport
<ul><li>终止与原有主服务器同步，向新主服务器同步</li> <li>取消复制(清除主从关系)：slaveof no one</li></ul></li> <li>启动从服务器时，指定主服务器 redis-server --slaveof masterip masterport</li></ul> <p><img src="/images/kr/redis/Redis-%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6.png" alt="Redis-主从复制"></p> <ul><li>全量复制：主从建立连接后，进行全量复制（快照同步），在复制期间，主库不阻塞，缓存新接收的写命令，在复制好后同步给从库</li> <li>命令传播：主从全量复制后，主从之间维持一个长连接，用于写命令的传播</li> <li>增量复制：当长连接断开并恢复后，需要将断开期间的写命令同步到从库（依靠维护复制偏移量）</li></ul> <h2 id="事务-非原子性"><a href="#事务-非原子性" class="header-anchor">#</a> 事务（非原子性）</h2> <p><img src="/images/kr/redis/Redis-%E4%BA%8B%E5%8A%A1.png" alt="Redis-事务"></p> <blockquote><p>Redis 事务不支持回滚，因而不满足原子性和持久性；Redis 事务简单理解就是批量执行 Redis 命令</p></blockquote> <h2 id="应用场景-缓存"><a href="#应用场景-缓存" class="header-anchor">#</a> 应用场景：缓存</h2> <p><img src="/images/kr/redis/Redis-%E7%BC%93%E5%AD%98.png" alt="Redis-缓存">
为什么要使用缓存？从高并发和高性能两个角度思考：</p> <ul><li>高性能：使用缓存在处理大量请求时，可以降低后端服务和数据库的负载，提高响应速度</li> <li>高并发：使用缓存可以提高系统整体的并发和吞吐量</li></ul> <h3 id="过期键设置和清理"><a href="#过期键设置和清理" class="header-anchor">#</a> 过期键设置和清理</h3> <blockquote><p>setex：设置 String 类型 key 过期时间；expire：设置其他类型 key 过期时间；persist：移除 key 过期时间</p></blockquote> <p>是否过期判断？
Redis 通过一个过期字典（Hash）来保存 key 过期时间。过期字典的键指向 Redis key，值是一个 long 类型整数，记录键所指向的 key 过期时间（毫秒精度的 UNIX 时间戳）</p> <p>过期键清理策略：</p> <ul><li>惰性删除：在查询 key 时进行过期检查，过期则删除，对 CPU 最友好，但可能会造成大量过期 key 没有删除</li> <li>定期删除：定期随机抽取一批 key 执行过期删除，Redis 会通过限制删除操作执行的时长和频率来减少删除操作对 CPU 的影响</li></ul> <blockquote><p>定期删除对内存应用更加友好，惰性删除对 CPU 使用更加友好，但两者都有可能存在大量过期键没有被删除的情况，这种情况需要使用内存淘汰机制</p></blockquote> <h3 id="内存淘汰机制"><a href="#内存淘汰机制" class="header-anchor">#</a> 内存淘汰机制</h3> <ul><li>volatile-lru：从已设置过期时间的数据集中淘汰最近最少使用的数据</li> <li>volatile-ttl：从已设置过期时间的数据集中淘汰将要过期的数据</li> <li>volatile-random：从已设置过期时间的数据集中任意选择数据淘汰</li> <li>volatitle-lru：当内存不足容纳新数据时，移除最近最少使用 key</li> <li>volatile-lfu：从已设置过期时间的数据集中淘汰最不经常使用的数据</li> <li>allkeys-random：从数据集中任意选择数据淘汰</li> <li>allkeys-lfu：当内存不足容纳新数据时，移除最不经常使用 key</li></ul> <h3 id="缓存穿透-缓存雪崩-缓存击穿"><a href="#缓存穿透-缓存雪崩-缓存击穿" class="header-anchor">#</a> 缓存穿透/缓存雪崩/缓存击穿</h3> <ul><li>缓存穿透：请求大量不存在的 key，直接绕过缓存去查询数据库，解决方法：
<ul><li>缓存无效 key，并设置过期时间，不建议</li> <li>布隆过滤器</li></ul></li> <li>缓存雪崩：在短时间内，由于热点缓存数据同时大面积失效，大量请求压倒数据库，解决方法：
<ul><li>限流</li> <li>针对热点缓存数据，随机设置缓存的失效时间，避免大面积同时失效</li></ul></li> <li>缓存击穿：某个 key 设置了过期时间，但在正好失效时，有大量请求进来了，导致请求转到数据库，解决方法：
<ul><li>大量并发时，只让一个请求可以获取到查询数据库的锁，其他请求需要等待，查到以后释放锁，其他请求获取到锁后，先查缓存，缓存中有数据，就不用查数据库</li></ul></li></ul> <blockquote><p>怎么处理缓存穿透、雪崩、击穿的问题呢？</p> <ul><li>对空结果进行缓存/或采用布隆过滤器，用来解决缓存穿透问题。</li> <li>设置过期时间，且加上随机值进行过期偏移，用来解决缓存雪崩问题。</li> <li>查询数据库加分布式锁，解决缓存击穿问题。另外需要注意，加锁对性能会带来影响。</li></ul></blockquote> <h3 id="双写一致性"><a href="#双写一致性" class="header-anchor">#</a> 双写一致性</h3> <p>参考：<a href="https://mp.weixin.qq.com/s?__biz=MzIyOTYxNDI5OA==&amp;mid=2247487312&amp;idx=1&amp;sn=fa19566f5729d6598155b5c676eee62d&amp;chksm=e8beb8e5dfc931f3e35655da9da0b61c79f2843101c130cf38996446975014f958a6481aacf1&amp;scene=178&amp;cur_album_id=1699766580538032128#rd" target="_blank" rel="noopener noreferrer">缓存和数据库双写一致性问题<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>当数据发生更新时，若数据库和缓存都更新，存在先后顺序问题：</p> <ul><li>先更新缓存，后更新数据库</li> <li>先更新数据库，后更新缓存</li></ul> <p>异常问题：上述两个方案，第一个操作成功，第二个操作异常，都会导致数据不一致</p> <p>并发问题：上述两个方案，两步都执行成功，若存在并发，则也会出现数据不一致</p> <p>缓存利用率角度看：不建议上述两种方案，每次更新数据库，都要更新缓存，造成缓存利用率低，性能浪费，而且缓存的数据可能不是数据库的直接数据，而是通过某种计算得来的</p> <p>采用删除缓存方案：</p> <ul><li>先删除缓存，后更新数据库</li> <li>先更新数据库，后删除缓存</li></ul> <p>异常问题：上述两种方案，第一个操作成功，第二个操作异常，都会导致数据不一致</p> <p>并发问题：上述两种方案，在读写并发时，存在数据不一致的问题，但第二种发生概率极低</p> <p>先更新数据库 + 再删除缓存方案，如何确保两步都执行成功（原子化），两种方案：？</p> <ul><li>采用异步重试方法，当删除缓存失败后，将重试请求写道消息队列，由专门的消费者进行重试，直到成功</li> <li>利用中间件 Canal 订阅数据库 binlog 二进制日志，再操作缓存</li></ul> <blockquote><p>综上，先更新数据库 + 再删除缓存的方案，是可以保证数据一致性的，并通过消息队列或 binlog 日志确保删除缓存操作成功的</p></blockquote> <p>删除缓存方案存在的数据不一致问题：</p> <ul><li>某线程读取到数据库或缓存中的旧值，并在删除缓存后重新写入缓存，导致缓存的值没有被更新，造成数据不一致</li> <li>在读写分离和主从库复制延迟的情况下，可能存在从从库中读取旧值并回写至缓存中，造成数据不一致</li> <li>解决策略：缓存延迟双删策略，两次删除缓存，但存在时间间隔，可生成一条延时消息，写入消息队列，实现延迟删除缓存</li></ul> <h2 id="应用场景-分布式锁"><a href="#应用场景-分布式锁" class="header-anchor">#</a> 应用场景：分布式锁</h2> <blockquote><p>分布式锁：一种分布式集群环境下的锁：查询 DB 时，只有某个服务的一个线程能访问，其他服务其他线程都需等待锁的释放后，才能继续执行</p></blockquote> <h3 id="setnx"><a href="#setnx" class="header-anchor">#</a> SETNX</h3> <p><code>SETNX</code>：<code>set If not exist</code>的简写，当 key 不存在时，设置 key 的值，存在时，不处理</p> <p>SETNX 分布式锁：多个线程并发执行 setnx 命令，若某个线程执行成功，则表示获取到锁，其他线程执行失败等待锁的释放，该线程执行业务后释放锁</p> <ul><li>存在的死锁问题：若该线程在执行业务过程中，由于业务异常或服务器宕机，无法释放锁，造成死锁，</li> <li>解决方法：可设置锁的自动过期时间，但是在<code>获取锁和设置锁的过期时间</code>这两步是分开执行的，两步之间若存在异常，则会造成锁设置过期时间失败</li> <li>解决方法：将<code>获取锁和设置锁的过期时间</code>两步当作一步原子性操作执行，使其具有原子性（set 命令）</li></ul> <p>给锁设置过期时间还是存在问题：当锁的过期时间小于任务的执行时间，在线程业务执行过程中，锁被自动释放了，其他线程即可获取锁并执行任务，造成冲突</p> <p>改进：给锁加上唯一编号，标记该锁被某条线程所持有：</p> <ul><li>设置锁的过期时间时，还需要设置唯一编号</li> <li>主动删除锁时，需判断锁的编号是否与持有的锁编号一致，若一致，则主动删除（这一步还是存在原子性问题）</li></ul> <h3 id="set"><a href="#set" class="header-anchor">#</a> SET</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 设置某个 key 的值并设置多少毫秒或秒过期 - 原子性操作</span>
<span class="token comment"># NX ：只在键不存在时，才对键进行设置操作。 SET key value NX 效果等同于 SETNX key value 。</span>
<span class="token comment"># XX ：只在键已经存在时，才对键进行设置操作</span>
<span class="token builtin class-name">set</span> key value<span class="token punctuation">[</span>expiration EX seconds<span class="token operator">|</span>PX milliseconds<span class="token punctuation">]</span> <span class="token punctuation">[</span>NX<span class="token operator">|</span>XX<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><code>获取锁和设置锁的过期时间</code>这两步是原子性操作，可以通过 set 命令或 lua 脚本来保证原子性</p> <blockquote><p><a href="https://mp.weixin.qq.com/s?__biz=MzAwMjI0ODk0NA==&amp;mid=2451954663&amp;idx=1&amp;sn=4bd071b6aaede114263f88c790b61371&amp;chksm=8d1c2278ba6bab6eca2ef44f21b2178cc719fffe124289b68128c0dad72429fe5f286854157a&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">Redis 分布式锁的五种方案：SETNX 命令<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <h3 id="redisson-方案"><a href="#redisson-方案" class="header-anchor">#</a> Redisson 方案</h3> <p>SETNX、SET 实现的分布式锁存在的问题：</p> <ul><li>锁的过期时间设置？多少合适？</li> <li>Redis 服务异常时，如何保证容错？</li></ul> <blockquote><p>Redisson 是一个在 Redis 的基础上实现的 Java 驻内存数据网格（In-Memory Data Grid），Redisson 在获得一个锁时，只设置一个很短的超时时间，同时起一个线程在每次快要到超时时间时去刷新锁的超时时间，在释放锁的同时结束这个线程，可以很好的解决锁的过期时间设置</p></blockquote> <p>参考：<a href="https://github.com/redisson/redisson/wiki/%E7%9B%AE%E5%BD%95" target="_blank" rel="noopener noreferrer">Redisson WIKI<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="https://mp.weixin.qq.com/s/CbnPRfvq4m1sqo2uKI6qQw" target="_blank" rel="noopener noreferrer">Redisson 方案<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="redlock-红锁方案"><a href="#redlock-红锁方案" class="header-anchor">#</a> RedLock 红锁方案</h3> <p>基于 Redis SETNX/SET 实现的分布式锁和 Redisson 分布式锁都存在一些缺陷：</p> <ul><li>客户端由于网络/GC等原因长时间阻塞导致锁过期失效而释放，其他客户端可以正常获取锁，从而多个客户端间的线程安全问题</li> <li>Redis 服务时间漂移，发生向前跳跃，导致锁过期提前释放，多个客户端同时持有同一把锁的情况</li> <li>Redis 单实例问题：在单机模式下，节点宕机；或在主从模式下，主节点宕机，而从节点未同步主节点的锁信息</li></ul> <p>参考：<a href="https://javakeeper.starfish.ink/data-management/Redis/Reids-Lock.html#%E5%9B%9B%E3%80%81redlock" target="_blank" rel="noopener noreferrer">Redis 分布式锁<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="应用场景-消息队列"><a href="#应用场景-消息队列" class="header-anchor">#</a> 应用场景：消息队列</h2> <p>参考：<a href="https://javakeeper.starfish.ink/data-management/Redis/Redis-MQ.html#%E4%B8%80%E3%80%81%E5%9B%9E%E9%A1%BE%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97" target="_blank" rel="noopener noreferrer">Redis 消息队列<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="应用场景-限流"><a href="#应用场景-限流" class="header-anchor">#</a> 应用场景：限流</h2></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">2022/6/8</span></div></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/kr/middleware/zookeeper/Zookeeper-ZNode.html">
          文件系统/通知机制/会话/ACL
        </a>
        →
      </span></p></div> </main></div> <aside class="page-sidebar"> <div class="page-side-toolbar"><div class="option-box-toc-fixed"><div class="toc-container-sidebar"><div class="pos-box"><div class="icon-arrow"></div> <div class="scroll-box" style="max-height:650px"><div style="font-weight:bold;text-align:center;">Redis</div> <hr> <div class="toc-box"><ul class="toc-sidebar-links"><li><a href="/kr/middleware/redis/redis-base.html#单线程模型" class="toc-sidebar-link">单线程模型</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/kr/middleware/redis/redis-base.html#数据结构" class="toc-sidebar-link">数据结构</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/kr/middleware/redis/redis-base.html#持久化" class="toc-sidebar-link">持久化</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/kr/middleware/redis/redis-base.html#高可用-哨兵-集群" class="toc-sidebar-link">高可用（哨兵/集群）</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/kr/middleware/redis/redis-base.html#主从复制" class="toc-sidebar-link">主从复制</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/kr/middleware/redis/redis-base.html#事务-非原子性" class="toc-sidebar-link">事务（非原子性）</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/kr/middleware/redis/redis-base.html#应用场景-缓存" class="toc-sidebar-link">应用场景：缓存</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/kr/middleware/redis/redis-base.html#过期键设置和清理" class="toc-sidebar-link">过期键设置和清理</a></li><li class="toc-sidebar-sub-header"><a href="/kr/middleware/redis/redis-base.html#内存淘汰机制" class="toc-sidebar-link">内存淘汰机制</a></li><li class="toc-sidebar-sub-header"><a href="/kr/middleware/redis/redis-base.html#缓存穿透-缓存雪崩-缓存击穿" class="toc-sidebar-link">缓存穿透/缓存雪崩/缓存击穿</a></li><li class="toc-sidebar-sub-header"><a href="/kr/middleware/redis/redis-base.html#双写一致性" class="toc-sidebar-link">双写一致性</a></li></ul></li><li><a href="/kr/middleware/redis/redis-base.html#应用场景-分布式锁" class="toc-sidebar-link">应用场景：分布式锁</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/kr/middleware/redis/redis-base.html#setnx" class="toc-sidebar-link">SETNX</a></li><li class="toc-sidebar-sub-header"><a href="/kr/middleware/redis/redis-base.html#set" class="toc-sidebar-link">SET</a></li><li class="toc-sidebar-sub-header"><a href="/kr/middleware/redis/redis-base.html#redisson-方案" class="toc-sidebar-link">Redisson 方案</a></li><li class="toc-sidebar-sub-header"><a href="/kr/middleware/redis/redis-base.html#redlock-红锁方案" class="toc-sidebar-link">RedLock 红锁方案</a></li></ul></li><li><a href="/kr/middleware/redis/redis-base.html#应用场景-消息队列" class="toc-sidebar-link">应用场景：消息队列</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/kr/middleware/redis/redis-base.html#应用场景-限流" class="toc-sidebar-link">应用场景：限流</a><ul class="toc-sidebar-sub-headers"></ul></li></ul></div></div></div></div></div> <div class="option-box-toc-over"><img src="/images/system/toc.png" class="nozoom"> <span class="show-txt">目录</span> <div class="toc-container"><div class="pos-box"><div class="icon-arrow"></div> <div class="scroll-box" style="max-height:550px"><div style="font-weight:bold;text-align:center;">Redis</div> <hr> <div class="toc-box"><ul class="toc-sidebar-links"><li><a href="/kr/middleware/redis/redis-base.html#单线程模型" class="toc-sidebar-link">单线程模型</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/kr/middleware/redis/redis-base.html#数据结构" class="toc-sidebar-link">数据结构</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/kr/middleware/redis/redis-base.html#持久化" class="toc-sidebar-link">持久化</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/kr/middleware/redis/redis-base.html#高可用-哨兵-集群" class="toc-sidebar-link">高可用（哨兵/集群）</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/kr/middleware/redis/redis-base.html#主从复制" class="toc-sidebar-link">主从复制</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/kr/middleware/redis/redis-base.html#事务-非原子性" class="toc-sidebar-link">事务（非原子性）</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/kr/middleware/redis/redis-base.html#应用场景-缓存" class="toc-sidebar-link">应用场景：缓存</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/kr/middleware/redis/redis-base.html#过期键设置和清理" class="toc-sidebar-link">过期键设置和清理</a></li><li class="toc-sidebar-sub-header"><a href="/kr/middleware/redis/redis-base.html#内存淘汰机制" class="toc-sidebar-link">内存淘汰机制</a></li><li class="toc-sidebar-sub-header"><a href="/kr/middleware/redis/redis-base.html#缓存穿透-缓存雪崩-缓存击穿" class="toc-sidebar-link">缓存穿透/缓存雪崩/缓存击穿</a></li><li class="toc-sidebar-sub-header"><a href="/kr/middleware/redis/redis-base.html#双写一致性" class="toc-sidebar-link">双写一致性</a></li></ul></li><li><a href="/kr/middleware/redis/redis-base.html#应用场景-分布式锁" class="toc-sidebar-link">应用场景：分布式锁</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/kr/middleware/redis/redis-base.html#setnx" class="toc-sidebar-link">SETNX</a></li><li class="toc-sidebar-sub-header"><a href="/kr/middleware/redis/redis-base.html#set" class="toc-sidebar-link">SET</a></li><li class="toc-sidebar-sub-header"><a href="/kr/middleware/redis/redis-base.html#redisson-方案" class="toc-sidebar-link">Redisson 方案</a></li><li class="toc-sidebar-sub-header"><a href="/kr/middleware/redis/redis-base.html#redlock-红锁方案" class="toc-sidebar-link">RedLock 红锁方案</a></li></ul></li><li><a href="/kr/middleware/redis/redis-base.html#应用场景-消息队列" class="toc-sidebar-link">应用场景：消息队列</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/kr/middleware/redis/redis-base.html#应用场景-限流" class="toc-sidebar-link">应用场景：限流</a><ul class="toc-sidebar-sub-headers"></ul></li></ul></div></div></div></div></div></div>  </aside></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.cfd60917.js" defer></script><script src="/assets/js/4.8234885e.js" defer></script><script src="/assets/js/3.1429892b.js" defer></script><script src="/assets/js/58.8174871d.js" defer></script>
  </body>
</html>
