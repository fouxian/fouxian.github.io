(window.webpackJsonp=window.webpackJsonp||[]).push([[51],{507:function(a,s,t){"use strict";t.r(s);var n=t(34),e=Object(n.a)({},(function(){var a=this,s=a.$createElement,t=a._self._c||s;return t("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[t("h1",{attrs:{id:"kafka-为什么快"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#kafka-为什么快"}},[a._v("#")]),a._v(" Kafka 为什么快？")]),a._v(" "),t("p",[a._v("Kafka 为什么快？高吞吐与低延迟？关键的点：追加顺序写、内存映射文件、零拷贝技术")]),a._v(" "),t("h2",{attrs:{id:"追加顺序写"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#追加顺序写"}},[a._v("#")]),a._v(" 追加顺序写")]),a._v(" "),t("p",[a._v("Kafak 日志存储中，消息是追加到分区文件的最后一个日志分段，属于追加顺序写，顺序 IO 比随机 IO 性能高（随机 ID 需要耗时寻址）")]),a._v(" "),t("h2",{attrs:{id:"内存映射文件-memory-mapped-files"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#内存映射文件-memory-mapped-files"}},[a._v("#")]),a._v(" 内存映射文件（Memory Mapped Files）")]),a._v(" "),t("p",[a._v("内存映射文件：工作原理是直接利用操作系统的 Page 来实现文件到物理内存的直接映射。完成映射之后对物理内存的操作会被再适当时同步到硬盘上")]),a._v(" "),t("p",[a._v("Kafka 通过将稀疏索引文件映射到内存中，并基于二分查找加快索引的查询速度，相比直接操作磁盘文件能够减少大量磁盘 IO")]),a._v(" "),t("h2",{attrs:{id:"零拷贝-zero-copy"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#零拷贝-zero-copy"}},[a._v("#")]),a._v(" 零拷贝（zero-copy）")]),a._v(" "),t("p",[a._v("Page cache 缓存文件的页以优化文件 IO；Buffer cache 缓存块设备的块以优化块设备 IO")]),a._v(" "),t("h3",{attrs:{id:"传统文件拷贝"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#传统文件拷贝"}},[a._v("#")]),a._v(" 传统文件拷贝")]),a._v(" "),t("p",[t("img",{attrs:{src:"/images/kr/kafka/%E6%96%87%E4%BB%B6%E6%8B%B7%E8%B4%9D.png",alt:"文件拷贝"}}),a._v("\n流程：磁盘文件 -> 内核空间页缓存 -> 用户空间应用缓存 -> 内核空间Socket缓存 -> 网卡缓存 -> 文件发送")]),a._v(" "),t("p",[a._v("改进：磁盘文件 -> 内核空间页缓存 -> 内核空间Socket缓存 -> 网卡缓存 -> 文件发送")]),a._v(" "),t("p",[a._v("以上流程需要多次经过数据复制和上下文切换")]),a._v(" "),t("h3",{attrs:{id:"直接内存存取-dma"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#直接内存存取-dma"}},[a._v("#")]),a._v(" 直接内存存取（DMA）")]),a._v(" "),t("p",[a._v("传统的内存访问，所有的请求都会发送到 CPU ，然后再由 CPU 来完成相关调度工作；而 DMA 能够使数据文件在各个层之间的传输直接绕过 CPU，使得外围设备可以通过 DMA 控制器直接访问内存。")]),a._v(" "),t("h3",{attrs:{id:"零拷贝技术"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#零拷贝技术"}},[a._v("#")]),a._v(" 零拷贝技术")]),a._v(" "),t("p",[t("img",{attrs:{src:"/images/kr/kafka/%E9%9B%B6%E6%8B%B7%E8%B4%9D%E6%8A%80%E6%9C%AF.png",alt:"零拷贝技术"}})]),a._v(" "),t("ul",[t("li",[a._v("producer 生产消息时，会使用 pwrite() 系统调用（FileChannel.write()）按偏移量写入数据，并且都会先写入 page cache 中，再随着内核中 flusher 线程的调度以及对 sync()/fsync() 的系统调用刷新到磁盘中")]),a._v(" "),t("li",[a._v("consumer 消费消息时，会使用 sendfile() 系统调用（FileChannel.transferTo()），零拷贝地将数据从 page cache 传输到 broker 的 Socket buffer，再通过网络传输；如果要消费的消息不在 page cache 里，才会去磁盘读取，并且会顺便预读出一些相邻的数据放入 page cache，以方便下一次读取")])]),a._v(" "),t("blockquote",[t("p",[a._v("处于 ISR 中的 follower 也能够通过零拷贝机制将数据从 leader 所在的 broker page cache 同步到 follower 所在的 broker")])]),a._v(" "),t("blockquote",[t("p",[a._v("如果 Kafka producer 的生产速率与 consumer 的消费速率相差不大，那么就能几乎只靠对 broker page cache 的读写完成整个生产-消费过程，磁盘访问非常少")])]),a._v(" "),t("p",[a._v("零拷贝将文件内容从磁盘通过DMA引擎复制到内核缓冲区，而且没有把数据复制到socket缓冲区，只是将数据位置和长度信息的描述符复制到了socket缓存区，然后直接将数据传输到网络接口，最后发送。这样大大减小了拷贝的次数，提高了效率。kafka正是调用linux系统给出的sendfile系统调用来使用零拷贝。")]),a._v(" "),t("p",[a._v("Java中的系统调用给出的是FileChannel.transferTo接口")]),a._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("public")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("class")]),a._v(" test"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n\t"),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("public")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("static")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("void")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("main")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("String")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v(" args"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("// Java 零拷贝实现")]),a._v("\n\t\t"),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("File")]),a._v(" file "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("new")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("File")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"Java零拷贝实现.zip"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n\t\t"),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("RandomAccessFile")]),a._v(" randomAccessFile "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("new")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("RandomAccessFile")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("file"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"rw"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n\t\t"),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("FileChannel")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("FileChannel")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" randomAccessFile"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("getChannel")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n\t\t"),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("SocketChannel")]),a._v(" sc "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("SocketChannel")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("open")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("new")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("InetSocketAdress")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('""')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("1234")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n\t\t"),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("FileChannel")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("transferTo")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("FileChannel")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("size")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" sc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\t\n\t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br"),t("span",{staticClass:"line-number"},[a._v("7")]),t("br"),t("span",{staticClass:"line-number"},[a._v("8")]),t("br"),t("span",{staticClass:"line-number"},[a._v("9")]),t("br"),t("span",{staticClass:"line-number"},[a._v("10")]),t("br")])])])}),[],!1,null,null,null);s.default=e.exports}}]);