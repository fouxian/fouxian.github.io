(window.webpackJsonp=window.webpackJsonp||[]).push([[13],{468:function(a,s,t){"use strict";t.r(s);var n=t(34),e=Object(n.a)({},(function(){var a=this,s=a.$createElement,t=a._self._c||s;return t("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[t("h1",{attrs:{id:"canal-mysql-binlog-增量订阅与消费组件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#canal-mysql-binlog-增量订阅与消费组件"}},[a._v("#")]),a._v(" Canal：MySQL Binlog 增量订阅与消费组件")]),a._v(" "),t("blockquote",[t("p",[t("a",{attrs:{href:"https://github.com/alibaba/canal",target:"_blank",rel:"noopener noreferrer"}},[a._v("阿里巴巴 MySQL binlog 增量订阅及消费组件：Canal"),t("OutboundLink")],1)])]),a._v(" "),t("p",[t("img",{attrs:{src:"/images/kr/bigdata/canal/Canal.png",alt:""}}),a._v("\nCanal：主要是基于 MySQL 数据库增量日志解析，提供增量数据订阅与消费，Canal 工作原理：")]),a._v(" "),t("ul",[t("li",[a._v("Canal 模拟 MySQL Slave 的交互协议，伪装自己为 MySQL Slave ，向 MySQL Master 发送 dump 协议")]),a._v(" "),t("li",[a._v("MySQL Master 收到 dump 请求，开始推送 binary log 给 Slave (即 Canal)")]),a._v(" "),t("li",[a._v("Canal 解析 binary log 对象(原始为 byte 流)")])]),a._v(" "),t("blockquote",[t("p",[a._v("基于日志增量订阅与消费的业务包括：数据库镜像、数据库实时备份、索引构建和实时维护(拆分异构索引、倒排索引等)、业务 cache 刷新、带业务逻辑的增量数据处理")])]),a._v(" "),t("h2",{attrs:{id:"mysql-binlog"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#mysql-binlog"}},[a._v("#")]),a._v(" MySQL Binlog")]),a._v(" "),t("p",[a._v("MySQL Binlog 二进制日志以事件形式记录了 DDL 和 DML 语句，是事务安全的；应用场景：")]),a._v(" "),t("ul",[t("li",[a._v("MySQL Replication 在 Master 端开启 Binlog，Master 把二进制日志传递给 Slaves 来达到 Master-Slave 数据一致性")]),a._v(" "),t("li",[a._v("通过使用 MySQL Binlog 工具来恢复数据")])]),a._v(" "),t("p",[a._v("两类文件：二进制日志索引文件用于记录所有二进制文件，二进制日志文件记录数据库所有的 DDL 和 DML 语句事件。")]),a._v(" "),t("p",[a._v("三种格式：")]),a._v(" "),t("ul",[t("li",[a._v("statement：语句级，binlig 会记录每次执行写操作的语句，相对 row 节省空间，但可能产生不一致性")]),a._v(" "),t("li",[a._v("row：行级，binlog 会记录每次操作后每行记录的变化，保持数据的绝对一致性，占用空间较大")]),a._v(" "),t("li",[a._v("mixed：一定程度上解决了 statement 的数据不一致问题，节省空间，但有些情况下还是存在不一致问题")])]),a._v(" "),t("p",[a._v("主从复制：\n"),t("img",{attrs:{src:"/images/kr/bigdata/canal/MySQL-%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6.jpg",alt:""}})]),a._v(" "),t("ul",[t("li",[a._v("Master 主库将改变记录，写到二进制日志文件中")]),a._v(" "),t("li",[a._v("Slave 从库向 Master 发送 dump 协议，将 Master binary log events 拷贝到它的中继日志（relay log）")]),a._v(" "),t("li",[a._v("Slave 从库读取并重做中继日志的事件，将改变的数据同步到自己的数据库")])]),a._v(" "),t("h2",{attrs:{id:"架构原理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#架构原理"}},[a._v("#")]),a._v(" 架构原理")]),a._v(" "),t("p",[t("img",{attrs:{src:"/images/kr/bigdata/canal/Canal-%E6%9E%B6%E6%9E%84.jpg",alt:""}})]),a._v(" "),t("ul",[t("li",[a._v("Server：代表一个 Canal 运行实例，对应于一个 Jvm")]),a._v(" "),t("li",[a._v("Instance：代表一个实际运行的数据队列\n"),t("ul",[t("li",[a._v("EventParser：数据源接入，模拟 Slave 协议和 Master 进行交互，协议解析")]),a._v(" "),t("li",[a._v("EventSink：Parser 和 Store 链接器，进行数据过滤、加工、分发的工作")]),a._v(" "),t("li",[a._v("EventStore：数据存储")]),a._v(" "),t("li",[a._v("MetaManager ：增量订阅与消费信息管理器")])])])]),a._v(" "),t("h3",{attrs:{id:"eventparser"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#eventparser"}},[a._v("#")]),a._v(" EventParser")]),a._v(" "),t("p",[t("img",{attrs:{src:"/images/kr/bigdata/canal/EventParser.jpg",alt:""}})]),a._v(" "),t("ol",[t("li",[a._v("Connection 获取上一次解析成功的位置(若第一次启动，则获取初始指定位置或当前数据库的 binlog 位点)")]),a._v(" "),t("li",[a._v("Connection 建立链接，发送 BINLOG_DUMP 指令")]),a._v(" "),t("li",[a._v("Mysql 开始推送 Binaly Log")]),a._v(" "),t("li",[a._v("通过 Binlog parser 对接收到的 Binaly Log 进行协议解析，补充一些特定信息")]),a._v(" "),t("li",[a._v("传递给 EventSink 进行数据存储，是一个阻塞操作，直到存储成功")]),a._v(" "),t("li",[a._v("存储成功后，定时记录 Binaly Log 位置")])]),a._v(" "),t("h3",{attrs:{id:"eventsink"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#eventsink"}},[a._v("#")]),a._v(" EventSink")]),a._v(" "),t("p",[t("img",{attrs:{src:"/images/kr/bigdata/canal/EventSink.jpg",alt:""}})]),a._v(" "),t("ul",[t("li",[a._v("数据过滤：支持通配符的过滤模式、表名、字段内容等")]),a._v(" "),t("li",[a._v("数据路由/分发：解决 1:n (1 个 Parser 对应多个 Store 的模式)")]),a._v(" "),t("li",[a._v("数据归并：解决 n:1 (多个 Parser 对应 1 个 Store)")]),a._v(" "),t("li",[a._v("数据加工：在进入 Store 之前进行额外的处理")])]),a._v(" "),t("blockquote",[t("p",[a._v("数据 1:n 业务：为了合理的利用数据库资源，一般常见业务都是按照 Schema 进行隔离，然后在 MySQL 上层或 dao 层上，进行一个数据源路由，屏蔽数据库物理位置对开发的影响，阿里系主要是通过 cobar/tddl 来解决数据源路由问题，所以，一般一个数据库实例上，会部署多个 Schema，每个 Schema 会有由1个或多个业务方关注")]),a._v(" "),t("p",[a._v("数据 n:1 业务：同样，当一个业务的数据规模达到一定的量级后，必然会涉及到水平拆分和垂直拆分的问题，针对这些拆分的数据需要处理时，就需要链接多个store进行处理，消费的位点就会变成多份，而且数据消费的进度无法得到尽可能有序的保证，所以，在一定业务场景下，需要将拆分后的增量数据进行归并处理，比如按照时间戳/全局 id 进行排序归并")])]),a._v(" "),t("h3",{attrs:{id:"eventstore"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#eventstore"}},[a._v("#")]),a._v(" EventStore")]),a._v(" "),t("p",[t("img",{attrs:{src:"/images/kr/bigdata/canal/EventStore.png",alt:""}})]),a._v(" "),t("ul",[t("li",[a._v("目前仅实现了 Memory 内存模式，后续可能增加本地 file 存储，mixed 混合模式")]),a._v(" "),t("li",[a._v("借鉴了 Disruptor 的 RingBuffer(环形结构) 实现思路")]),a._v(" "),t("li",[a._v("内存结构为环形队列，由三个指针(Put、Get、Ack)标识数据存储和读取的位置\n"),t("ul",[t("li",[a._v("Put：Sink 模块进行数据存储的最后一次写入位置")]),a._v(" "),t("li",[a._v("Get：数据订阅获取的最后一次提取位置")]),a._v(" "),t("li",[a._v("Ack：数据消费成功的最后一次消费位置")])])]),a._v(" "),t("li",[a._v("Put/Get/Ack 指针(cusor)用于递增，采用 long 型存储")]),a._v(" "),t("li",[a._v("Buffer 的 Get 操作，通过取余或与操作(与操作：cusor & (size - 1) , size 需要为 2 的指数，效率比较高)")])]),a._v(" "),t("h2",{attrs:{id:"ha-机制"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ha-机制"}},[a._v("#")]),a._v(" HA 机制")]),a._v(" "),t("ul",[t("li",[a._v("Canal Server HA：为了减少对 MySQL dump 的请求，不同 Server 上的 Instance 要求同一时间只能有一个处于 running，其他的处于 standby 状态")]),a._v(" "),t("li",[a._v("Canal Client HA：为了保证有序性，一份 Instance 同一时间只能由一个 Canal Client 进行 get/ack/rollback 操作，否则客户端接收无法保证有序")])]),a._v(" "),t("blockquote",[t("p",[a._v("整个 HA 机制主要是依赖 ZooKeeper Watcher 机制和临时节点特性，利用 ZooKeeper 抢占临时节点的方式进行控制")])]),a._v(" "),t("p",[t("img",{attrs:{src:"/images/kr/bigdata/canal/Canal-HA.jpg",alt:""}})]),a._v(" "),t("h2",{attrs:{id:"部署"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#部署"}},[a._v("#")]),a._v(" 部署")]),a._v(" "),t("div",{staticClass:"language-bash my.cnf line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# MySQL Binlog 配置")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("mysqld"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v("\nlog-bin"),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("mysql-bin \t"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 开启 binlog")]),a._v("\nbinlog-format"),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("ROW \t"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 选择 ROW 模式")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("server_id")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v(" \t  \t"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 配置 MySQL replaction 需要定义，不要和 canal 的 slaveId 重复")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br")])]),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("-- 创建 canal 账号并授权")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("CREATE")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("USER")]),a._v(" canal IDENTIFIED "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("BY")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("'canal'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("  \n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("GRANT")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("SELECT")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("REPLICATION")]),a._v(" SLAVE"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("REPLICATION")]),a._v(" CLIENT "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("ON")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("TO")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("'canal'")]),t("span",{pre:!0,attrs:{class:"token variable"}},[a._v("@'%'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("-- GRANT ALL PRIVILEGES ON *.* TO 'canal'@'%' ;")]),a._v("\nFLUSH "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("PRIVILEGES")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br")])]),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("wget")]),a._v(" https://github.com/alibaba/canal/releases/download/canal-1.1.2/canal.deployer-1.1.2.tar.gz\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("tar")]),a._v(" zxvf canal.deployer-1.1.2.tar.gz -C canal-1.1.2\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("root@dmcdw-3 local"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# tree canal-1.1.2/")]),a._v("\ncanal-1.1.2/\n├── bin "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 运维脚本")]),a._v("\n│   ├── restart.sh\n│   ├── startup.bat\n│   ├── startup.sh\n│   └── stop.sh\n├── conf "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 配置文件")]),a._v("\n│   ├── canal.properties\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# Canal 服务配置")]),a._v("\n│   ├── example\t\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 实例配置，一般指单个数据库实例配置，一个 Canal 服务实例，可以处理多个数据库实例 binlog 异步解析")]),a._v("\n│   │   └── instance.properties\n│   ├── logback.xml\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# logback 日志配置")]),a._v("\n│   ├── metrics\t\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 度量统计配置")]),a._v("\n│   │   └── Canal_instances_tmpl.json\n│   └── spring\n│       ├── base-instance.xml\n│       ├── default-instance.xml\n│       ├── file-instance.xml\n│       ├── group-instance.xml\n│       ├── memory-instance.xml\n│       └── tsdb\n│           ├── h2-tsdb.xml\n│           ├── mysql-tsdb.xml\n│           ├── sql\n│           │   └── create_table.sql\n│           └── sql-map\n│               ├── sqlmap-config.xml\n│               ├── sqlmap_history.xml\n│               └── sqlmap_snapshot.xml\n├── lib\n├── logs\t\t\t\t\t\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 日志文件输出")]),a._v("\n│   └── canal\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br"),t("span",{staticClass:"line-number"},[a._v("7")]),t("br"),t("span",{staticClass:"line-number"},[a._v("8")]),t("br"),t("span",{staticClass:"line-number"},[a._v("9")]),t("br"),t("span",{staticClass:"line-number"},[a._v("10")]),t("br"),t("span",{staticClass:"line-number"},[a._v("11")]),t("br"),t("span",{staticClass:"line-number"},[a._v("12")]),t("br"),t("span",{staticClass:"line-number"},[a._v("13")]),t("br"),t("span",{staticClass:"line-number"},[a._v("14")]),t("br"),t("span",{staticClass:"line-number"},[a._v("15")]),t("br"),t("span",{staticClass:"line-number"},[a._v("16")]),t("br"),t("span",{staticClass:"line-number"},[a._v("17")]),t("br"),t("span",{staticClass:"line-number"},[a._v("18")]),t("br"),t("span",{staticClass:"line-number"},[a._v("19")]),t("br"),t("span",{staticClass:"line-number"},[a._v("20")]),t("br"),t("span",{staticClass:"line-number"},[a._v("21")]),t("br"),t("span",{staticClass:"line-number"},[a._v("22")]),t("br"),t("span",{staticClass:"line-number"},[a._v("23")]),t("br"),t("span",{staticClass:"line-number"},[a._v("24")]),t("br"),t("span",{staticClass:"line-number"},[a._v("25")]),t("br"),t("span",{staticClass:"line-number"},[a._v("26")]),t("br"),t("span",{staticClass:"line-number"},[a._v("27")]),t("br"),t("span",{staticClass:"line-number"},[a._v("28")]),t("br"),t("span",{staticClass:"line-number"},[a._v("29")]),t("br"),t("span",{staticClass:"line-number"},[a._v("30")]),t("br"),t("span",{staticClass:"line-number"},[a._v("31")]),t("br"),t("span",{staticClass:"line-number"},[a._v("32")]),t("br"),t("span",{staticClass:"line-number"},[a._v("33")]),t("br"),t("span",{staticClass:"line-number"},[a._v("34")]),t("br")])]),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("root@dmcdw-3 canal-1.1.5"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# bin/startup.sh")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("root@dmcdw-3 canal-1.1.5"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# cat logs/canal/canal.log")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br")])]),t("h2",{attrs:{id:"tcp-模式"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#tcp-模式"}},[a._v("#")]),a._v(" TCP 模式")]),a._v(" "),t("p",[t("img",{attrs:{src:"/images/kr/bigdata/canal/Canal-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84.png",alt:""}})]),a._v(" "),t("div",{staticClass:"language-properties canal.properties line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-properties"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("canal.serverMode")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("tcp")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br")])]),t("div",{staticClass:"language-properties instance.properties line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-properties"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("canal.instance.mysql.slaveId")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("0\t# 与 Master 节点的服务 ID 不同，1.0.26 版本后自动生成")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("canal.instance.master.address")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("192.168.72.1:3306")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("canal.instance.dbUsername")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("canal")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("canal.instance.dbPassword")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("canal")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("canal.instance.connectionCharset")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("UTF-8")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("canal.instance.defaultDatabaseName")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("test")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# enable druid Decrypt database password")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("canal.instance.enableDruid")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("false")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br"),t("span",{staticClass:"line-number"},[a._v("7")]),t("br"),t("span",{staticClass:"line-number"},[a._v("8")]),t("br")])]),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("/**\n * TCP 模式实时监控拉取 Canal 中消息\n */")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("public")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("class")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("CanalClient")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("public")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("static")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("void")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("main")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("String")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v(" args"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("throws")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("InterruptedException")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("InvalidProtocolBufferException")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n        "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("CanalConnector")]),a._v(" canalConnector "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("CanalConnectors")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("newSingleConnector")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("\n                "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("new")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("InetSocketAddress")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"192.168.120.159"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("11111")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n                "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"example"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('""')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('""')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("while")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token boolean"}},[a._v("true")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n            canalConnector"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("connect")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n            canalConnector"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("subscribe")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"canalDb.*"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("// 订阅数据库")]),a._v("\n            "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("Message")]),a._v(" message "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" canalConnector"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("get")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("100")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n            "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("List")]),t("span",{pre:!0,attrs:{class:"token generics"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("<")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("CanalEntry"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("Entry")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v(" entries "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" message"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("getEntries")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n            "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("if")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("entries"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("size")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("// 判断集合是否为空,如果为空,则等待一会继续拉取数据")]),a._v("\n                "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("System")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("out"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("println")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"当次抓取没有数据，休息一会。。。。。。"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n                "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("Thread")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("sleep")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("1000")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n            "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("else")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n                "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("for")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("CanalEntry"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("Entry")]),a._v(" entry "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" entries"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n                    "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("String")]),a._v(" tableName "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" entry"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("getHeader")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("getTableName")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n                    "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("CanalEntry"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("EntryType")]),a._v(" entryType "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" entry"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("getEntryType")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n                    "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("ByteString")]),a._v(" storeValue "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" entry"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("getStoreValue")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("// 获取序列化后的数据")]),a._v("\n                    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("if")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("CanalEntry"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("EntryType")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("ROWDATA"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("equals")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("entryType"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n                        "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("CanalEntry"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("RowChange")]),a._v(" rowChange "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("CanalEntry"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("RowChange")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("parseFrom")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("storeValue"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("// 反序列化数据")]),a._v("\n                        "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("CanalEntry"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("EventType")]),a._v(" eventType "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" rowChange"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("getEventType")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n                        "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("List")]),t("span",{pre:!0,attrs:{class:"token generics"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("<")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("CanalEntry"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("RowData")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v(" rowDataList "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" rowChange"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("getRowDatasList")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n                        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("for")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("CanalEntry"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("RowData")]),a._v(" rowData "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" rowDataList"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n                            "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("JSONObject")]),a._v(" beforeData "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("new")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("JSONObject")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n                            "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("List")]),t("span",{pre:!0,attrs:{class:"token generics"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("<")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("CanalEntry"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("Column")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v(" beforeColumnsList "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" rowData"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("getBeforeColumnsList")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n                            "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("for")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("CanalEntry"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("Column")]),a._v(" column "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" beforeColumnsList"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n                                beforeData"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("put")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("column"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("getName")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" column"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("getValue")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n                            "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n                            "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("JSONObject")]),a._v(" afterData "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("new")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("JSONObject")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n                            "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("List")]),t("span",{pre:!0,attrs:{class:"token generics"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("<")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("CanalEntry"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("Column")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v(" afterColumnsList "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" rowData"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("getAfterColumnsList")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n                            "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("for")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("CanalEntry"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("Column")]),a._v(" column "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" afterColumnsList"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n                                afterData"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("put")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("column"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("getName")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" column"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("getValue")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n                            "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n                            "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("System")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("out"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("println")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"Table:"')]),a._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("+")]),a._v(" tableName "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("+")]),a._v("\n                                    "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('",EventType:"')]),a._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("+")]),a._v(" eventType "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("+")]),a._v("\n                                    "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('",Before:"')]),a._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("+")]),a._v(" beforeData "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("+")]),a._v("\n                                    "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('",After:"')]),a._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("+")]),a._v(" afterData"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n                        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n                    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("else")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n                        "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("System")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("out"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("println")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"当前操作类型为："')]),a._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("+")]),a._v(" entryType"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n                    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n                "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n            "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br"),t("span",{staticClass:"line-number"},[a._v("7")]),t("br"),t("span",{staticClass:"line-number"},[a._v("8")]),t("br"),t("span",{staticClass:"line-number"},[a._v("9")]),t("br"),t("span",{staticClass:"line-number"},[a._v("10")]),t("br"),t("span",{staticClass:"line-number"},[a._v("11")]),t("br"),t("span",{staticClass:"line-number"},[a._v("12")]),t("br"),t("span",{staticClass:"line-number"},[a._v("13")]),t("br"),t("span",{staticClass:"line-number"},[a._v("14")]),t("br"),t("span",{staticClass:"line-number"},[a._v("15")]),t("br"),t("span",{staticClass:"line-number"},[a._v("16")]),t("br"),t("span",{staticClass:"line-number"},[a._v("17")]),t("br"),t("span",{staticClass:"line-number"},[a._v("18")]),t("br"),t("span",{staticClass:"line-number"},[a._v("19")]),t("br"),t("span",{staticClass:"line-number"},[a._v("20")]),t("br"),t("span",{staticClass:"line-number"},[a._v("21")]),t("br"),t("span",{staticClass:"line-number"},[a._v("22")]),t("br"),t("span",{staticClass:"line-number"},[a._v("23")]),t("br"),t("span",{staticClass:"line-number"},[a._v("24")]),t("br"),t("span",{staticClass:"line-number"},[a._v("25")]),t("br"),t("span",{staticClass:"line-number"},[a._v("26")]),t("br"),t("span",{staticClass:"line-number"},[a._v("27")]),t("br"),t("span",{staticClass:"line-number"},[a._v("28")]),t("br"),t("span",{staticClass:"line-number"},[a._v("29")]),t("br"),t("span",{staticClass:"line-number"},[a._v("30")]),t("br"),t("span",{staticClass:"line-number"},[a._v("31")]),t("br"),t("span",{staticClass:"line-number"},[a._v("32")]),t("br"),t("span",{staticClass:"line-number"},[a._v("33")]),t("br"),t("span",{staticClass:"line-number"},[a._v("34")]),t("br"),t("span",{staticClass:"line-number"},[a._v("35")]),t("br"),t("span",{staticClass:"line-number"},[a._v("36")]),t("br"),t("span",{staticClass:"line-number"},[a._v("37")]),t("br"),t("span",{staticClass:"line-number"},[a._v("38")]),t("br"),t("span",{staticClass:"line-number"},[a._v("39")]),t("br"),t("span",{staticClass:"line-number"},[a._v("40")]),t("br"),t("span",{staticClass:"line-number"},[a._v("41")]),t("br"),t("span",{staticClass:"line-number"},[a._v("42")]),t("br"),t("span",{staticClass:"line-number"},[a._v("43")]),t("br"),t("span",{staticClass:"line-number"},[a._v("44")]),t("br"),t("span",{staticClass:"line-number"},[a._v("45")]),t("br"),t("span",{staticClass:"line-number"},[a._v("46")]),t("br"),t("span",{staticClass:"line-number"},[a._v("47")]),t("br"),t("span",{staticClass:"line-number"},[a._v("48")]),t("br"),t("span",{staticClass:"line-number"},[a._v("49")]),t("br"),t("span",{staticClass:"line-number"},[a._v("50")]),t("br")])]),t("h2",{attrs:{id:"kafka-模式"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#kafka-模式"}},[a._v("#")]),a._v(" Kafka 模式")]),a._v(" "),t("div",{staticClass:"language-properties canal.properties line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-properties"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("canal.serverMode")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("kafka")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("kafka.bootstrap.servers")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("192.168.72.1:9092")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br")])]),t("div",{staticClass:"language-properties instance.properties line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-properties"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("canal.instance.mysql.slaveId")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("0\t# 与 Master 节点的服务 ID 不同，1.0.26 版本后自动生成")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("canal.instance.master.address")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("192.168.72.1:3306")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("canal.instance.dbUsername")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("canal")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("canal.instance.dbPassword")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("canal")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("canal.instance.connectionCharset")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("UTF-8")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("canal.instance.defaultDatabaseName")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("test")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# enable druid Decrypt database password")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("canal.instance.enableDruid")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("false")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 消息队列 Kafka 主题分区")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("canal.mq.topic")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("example")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("canal.mq.partition")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("0")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# hash partition config 多个分区，就配置 hash 映射；多个分区并行可能会打乱 binlog 顺序")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#canal.mq.partitionsNum=3")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#canal.mq.partitionHash=mytest.person:id,mytest.role:id")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br"),t("span",{staticClass:"line-number"},[a._v("7")]),t("br"),t("span",{staticClass:"line-number"},[a._v("8")]),t("br"),t("span",{staticClass:"line-number"},[a._v("9")]),t("br"),t("span",{staticClass:"line-number"},[a._v("10")]),t("br"),t("span",{staticClass:"line-number"},[a._v("11")]),t("br"),t("span",{staticClass:"line-number"},[a._v("12")]),t("br"),t("span",{staticClass:"line-number"},[a._v("13")]),t("br"),t("span",{staticClass:"line-number"},[a._v("14")]),t("br")])]),t("h2",{attrs:{id:"mq-顺序性问题"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#mq-顺序性问题"}},[a._v("#")]),a._v(" MQ 顺序性问题")]),a._v(" "),t("p",[a._v("binlog 本身是有序的，写入到 MQ 后如何保障顺序性？\nCanal 目前支持的 Kafka/RocketMQ，本质上都是基于本地文件的方式来支持了分区级顺序消息的能力，也就是 binlog 写入 MQ 是可以有一些顺序性保障，这取决于用参数配置\nCanal 支持 MQ 数据的路由方式：单主题单分区、单主题多分区、多主题单分区、多主题多分区\ncanal.mq.dynamicTopic：主要控制是否是单主题还是多主题，针对命中条件的表可以发到表名对应的主题、库名对应的主题、默认主题\ncanal.mq.partitionsNum、canal.mq.partitionHash：主要控制是否多分区以及分区的路由计算，针对命中条件的可以做到按表级做分区、pk级做分区等\nCanal 的消费顺序性：")]),a._v(" "),t("ul",[t("li",[a._v("单主题单分区：可以严格保证和 binlog 一样的顺序性，缺点就是写入分区性能比较慢")]),a._v(" "),t("li",[a._v("多主题单分区：可以保证表级别的顺序性，一张表或一个库的所有数据都写入到一个主题的单分区中，可以保证有序性，针对热点表也存在写入分区的性能问题")]),a._v(" "),t("li",[a._v("单主题、多主题的多分区：若指定表方式，保障的是表级别的顺序性(存在热点表写入分区的性能问题)，若指定 pk hash 方式，那只能保障的是一个 pk 的多次 binlog 顺序性")])])])}),[],!1,null,null,null);s.default=e.exports}}]);